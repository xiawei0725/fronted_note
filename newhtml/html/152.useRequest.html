<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>夜空中最亮的星</title>
    <link rel="stylesheet" type="text/css" href="./assets/css/main.css">
    <link rel="stylesheet" href="./assets/css/bootstrapmin_1645176572503.css" >
    <style>
        .page-toc > ul .red {
            background: #f3f3f3;
            z-index: 1;
            border-left: 3px solid #009a61;
            -webkit-transition: all .2s ease;
            transition: all .2s ease;
            color: #000
        }
    </style>
</head>
<body>
<div class="nav">
    <div class="logo">前端文档</div>
                        <ul id="mynavlist"><li><a href="./index.html">0.api</a></li><li><a href="../html/0.Async.html">0.Async</a></li><li><a href="../html/0.module.html">0.module</a></li><li><a href="../html/1.ES2015.html">1.ES2015</a></li><li><a href="../html/2.Promise.html">2.Promise</a></li><li><a href="../html/3.Node.html">3.Node</a></li><li><a href="../html/4.NodeInstall.html">4.NodeInstall</a></li><li><a href="../html/5.REPL.html">5.REPL</a></li><li><a href="../html/6.NodeCore.html">6.NodeCore</a></li><li><a href="../html/7.module&NPM.html">7.module&NPM</a></li><li><a href="../html/8.Encoding.html">8.Encoding</a></li><li><a href="../html/9.Buffer.html">9.Buffer</a></li><li><a href="../html/10.fs.html">10.fs</a></li><li><a href="../html/11.Stream-1.html">11.Stream-1</a></li><li><a href="../html/11.Stream-2.html">11.Stream-2</a></li><li><a href="../html/11.Stream-3.html">11.Stream-3</a></li><li><a href="../html/11.Stream-4.html">11.Stream-4</a></li><li><a href="../html/12-Network-2.html">12-Network-2</a></li><li><a href="../html/12.NetWork-3.html">12.NetWork-3</a></li><li><a href="../html/12.Network-1.html">12.Network-1</a></li><li><a href="../html/13.tcp.html">13.tcp</a></li><li><a href="../html/14.http-1.html">14.http-1</a></li><li><a href="../html/14.http-2.html">14.http-2</a></li><li><a href="../html/15.compress.html">15.compress</a></li><li><a href="../html/16.crypto.html">16.crypto</a></li><li><a href="../html/17.process.html">17.process</a></li><li><a href="../html/18.yargs.html">18.yargs</a></li><li><a href="../html/19.cache.html">19.cache</a></li><li><a href="../html/20.action.html">20.action</a></li><li><a href="../html/21.https.html">21.https</a></li><li><a href="../html/22.cookie.html">22.cookie</a></li><li><a href="../html/23.session.html">23.session</a></li><li><a href="../html/24.express-1.html">24.express-1</a></li><li><a href="../html/24.express-2.html">24.express-2</a></li><li><a href="../html/24.express-3.html">24.express-3</a></li><li><a href="../html/24.express-4.html">24.express-4</a></li><li><a href="../html/25.koa-1.html">25.koa-1</a></li><li><a href="../html/26.webpack-1-basic.html">26.webpack-1-basic</a></li><li><a href="../html/26.webpack-2-optimize.html">26.webpack-2-optimize</a></li><li><a href="../html/26.webpack-3-file.html">26.webpack-3-file</a></li><li><a href="../html/26.webpack-4.tapable.html">26.webpack-4.tapable</a></li><li><a href="../html/26.webpack-5-AST.html">26.webpack-5-AST</a></li><li><a href="../html/26.webpack-6-sources.html">26.webpack-6-sources</a></li><li><a href="../html/26.webpack-7-loader.html">26.webpack-7-loader</a></li><li><a href="../html/26.webpack-8-plugin.html">26.webpack-8-plugin</a></li><li><a href="../html/26.webpack-9-hand.html">26.webpack-9-hand</a></li><li><a href="../html/26.webpack-10-prepare.html">26.webpack-10-prepare</a></li><li><a href="../html/28.redux.html">28.redux</a></li><li><a href="../html/28.redux-jwt-back.html">28.redux-jwt-back</a></li><li><a href="../html/28.redux-jwt-front.html">28.redux-jwt-front</a></li><li><a href="../html/29.mongodb-1.html">29.mongodb-1</a></li><li><a href="../html/29.mongodb-2.html">29.mongodb-2</a></li><li><a href="../html/29.mongodb-3.html">29.mongodb-3</a></li><li><a href="../html/29.mongodb-4.html">29.mongodb-4</a></li><li><a href="../html/29.mongodb-5.html">29.mongodb-5</a></li><li><a href="../html/29.mongodb-6.html">29.mongodb-6</a></li><li><a href="../html/30.cms-1-mysql.html">30.cms-1-mysql</a></li><li><a href="../html/30.cms-2-mysql.html">30.cms-2-mysql</a></li><li><a href="../html/30.cms-3-mysql.html">30.cms-3-mysql</a></li><li><a href="../html/30.cms-4-nunjucks.html">30.cms-4-nunjucks</a></li><li><a href="../html/30.cms-5-mock.html">30.cms-5-mock</a></li><li><a href="../html/30.cms-6-egg.html">30.cms-6-egg</a></li><li><a href="../html/30.cms-7-api.html">30.cms-7-api</a></li><li><a href="../html/30.cms-8-roadhog.html">30.cms-8-roadhog</a></li><li><a href="../html/30.cms-9-yaml.html">30.cms-9-yaml</a></li><li><a href="../html/30.cms-10-umi.html">30.cms-10-umi</a></li><li><a href="../html/30.cms-12-dva.html">30.cms-12-dva</a></li><li><a href="../html/30.cms-13-dva-ant.html">30.cms-13-dva-ant</a></li><li><a href="../html/30.cms-14-front.html">30.cms-14-front</a></li><li><a href="../html/30.cms-15-deploy.html">30.cms-15-deploy</a></li><li><a href="../html/31.dva.html">31.dva</a></li><li><a href="../html/31.cms-13-dva-antdesign.html">31.cms-13-dva-antdesign</a></li><li><a href="../html/33.redis.html">33.redis</a></li><li><a href="../html/34.unittest.html">34.unittest</a></li><li><a href="../html/35.jwt.html">35.jwt</a></li><li><a href="../html/36.websocket-1.html">36.websocket-1</a></li><li><a href="../html/36.websocket-2.html">36.websocket-2</a></li><li><a href="../html/38.chat-api-1.html">38.chat-api-1</a></li><li><a href="../html/38.chat-api-2.html">38.chat-api-2</a></li><li><a href="../html/38.chat-3.html">38.chat-3</a></li><li><a href="../html/38.chat-api-3.html">38.chat-api-3</a></li><li><a href="../html/38.chat.html">38.chat</a></li><li><a href="../html/38.chat2.html">38.chat2</a></li><li><a href="../html/38.chat2.html">38.chat2</a></li><li><a href="../html/39.crawl-0.html">39.crawl-0</a></li><li><a href="../html/39.crawl-1.html">39.crawl-1</a></li><li><a href="../html/39.crawl-2.html">39.crawl-2</a></li><li><a href="../html/40.deploy.html">40.deploy</a></li><li><a href="../html/41.safe.html">41.safe</a></li><li><a href="../html/42.test.html">42.test</a></li><li><a href="../html/43.nginx.html">43.nginx</a></li><li><a href="../html/44.enzyme.html">44.enzyme</a></li><li><a href="../html/45.docker.html">45.docker</a></li><li><a href="../html/46.elastic.html">46.elastic</a></li><li><a href="../html/47.oauth.html">47.oauth</a></li><li><a href="../html/48.wxpay.html">48.wxpay</a></li><li><a href="../html/index.html">index</a></li><li><a href="../html/52.UML.html">52.UML</a></li><li><a href="../html/53.design.html">53.design</a></li><li><a href="../html/index.html">index</a></li><li><a href="../html/54.linux.html">54.linux</a></li><li><a href="../html/57.ts.html">57.ts</a></li><li><a href="../html/56.react-ssr.html">56.react-ssr</a></li><li><a href="../html/58.ts_react.html">58.ts_react</a></li><li><a href="../html/59.ketang.html">59.ketang</a></li><li><a href="../html/59.ketang2.html">59.ketang2</a></li><li><a href="../html/61.1.devops-linux.html">61.1.devops-linux</a></li><li><a href="../html/61.2.devops-vi.html">61.2.devops-vi</a></li><li><a href="../html/61.3.devops-user.html">61.3.devops-user</a></li><li><a href="../html/61.4.devops-auth.html">61.4.devops-auth</a></li><li><a href="../html/61.5.devops-shell.html">61.5.devops-shell</a></li><li><a href="../html/61.6.devops-install.html">61.6.devops-install</a></li><li><a href="../html/61.7.devops-system.html">61.7.devops-system</a></li><li><a href="../html/61.8.devops-service.html">61.8.devops-service</a></li><li><a href="../html/61.9.devops-network.html">61.9.devops-network</a></li><li><a href="../html/61.10.devops-nginx.html">61.10.devops-nginx</a></li><li><a href="../html/61.11.devops-docker.html">61.11.devops-docker</a></li><li><a href="../html/61.12.devops-jekins.html">61.12.devops-jekins</a></li><li><a href="../html/61.13.devops-groovy.html">61.13.devops-groovy</a></li><li><a href="../html/61.14.devops-php.html">61.14.devops-php</a></li><li><a href="../html/61.15.devops-java.html">61.15.devops-java</a></li><li><a href="../html/61.16.devops-node.html">61.16.devops-node</a></li><li><a href="../html/61.17.devops-k8s.html">61.17.devops-k8s</a></li><li><a href="../html/62.1.react-basic.html">62.1.react-basic</a></li><li><a href="../html/62.2.react-state.html">62.2.react-state</a></li><li><a href="../html/62.3.react-high.html">62.3.react-high</a></li><li><a href="../html/62.4.react-optimize.html">62.4.react-optimize</a></li><li><a href="../html/62.5.react-hooks.html">62.5.react-hooks</a></li><li><a href="../html/62.6.react-immutable.html">62.6.react-immutable</a></li><li><a href="../html/62.7.react-mobx.html">62.7.react-mobx</a></li><li><a href="../html/62.8.react-source.html">62.8.react-source</a></li><li><a href="../html/63.1.redux.html">63.1.redux</a></li><li><a href="../html/63.2.redux-middleware.html">63.2.redux-middleware</a></li><li><a href="../html/63.3.redux-hooks.html">63.3.redux-hooks</a></li><li><a href="../html/63.4.redux-saga.html">63.4.redux-saga</a></li><li><a href="../html/63.5.redux-saga-hand.html">63.5.redux-saga-hand</a></li><li><a href="../html/64.1.router.html">64.1.router</a></li><li><a href="../html/64.2.router-connected.html">64.2.router-connected</a></li><li><a href="../html/65.1.typescript.html">65.1.typescript</a></li><li><a href="../html/65.2.typescript.html">65.2.typescript</a></li><li><a href="../html/65.3.typescript.html">65.3.typescript</a></li><li><a href="../html/65.4.antd.html">65.4.antd</a></li><li><a href="../html/65.4.definition.html">65.4.definition</a></li><li><a href="../html/66-1.vue-base.html">66-1.vue-base</a></li><li><a href="../html/66-2.vue-component.html">66-2.vue-component</a></li><li><a href="../html/66-3.vue-cli3.0.html">66-3.vue-cli3.0</a></li><li><a href="../html/66-4.$message组件.html">66-4.$message组件</a></li><li><a href="../html/66-5.Form组件.html">66-5.Form组件</a></li><li><a href="../html/66-6.tree.html">66-6.tree</a></li><li><a href="../html/66-7.vue-router-apply.html">66-7.vue-router-apply</a></li><li><a href="../html/66-8.axios-apply.html">66-8.axios-apply</a></li><li><a href="../html/66-9.vuex-apply.html">66-9.vuex-apply</a></li><li><a href="../html/66-10.jwt-vue.html">66-10.jwt-vue</a></li><li><a href="../html/66-11.vue-ssr.html">66-11.vue-ssr</a></li><li><a href="../html/66-12.nuxt-apply.html">66-12.nuxt-apply</a></li><li><a href="../html/66-13.pwa.html">66-13.pwa</a></li><li><a href="../html/66-14.vue单元测试.html">66-14.vue单元测试</a></li><li><a href="../html/66-15.权限校验.html">66-15.权限校验</a></li><li><a href="../html/67-1-network.html">67-1-network</a></li><li><a href="../html/68-2-wireshark.html">68-2-wireshark</a></li><li><a href="../html/7.npm2.html">7.npm2</a></li><li><a href="../html/69-hooks.html">69-hooks</a></li><li><a href="../html/70-deploy.html">70-deploy</a></li><li><a href="../html/71-hmr.html">71-hmr</a></li><li><a href="../html/72.deploy.html">72.deploy</a></li><li><a href="../html/73.import.html">73.import</a></li><li><a href="../html/74.mobile.html">74.mobile</a></li><li><a href="../html/75.webpack-1.文件分析.html">75.webpack-1.文件分析</a></li><li><a href="../html/75.webpack-2.loader.html">75.webpack-2.loader</a></li><li><a href="../html/75.webpack-3.源码流程.html">75.webpack-3.源码流程</a></li><li><a href="../html/75.webpack-4.tapable.html">75.webpack-4.tapable</a></li><li><a href="../html/75.webpack-5.prepare.html">75.webpack-5.prepare</a></li><li><a href="../html/75.webpack-6.resolve.html">75.webpack-6.resolve</a></li><li><a href="../html/75.webpack-7.loader.html">75.webpack-7.loader</a></li><li><a href="../html/75.webpack-8.module.html">75.webpack-8.module</a></li><li><a href="../html/75.webpack-9.chunk.html">75.webpack-9.chunk</a></li><li><a href="../html/75.webpack-10.asset.html">75.webpack-10.asset</a></li><li><a href="../html/75.webpack-11.实现.html">75.webpack-11.实现</a></li><li><a href="../html/76.react_optimize.html">76.react_optimize</a></li><li><a href="../html/77.ts_ketang_back.html">77.ts_ketang_back</a></li><li><a href="../html/77.ts_ketang_front.html">77.ts_ketang_front</a></li><li><a href="../html/78.vue-domdiff.html">78.vue-domdiff</a></li><li><a href="../html/79.grammar.html">79.grammar</a></li><li><a href="../html/80.tree.html">80.tree</a></li><li><a href="../html/81.axios.html">81.axios</a></li><li><a href="../html/82.1.react.html">82.1.react</a></li><li><a href="../html/82.2.react-high.html">82.2.react-high</a></li><li><a href="../html/82.3.react-router.html">82.3.react-router</a></li><li><a href="../html/82.4.redux.html">82.4.redux</a></li><li><a href="../html/82.5.redux_middleware.html">82.5.redux_middleware</a></li><li><a href="../html/82.6.connected.html">82.6.connected</a></li><li><a href="../html/82.7.saga.html">82.7.saga</a></li><li><a href="../html/82.8.dva.html">82.8.dva</a></li><li><a href="../html/82.8.dva-source.html">82.8.dva-source</a></li><li><a href="../html/82.9.roadhog.html">82.9.roadhog</a></li><li><a href="../html/82.10.umi.html">82.10.umi</a></li><li><a href="../html/82.11.antdesign.html">82.11.antdesign</a></li><li><a href="../html/82.12.ketang-front.html">82.12.ketang-front</a></li><li><a href="../html/82.12.ketang-back.html">82.12.ketang-back</a></li><li><a href="../html/83.upload.html">83.upload</a></li><li><a href="../html/84.graphql.html">84.graphql</a></li><li><a href="../html/85.antpro.html">85.antpro</a></li><li><a href="../html/86.1.uml.html">86.1.uml</a></li><li><a href="../html/86.2.design.html">86.2.design</a></li><li><a href="../html/87.postcss.html">87.postcss</a></li><li><a href="../html/88.react16-1.html">88.react16-1</a></li><li><a href="../html/89.nextjs.html">89.nextjs</a></li><li><a href="../html/90.react-test.html">90.react-test</a></li><li><a href="../html/91.react-ts.html">91.react-ts</a></li><li><a href="../html/92.rbac.html">92.rbac</a></li><li><a href="../html/93.tsnode.html">93.tsnode</a></li><li><a href="../html/94.1.JavaScript.html">94.1.JavaScript</a></li><li><a href="../html/94.2.JavaScript.html">94.2.JavaScript</a></li><li><a href="../html/94.3.MODULE.html">94.3.MODULE</a></li><li><a href="../html/94.4.EventLoop.html">94.4.EventLoop</a></li><li><a href="../html/94.5.文件上传.html">94.5.文件上传</a></li><li><a href="../html/94.6.https.html">94.6.https</a></li><li><a href="../html/94.7. nginx.html">94.7. nginx</a></li><li><a href="../html/95.1. react.html">95.1. react</a></li><li><a href="../html/95.2.react.html">95.2.react</a></li><li><a href="../html/96.1.react16.html">96.1.react16</a></li><li><a href="../html/96.2.fiber.html">96.2.fiber</a></li><li><a href="../html/96.3.fiber.html">96.3.fiber</a></li><li><a href="../html/97.serverless.html">97.serverless</a></li><li><a href="../html/98.websocket.html">98.websocket</a></li><li><a href="../html/100.1.react-basic.html">100.1.react-basic</a></li><li><a href="../html/101.1.monitor.html">101.1.monitor</a></li><li><a href="../html/101.2.monitor.html">101.2.monitor</a></li><li><a href="../html/102.java.html">102.java</a></li><li><a href="../html/103.1.webpack-usage.html">103.1.webpack-usage</a></li><li><a href="../html/103.2.webpack-bundle.html">103.2.webpack-bundle</a></li><li><a href="../html/103.3.webpack-ast.html">103.3.webpack-ast</a></li><li><a href="../html/103.4.webpack-flow.html">103.4.webpack-flow</a></li><li><a href="../html/103.5.webpack-loader.html">103.5.webpack-loader</a></li><li><a href="../html/103.6.webpack-tapable.html">103.6.webpack-tapable</a></li><li><a href="../html/103.7.webpack-plugin.html">103.7.webpack-plugin</a></li><li><a href="../html/103.8.webpack-optimize1.html">103.8.webpack-optimize1</a></li><li><a href="../html/103.9.webpack-optimize2.html">103.9.webpack-optimize2</a></li><li><a href="../html/103.10.webpack-hand.html">103.10.webpack-hand</a></li><li><a href="../html/103.11.webpack-hmr.html">103.11.webpack-hmr</a></li><li><a href="../html/103.11.webpack5.html">103.11.webpack5</a></li><li><a href="../html/103.13.splitChunks.html">103.13.splitChunks</a></li><li><a href="../html/103.14.webpack-sourcemap.html">103.14.webpack-sourcemap</a></li><li><a href="../html/103.15.webpack-compiler1.html">103.15.webpack-compiler1</a></li><li><a href="../html/103.15.webpack-compiler2.html">103.15.webpack-compiler2</a></li><li><a href="../html/103.16.rollup.1.html">103.16.rollup.1</a></li><li><a href="../html/103.16.rollup.2.html">103.16.rollup.2</a></li><li><a href="../html/103.16.rollup.3.html">103.16.rollup.3</a></li><li><a href="../html/103.16.vite.basic.html">103.16.vite.basic</a></li><li><a href="../html/103.16.vite.source.html">103.16.vite.source</a></li><li><a href="../html/103.16.vite.plugin.html">103.16.vite.plugin</a></li><li><a href="../html/103.16.vite.1.html">103.16.vite.1</a></li><li><a href="../html/103.16.vite.2.html">103.16.vite.2</a></li><li><a href="../html/103.17.polyfill.html">103.17.polyfill</a></li><li><a href="../html/104.1.binary.html">104.1.binary</a></li><li><a href="../html/104.2.binary.html">104.2.binary</a></li><li><a href="../html/105.skeleton.html">105.skeleton</a></li><li><a href="../html/106.1.react.html">106.1.react</a></li><li><a href="../html/106.2.react_hooks.html">106.2.react_hooks</a></li><li><a href="../html/106.3.react_router.html">106.3.react_router</a></li><li><a href="../html/106.4.redux.html">106.4.redux</a></li><li><a href="../html/106.5.redux_middleware.html">106.5.redux_middleware</a></li><li><a href="../html/106.6.connected-react-router.html">106.6.connected-react-router</a></li><li><a href="../html/106.6.redux-first-history.html">106.6.redux-first-history</a></li><li><a href="../html/106.7.redux-saga.html">106.7.redux-saga</a></li><li><a href="../html/106.8.dva.html">106.8.dva</a></li><li><a href="../html/106.9.umi.html">106.9.umi</a></li><li><a href="../html/106.10.ketang.html">106.10.ketang</a></li><li><a href="../html/106.11.antdesign.html">106.11.antdesign</a></li><li><a href="../html/106.12.antpro.html">106.12.antpro</a></li><li><a href="../html/106.13.router-6.html">106.13.router-6</a></li><li><a href="../html/106.14.ssr.html">106.14.ssr</a></li><li><a href="../html/106.15.nextjs.html">106.15.nextjs</a></li><li><a href="../html/106.16.1.cms.html">106.16.1.cms</a></li><li><a href="../html/106.16.2.cms.html">106.16.2.cms</a></li><li><a href="../html/106.16.3.cms.html">106.16.3.cms</a></li><li><a href="../html/106.16.4.cms.html">106.16.4.cms</a></li><li><a href="../html/106.16.mobx.html">106.16.mobx</a></li><li><a href="../html/106.17.fomily.html">106.17.fomily</a></li><li><a href="../html/107.fiber.html">107.fiber</a></li><li><a href="../html/108.http.html">108.http</a></li><li><a href="../html/109.1.webpack_usage.html">109.1.webpack_usage</a></li><li><a href="../html/109.2.webpack_source.html">109.2.webpack_source</a></li><li><a href="../html/109.3.dll.html">109.3.dll</a></li><li><a href="../html/110.nest.js.html">110.nest.js</a></li><li><a href="../html/111.xstate.html">111.xstate</a></li><li><a href="../html/112.Form.html">112.Form</a></li><li><a href="../html/113.redux-saga.html">113.redux-saga</a></li><li><a href="../html/114.react+typescript.html">114.react+typescript</a></li><li><a href="../html/115.immer.html">115.immer</a></li><li><a href="../html/116.pro5.html">116.pro5</a></li><li><a href="../html/117.css-loader.html">117.css-loader</a></li><li><a href="../html/118.1.umi-core.html">118.1.umi-core</a></li><li><a href="../html/119.2.module-federation.html">119.2.module-federation</a></li><li><a href="../html/119.1.module-federation.html">119.1.module-federation</a></li><li><a href="../html/120.create-react-app.html">120.create-react-app</a></li><li><a href="../html/121.react-scripts.html">121.react-scripts</a></li><li><a href="../html/122.react-optimize.html">122.react-optimize</a></li><li><a href="../html/123.jsx-runtime.html">123.jsx-runtime</a></li><li><a href="../html/124.next.js.html">124.next.js</a></li><li><a href="../html/125.1.linux.html">125.1.linux</a></li><li><a href="../html/125.2.linux-vi.html">125.2.linux-vi</a></li><li><a href="../html/125.3.linux-user.html">125.3.linux-user</a></li><li><a href="../html/125.4.linux-auth.html">125.4.linux-auth</a></li><li><a href="../html/125.5.linux-shell.html">125.5.linux-shell</a></li><li><a href="../html/125.6.linux-install.html">125.6.linux-install</a></li><li><a href="../html/125.7.linux-system.html">125.7.linux-system</a></li><li><a href="../html/125.8.linux-service.html">125.8.linux-service</a></li><li><a href="../html/125.9.linux-network.html">125.9.linux-network</a></li><li><a href="../html/125.10.nginx.html">125.10.nginx</a></li><li><a href="../html/125.11.docker.html">125.11.docker</a></li><li><a href="../html/125.12.ci.html">125.12.ci</a></li><li><a href="../html/125.13.k8s.html">125.13.k8s</a></li><li><a href="../html/125.14.k8s.html">125.14.k8s</a></li><li><a href="../html/125.15.k8s.html">125.15.k8s</a></li><li><a href="../html/125.16.k8s.html">125.16.k8s</a></li><li><a href="../html/126.11.react-1.html">126.11.react-1</a></li><li><a href="../html/126.12.react-2.html">126.12.react-2</a></li><li><a href="../html/126.12.react-3.html">126.12.react-3</a></li><li><a href="../html/126.12.react-4.html">126.12.react-4</a></li><li><a href="../html/126.12.react-5.html">126.12.react-5</a></li><li><a href="../html/126.12.react-6.html">126.12.react-6</a></li><li><a href="../html/126.12.react-7.html">126.12.react-7</a></li><li><a href="../html/126.12.react-8.html">126.12.react-8</a></li><li><a href="../html/127.frontend.html">127.frontend</a></li><li><a href="../html/128.rollup.html">128.rollup</a></li><li><a href="../html/129.px2rem-loader.html">129.px2rem-loader</a></li><li><a href="../html/130.health.html">130.health</a></li><li><a href="../html/131.hooks.html">131.hooks</a></li><li><a href="../html/132.keepalive.html">132.keepalive</a></li><li><a href="../html/133.vue-cli.html">133.vue-cli</a></li><li><a href="../html/134.react18.html">134.react18</a></li><li><a href="../html/134.2.react18.html">134.2.react18</a></li><li><a href="../html/134.3.react18.html">134.3.react18</a></li><li><a href="../html/135.function.html">135.function</a></li><li><a href="../html/136.toolkit.html">136.toolkit</a></li><li><a href="../html/137.lerna.html">137.lerna</a></li><li><a href="../html/138.create-vite.html">138.create-vite</a></li><li><a href="../html/139.cli.html">139.cli</a></li><li><a href="../html/140.antd.html">140.antd</a></li><li><a href="../html/141.react-dnd.html">141.react-dnd</a></li><li><a href="../html/142.1.link.html">142.1.link</a></li><li><a href="../html/143.1.gulp.html">143.1.gulp</a></li><li><a href="../html/143.2.stream.html">143.2.stream</a></li><li><a href="../html/143.3.gulp.html">143.3.gulp</a></li><li><a href="../html/144.1.closure.html">144.1.closure</a></li><li><a href="../html/144.2.v8.html">144.2.v8</a></li><li><a href="../html/144.3.gc.html">144.3.gc</a></li><li><a href="../html/145.react-router-v6.html">145.react-router-v6</a></li><li><a href="../html/146.browser.html">146.browser</a></li><li><a href="../html/147.lighthouse.html">147.lighthouse</a></li><li><a href="../html/148.1.basic.html">148.1.basic</a></li><li><a href="../html/148.2.basic .html">148.2.basic </a></li><li><a href="../html/148.3.basic.html">148.3.basic</a></li><li><a href="../html/148.4.basic.html">148.4.basic</a></li><li><a href="../html/148.5.basic.html">148.5.basic</a></li><li><a href="../html/149.1.vite.html">149.1.vite</a></li><li><a href="../html/149.2.vite.html">149.2.vite</a></li><li><a href="../html/149.3.vite.html">149.3.vite</a></li><li><a href="../html/149.4.vite.html">149.4.vite</a></li><li><a href="../html/150.react-window.html">150.react-window</a></li><li><a href="../html/151.react-query.html">151.react-query</a></li><li class="active"><a href="../html/152.useRequest.html">152.useRequest</a></li><li><a href="../html/153.transition.html">153.transition</a></li><li><a href="../html/154.emotion.html">154.emotion</a></li><li><a href="../html/155.1.formily.html">155.1.formily</a></li><li><a href="../html/155.2.formily.html">155.2.formily</a></li><li><a href="../html/155.3.formily.html">155.3.formily</a></li><li><a href="../html/155.3.1.mobx.usage.html">155.3.1.mobx.usage</a></li><li><a href="../html/155.3.2.mobx.source.html">155.3.2.mobx.source</a></li><li><a href="../html/156.vue-loader.html">156.vue-loader</a></li><li><a href="../html/103.11.mf.html">103.11.mf</a></li><li><a href="../html/157.1.react18.html">157.1.react18</a></li><li><a href="../html/158.umi4.html">158.umi4</a></li><li><a href="../html/159.rxjs.html">159.rxjs</a></li><li><a href="../html/159.rxjs2.html">159.rxjs2</a></li><li><a href="../html/160.bff.html">160.bff</a></li></ul>                        </div>

                        
<div class="warpper">
    <div class="page-toc">
        <ul><li><a href="#t01.useRequest">1.useRequest</a><ul><li><a href="#t11.1 API">1.1 API</a></li><li><a href="#t21.2 结果">1.2 结果</a></li><li><a href="#t31.3 选项">1.3 选项</a></li><li><a href="#t41.4 安装">1.4 安装</a></li><li><a href="#t51.5 依赖Hooks">1.5 依赖Hooks</a></li></ul></li><li><a href="#t62.自动请求">2.自动请求</a><ul><li><a href="#t72.1 src\index.js">2.1 src\index.js</a></li><li><a href="#t82.2 App.js">2.2 App.js</a></li><li><a href="#t92.3 ahooks\index.js">2.3 ahooks\index.js</a></li><li><a href="#t102.4 useRequest\index.js">2.4 useRequest\index.js</a></li><li><a href="#t112.5 useRequest.js">2.5 useRequest.js</a></li><li><a href="#t122.6 useRequestImplement.js">2.6 useRequestImplement.js</a></li><li><a href="#t132.7 useLatest\index.js">2.7 useLatest\index.js</a></li><li><a href="#t142.8 useUpdate\index.js">2.8 useUpdate\index.js</a></li><li><a href="#t152.9 useCreation\index.js">2.9 useCreation\index.js</a></li><li><a href="#t162.10 depsAreSame.js">2.10 depsAreSame.js</a></li><li><a href="#t172.11 useMount\index.js">2.11 useMount\index.js</a></li><li><a href="#t182.12 Fetch.js">2.12 Fetch.js</a></li></ul></li><li><a href="#t193.错误处理">3.错误处理</a><ul><li><a href="#t203.1 src\App.js">3.1 src\App.js</a></li><li><a href="#t213.2 useRequestImplement.js">3.2 useRequestImplement.js</a></li><li><a href="#t223.3 Fetch.js">3.3 Fetch.js</a></li></ul></li><li><a href="#t234.手工触发">4.手工触发</a><ul><li><a href="#t244.1 src\App.js">4.1 src\App.js</a></li><li><a href="#t254.2 useRequest.js">4.2 useRequest.js</a></li><li><a href="#t264.3 useRequestImplement.js">4.3 useRequestImplement.js</a></li><li><a href="#t274.4 useMemoizedFn\index.js">4.4 useMemoizedFn\index.js</a></li><li><a href="#t284.5 Fetch.js">4.5 Fetch.js</a></li></ul></li><li><a href="#t295.传递参数">5.传递参数</a><ul><li><a href="#t305.1 src\App.js">5.1 src\App.js</a></li><li><a href="#t315.2 useRequestImplement.js">5.2 useRequestImplement.js</a></li><li><a href="#t325.3 Fetch.js">5.3 Fetch.js</a></li></ul></li><li><a href="#t336.生命周期">6.生命周期</a><ul><li><a href="#t346.1 src\App.js">6.1 src\App.js</a></li><li><a href="#t356.2 Fetch.js">6.2 Fetch.js</a></li></ul></li><li><a href="#t367.刷新(重复上一次请求)">7.刷新(重复上一次请求)</a><ul><li><a href="#t377.1 src\App.js">7.1 src\App.js</a></li><li><a href="#t387.2 useRequestImplement.js">7.2 useRequestImplement.js</a></li><li><a href="#t397.3 Fetch.js">7.3 Fetch.js</a></li></ul></li><li><a href="#t408.立即变更数据">8.立即变更数据</a><ul><li><a href="#t418.1 App.js">8.1 App.js</a></li><li><a href="#t428.2 useRequestImplement.js">8.2 useRequestImplement.js</a></li><li><a href="#t438.3 Fetch.js">8.3 Fetch.js</a></li><li><a href="#t448.4 utils\index.js">8.4 utils\index.js</a></li></ul></li><li><a href="#t459.取消请求">9.取消请求</a><ul><li><a href="#t469.1 App.js">9.1 App.js</a></li><li><a href="#t479.2 useRequestImplement.js">9.2 useRequestImplement.js</a></li><li><a href="#t489.3 Fetch.js">9.3 Fetch.js</a></li><li><a href="#t499.4 useUnmount\index.js">9.4 useUnmount\index.js</a></li></ul></li><li><a href="#t5010.插件系统">10.插件系统</a><ul><li><a href="#t5110.1 App.js">10.1 App.js</a></li><li><a href="#t5210.2 useRequest.js">10.2 useRequest.js</a></li><li><a href="#t5310.3 useRequestImplement.js">10.3 useRequestImplement.js</a></li><li><a href="#t5410.4 useLoggerPlugin.js">10.4 useLoggerPlugin.js</a></li><li><a href="#t5510.5 Fetch.js">10.5 Fetch.js</a></li></ul></li><li><a href="#t5611.Loading Delay">11.Loading Delay</a><ul><li><a href="#t5711.1 App.js">11.1 App.js</a></li><li><a href="#t5811.2 useRequest.js">11.2 useRequest.js</a></li><li><a href="#t5911.3 useLoadingDelayPlugin.js">11.3 useLoadingDelayPlugin.js</a></li></ul></li><li><a href="#t6012.轮询">12.轮询</a><ul><li><a href="#t6112.1 轮询">12.1 轮询</a><ul><li><a href="#t6212.1.1 App.js">12.1.1 App.js</a></li><li><a href="#t6312.1.2 useRequest.js">12.1.2 useRequest.js</a></li><li><a href="#t6412.1.3 usePollingPlugin.js">12.1.3 usePollingPlugin.js</a></li><li><a href="#t6512.1.4 useUpdateEffect\index.js">12.1.4 useUpdateEffect\index.js</a></li><li><a href="#t6612.1.5 createUpdateEffect\index.js">12.1.5 createUpdateEffect\index.js</a></li></ul></li><li><a href="#t6712.2 后台轮询">12.2 后台轮询</a><ul><li><a href="#t6812.2.1 src\App.js">12.2.1 src\App.js</a></li><li><a href="#t6912.2.2 usePollingPlugin.js">12.2.2 usePollingPlugin.js</a></li><li><a href="#t7012.2.3 isDocumentVisible.js">12.2.3 isDocumentVisible.js</a></li><li><a href="#t7112.2.4 subscribeReVisible.js">12.2.4 subscribeReVisible.js</a></li></ul></li></ul></li><li><a href="#t7213.Ready和和依赖更新">13.Ready和和依赖更新</a><ul><li><a href="#t7313.1 自动模式">13.1 自动模式</a><ul><li><a href="#t7413.1.1 App.js">13.1.1 App.js</a></li><li><a href="#t7513.1.2 useRequest.js">13.1.2 useRequest.js</a></li><li><a href="#t7613.1.3 useAutoRunPlugin.js">13.1.3 useAutoRunPlugin.js</a></li><li><a href="#t7713.1.4 Fetch.js">13.1.4 Fetch.js</a></li></ul></li><li><a href="#t7813.2 手动模式">13.2 手动模式</a><ul><li><a href="#t7913.2.1 App.js">13.2.1 App.js</a></li></ul></li><li><a href="#t8013.3 依赖更新">13.3 依赖更新</a><ul><li><a href="#t8113.3.1 App.js">13.3.1 App.js</a></li><li><a href="#t8213.3.2 useAutoRunPlugin.js">13.3.2 useAutoRunPlugin.js</a></li></ul></li></ul></li><li><a href="#t8314.屏幕聚焦重新请求">14.屏幕聚焦重新请求</a><ul><li><a href="#t8414.1 App.js">14.1 App.js</a></li><li><a href="#t8514.2 useRequest.js">14.2 useRequest.js</a></li><li><a href="#t8614.3 useRefreshOnWindowFocusPlugin.js">14.3 useRefreshOnWindowFocusPlugin.js</a></li><li><a href="#t8714.4 limit.js">14.4 limit.js</a></li><li><a href="#t8814.5 subscribeFocus.js">14.5 subscribeFocus.js</a></li></ul></li><li><a href="#t8915.防抖">15.防抖</a><ul><li><a href="#t9015.1 App.js">15.1 App.js</a></li><li><a href="#t9115.2 useRequest.js">15.2 useRequest.js</a></li><li><a href="#t9215.3 useDebouncePlugin.js">15.3 useDebouncePlugin.js</a></li></ul></li><li><a href="#t9316.节流">16.节流</a><ul><li><a href="#t9416.1 App.js">16.1 App.js</a></li><li><a href="#t9516.2 useRequest.js">16.2 useRequest.js</a></li><li><a href="#t9616.3 useThrottlePlugin.js">16.3 useThrottlePlugin.js</a></li></ul></li><li><a href="#t9717.错误重试">17.错误重试</a><ul><li><a href="#t9817.1 App.js">17.1 App.js</a></li><li><a href="#t9917.2 useRequest.js">17.2 useRequest.js</a></li><li><a href="#t10017.3 useRetryPlugin.js">17.3 useRetryPlugin.js</a></li></ul></li><li><a href="#t10118.缓存">18.缓存</a><ul><li><a href="#t10218.1 SWR">18.1 SWR</a><ul><li><a href="#t10318.1.1 App.js">18.1.1 App.js</a></li><li><a href="#t10418.1.2 useRequest.js">18.1.2 useRequest.js</a></li><li><a href="#t10518.1.3 useCachePlugin.js">18.1.3 useCachePlugin.js</a></li><li><a href="#t10618.1.4 cache.js">18.1.4 cache.js</a></li></ul></li><li><a href="#t10718.2 数据保持新鲜">18.2 数据保持新鲜</a><ul><li><a href="#t10818.2.1 App.js">18.2.1 App.js</a></li><li><a href="#t10918.2.2 useCachePlugin.js">18.2.2 useCachePlugin.js</a></li><li><a href="#t11018.2.3 Fetch.js">18.2.3 Fetch.js</a></li></ul></li><li><a href="#t11118.3 参数缓存">18.3 参数缓存</a><ul><li><a href="#t11218.3.1 App.js">18.3.1 App.js</a></li><li><a href="#t11318.3.2 useRequestImplement.js">18.3.2 useRequestImplement.js</a></li><li><a href="#t11418.3.3 useCachePlugin.js">18.3.3 useCachePlugin.js</a></li></ul></li><li><a href="#t11518.4 删除缓存">18.4 删除缓存</a><ul><li><a href="#t11618.4.1 App.js">18.4.1 App.js</a></li><li><a href="#t11718.4.2 ahooks\index.js">18.4.2 ahooks\index.js</a></li><li><a href="#t11818.4.3 useRequest\index.js">18.4.3 useRequest\index.js</a></li><li><a href="#t11918.4.4 cache.js">18.4.4 cache.js</a></li></ul></li><li><a href="#t12018.5 自定义缓存">18.5 自定义缓存</a><ul><li><a href="#t12118.5.1 App.js">18.5.1 App.js</a></li><li><a href="#t12218.5.2 useCachePlugin.js">18.5.2 useCachePlugin.js</a></li></ul></li><li><a href="#t12318.6 数据共享">18.6 数据共享</a><ul><li><a href="#t12418.6.1 App.js">18.6.1 App.js</a></li><li><a href="#t12518.6.2 useCachePlugin.js">18.6.2 useCachePlugin.js</a></li><li><a href="#t12618.6.3 cachePromise.js">18.6.3 cachePromise.js</a></li><li><a href="#t12718.6.4 cacheSubscribe.js">18.6.4 cacheSubscribe.js</a></li></ul></li></ul></li></ul>
    </div>
    <div class="content markdown-body">
        <h2 id="t01.useRequest">1.useRequest <a href="#t01.useRequest"> # </a></h2>
<ul>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-request/index">useRequest</a>&#x662F;&#x4E00;&#x4E2A;&#x5F3A;&#x5927;&#x7684;&#x5F02;&#x6B65;&#x6570;&#x636E;&#x7BA1;&#x7406;&#x7684; <code>Hooks</code>&#xFF0C;React &#x9879;&#x76EE;&#x4E2D;&#x7684;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x573A;&#x666F;&#x4F7F;&#x7528; <code>useRequest</code> &#x5C31;&#x591F;&#x4E86;</li>
<li><code>useRequest</code> &#x901A;&#x8FC7;&#x63D2;&#x4EF6;&#x5F0F;&#x7EC4;&#x7EC7;&#x4EE3;&#x7801;&#xFF0C;&#x6838;&#x5FC3;&#x4EE3;&#x7801;&#x6781;&#x5176;&#x7B80;&#x5355;&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x5F88;&#x65B9;&#x4FBF;&#x7684;&#x6269;&#x5C55;&#x51FA;&#x66F4;&#x9AD8;&#x7EA7;&#x7684;&#x529F;&#x80FD;&#x3002;&#x76EE;&#x524D;&#x5DF2;&#x6709;&#x80FD;&#x529B;&#x5305;&#x62EC;&#xFF1A;<ul>
<li>&#x81EA;&#x52A8;&#x8BF7;&#x6C42;/&#x624B;&#x52A8;&#x8BF7;&#x6C42;</li>
<li>&#x8F6E;&#x8BE2;</li>
<li>&#x9632;&#x6296;</li>
<li>&#x8282;&#x6D41;</li>
<li>&#x5C4F;&#x5E55;&#x805A;&#x7126;&#x91CD;&#x65B0;&#x8BF7;&#x6C42;</li>
<li>&#x9519;&#x8BEF;&#x91CD;&#x8BD5;</li>
<li>loading delay</li>
<li>SWR(stale-while-revalidate)&#x91CD;&#x65B0;&#x8BF7;&#x6C42;&#x7684;&#x540C;&#x65F6;&#x4F7F;&#x7528;&#x8FC7;&#x671F;&#x6570;&#x636E;</li>
<li>&#x7F13;&#x5B58;</li>
</ul>
</li>
</ul>
<h3 id="t11.1 API">1.1 API <a href="#t11.1 API"> # </a></h3>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> {
  loading,
  data,
  error,
  params,
  run,
  runAsync,
  refresh,
  refreshAsync,
  mutate,
  cancel
  } = useRequest(service,
  {
    manual,
    defaultParams,
    onBefore,
    onSuccess,
    onError,
    onFinally
  }
);
</code></pre>
<h3 id="t21.2 &#x7ED3;&#x679C;">1.2 &#x7ED3;&#x679C; <a href="#t21.2 &#x7ED3;&#x679C;"> # </a></h3>
<table>
<thead>
<tr>
<th style="text-align:left">&#x53C2;&#x6570;</th>
<th style="text-align:left">&#x8BF4;&#x660E;</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">data</td>
<td style="text-align:left">service &#x8FD4;&#x56DE;&#x7684;&#x6570;&#x636E;</td>
</tr>
<tr>
<td style="text-align:left">error</td>
<td style="text-align:left">service &#x629B;&#x51FA;&#x7684;&#x5F02;&#x5E38;</td>
</tr>
<tr>
<td style="text-align:left">loading</td>
<td style="text-align:left">service &#x662F;&#x5426;&#x6B63;&#x5728;&#x6267;&#x884C;</td>
</tr>
<tr>
<td style="text-align:left">params</td>
<td style="text-align:left">&#x5F53;&#x6B21;&#x6267;&#x884C;&#x7684; service &#x7684;&#x53C2;&#x6570;&#x6570;&#x7EC4;</td>
</tr>
<tr>
<td style="text-align:left">run</td>
<td style="text-align:left">&#x624B;&#x52A8;&#x89E6;&#x53D1; service &#x6267;&#x884C;</td>
</tr>
<tr>
<td style="text-align:left">runAsync</td>
<td style="text-align:left">&#x4E0E; run &#x7528;&#x6CD5;&#x4E00;&#x81F4;&#xFF0C;&#x4F46;&#x8FD4;&#x56DE;&#x7684;&#x662F; Promise&#xFF0C;&#x9700;&#x8981;&#x81EA;&#x884C;&#x5904;&#x7406;&#x5F02;&#x5E38;</td>
</tr>
<tr>
<td style="text-align:left">refresh</td>
<td style="text-align:left">&#x4F7F;&#x7528;&#x4E0A;&#x4E00;&#x6B21;&#x7684; params&#xFF0C;&#x91CD;&#x65B0;&#x8C03;&#x7528; run</td>
</tr>
<tr>
<td style="text-align:left">refreshAsync</td>
<td style="text-align:left">&#x4F7F;&#x7528;&#x4E0A;&#x4E00;&#x6B21;&#x7684; params&#xFF0C;&#x91CD;&#x65B0;&#x8C03;&#x7528; runAsync</td>
</tr>
<tr>
<td style="text-align:left">mutate</td>
<td style="text-align:left">&#x76F4;&#x63A5;&#x4FEE;&#x6539; data</td>
</tr>
<tr>
<td style="text-align:left">cancel</td>
<td style="text-align:left">&#x53D6;&#x6D88;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x8FDB;&#x884C;&#x7684;&#x8BF7;&#x6C42;</td>
</tr>
</tbody>
</table>
<h3 id="t31.3 &#x9009;&#x9879;">1.3 &#x9009;&#x9879; <a href="#t31.3 &#x9009;&#x9879;"> # </a></h3>
<table>
<thead>
<tr>
<th style="text-align:left">&#x53C2;&#x6570;</th>
<th style="text-align:left">&#x8BF4;&#x660E;</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">manual</td>
<td style="text-align:left">&#x9ED8;&#x8BA4; false&#x3002; &#x5373;&#x5728;&#x521D;&#x59CB;&#x5316;&#x65F6;&#x81EA;&#x52A8;&#x6267;&#x884C; service</td>
</tr>
<tr>
<td style="text-align:left">defaultParams</td>
<td style="text-align:left">&#x9996;&#x6B21;&#x9ED8;&#x8BA4;&#x6267;&#x884C;&#x65F6;&#xFF0C;&#x4F20;&#x9012;&#x7ED9; service &#x7684;&#x53C2;&#x6570;</td>
</tr>
<tr>
<td style="text-align:left">onBefore</td>
<td style="text-align:left">service &#x6267;&#x884C;&#x524D;&#x89E6;&#x53D1;</td>
</tr>
<tr>
<td style="text-align:left">onSuccess</td>
<td style="text-align:left">service resolve &#x65F6;&#x89E6;&#x53D1;</td>
</tr>
<tr>
<td style="text-align:left">onError</td>
<td style="text-align:left">service reject &#x65F6;&#x89E6;&#x53D1;</td>
</tr>
<tr>
<td style="text-align:left">onFinally</td>
<td style="text-align:left">service &#x6267;&#x884C;&#x5B8C;&#x6210;&#x65F6;&#x89E6;&#x53D1;</td>
</tr>
</tbody>
</table>
<h3 id="t41.4 &#x5B89;&#x88C5;">1.4 &#x5B89;&#x88C5; <a href="#t41.4 &#x5B89;&#x88C5;"> # </a></h3>
<pre><code class="lang-js">npm install ahooks  --save
</code></pre>
<h3 id="t51.5 &#x4F9D;&#x8D56;Hooks">1.5 &#x4F9D;&#x8D56;Hooks <a href="#t51.5 &#x4F9D;&#x8D56;Hooks"> # </a></h3>
<ul>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-request/index">useRequest</a>&#x662F;&#x4E00;&#x4E2A;&#x5F3A;&#x5927;&#x7684;&#x5F02;&#x6B65;&#x6570;&#x636E;&#x7BA1;&#x7406;&#x7684; Hooks&#xFF0C;React&#x9879;&#x76EE;&#x4E2D;&#x7684;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x573A;&#x666F;&#x4F7F;&#x7528; useRequest &#x5C31;&#x591F;&#x4E86;</li>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-update-effect">useUpdateEffect</a>&#x7528;&#x6CD5;&#x7B49;&#x540C;&#x4E8E; useEffect&#xFF0C;&#x4F46;&#x662F;&#x4F1A;&#x5FFD;&#x7565;&#x9996;&#x6B21;&#x6267;&#x884C;&#xFF0C;&#x53EA;&#x5728;&#x4F9D;&#x8D56;&#x66F4;&#x65B0;&#x65F6;&#x6267;&#x884C;</li>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-creation">useCreation</a> &#x662F; <code>useMemo</code> &#x6216; <code>useRef</code> &#x7684;&#x66FF;&#x4EE3;&#x54C1;</li>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-latest">useLatest</a>&#x8FD4;&#x56DE;&#x5F53;&#x524D;&#x6700;&#x65B0;&#x503C;&#x7684; Hook&#xFF0C;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x95ED;&#x5305;&#x95EE;&#x9898;</li>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-memoized-fn">useMemoizedFn</a>&#x662F;&#x6301;&#x4E45;&#x5316; function &#x7684; Hook&#xFF0C;&#x7406;&#x8BBA;&#x4E0A;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; useMemoizedFn &#x5B8C;&#x5168;&#x4EE3;&#x66FF; useCallback</li>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-mount">useMount</a>&#x662F;&#x53EA;&#x5728;&#x7EC4;&#x4EF6;&#x521D;&#x59CB;&#x5316;&#x65F6;&#x6267;&#x884C;&#x7684; Hook</li>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-unmount">useUnmount</a>&#x662F;&#x5728;&#x7EC4;&#x4EF6;&#x5378;&#x8F7D;&#xFF08;unmount&#xFF09;&#x65F6;&#x6267;&#x884C;&#x7684; Hook&#x3002;</li>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-update">useUpdate</a>&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x8C03;&#x7528;&#x8BE5;&#x51FD;&#x6570;&#x4F1A;&#x5F3A;&#x5236;&#x7EC4;&#x4EF6;&#x91CD;&#x65B0;&#x6E32;&#x67D3;</li>
</ul>
<h2 id="t62.&#x81EA;&#x52A8;&#x8BF7;&#x6C42;">2.&#x81EA;&#x52A8;&#x8BF7;&#x6C42; <a href="#t62.&#x81EA;&#x52A8;&#x8BF7;&#x6C42;"> # </a></h2>
<ul>
<li>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;<code>useRequest</code> &#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x4E00;&#x4E2A;&#x5F02;&#x6B65;&#x51FD;&#x6570;&#xFF0C;&#x5728;&#x7EC4;&#x4EF6;&#x521D;&#x59CB;&#x5316;&#x65F6;&#xFF0C;&#x4F1A;&#x81EA;&#x52A8;&#x6267;&#x884C;&#x8BE5;&#x5F02;&#x6B65;&#x51FD;&#x6570;&#x3002;&#x540C;&#x65F6;&#x81EA;&#x52A8;&#x7BA1;&#x7406;&#x8BE5;&#x5F02;&#x6B65;&#x51FD;&#x6570;&#x7684; <code>loading</code> , <code>data</code>, <code>error</code> &#x7B49;&#x72B6;&#x6001;&#x3002;</li>
</ul>
<h3 id="t72.1 src\index.js">2.1 src\index.js <a href="#t72.1 src\index.js"> # </a></h3>
<p>src\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react-dom/client&apos;</span>;
<span class="hljs-keyword">import</span> App <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./App&apos;</span>;
<span class="hljs-keyword">const</span> root = ReactDOM.createRoot(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;root&apos;</span>));
root.render(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);
</code></pre>
<h3 id="t82.2 App.js">2.2 App.js <a href="#t82.2 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useRequest } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ahooks&apos;</span>;
<span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getName</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      resolve(<span class="hljs-string">&apos;zhufeng&apos;</span>);
    }, <span class="hljs-number">1000</span>);
  });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">App</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> { data, loading } = useRequest(getName);
  <span class="hljs-keyword">if</span> (loading) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#x52A0;&#x8F7D;&#x4E2D;...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#x7528;&#x6237;&#x540D;: {data}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> App;
</code></pre>
<h3 id="t92.3 ahooks\index.js">2.3 ahooks\index.js <a href="#t92.3 ahooks\index.js"> # </a></h3>
<p>src\ahooks\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> useRequest <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./useRequest&apos;</span>;
<span class="hljs-keyword">export</span> {
  useRequest
}
</code></pre>
<h3 id="t102.4 useRequest\index.js">2.4 useRequest\index.js <a href="#t102.4 useRequest\index.js"> # </a></h3>
<p>src\ahooks\useRequest\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> useRequest <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./src/useRequest&apos;</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useRequest;
</code></pre>
<h3 id="t112.5 useRequest.js">2.5 useRequest.js <a href="#t112.5 useRequest.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequest.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> useRequestImplement <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./useRequestImplement&apos;</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useRequest</span>(<span class="hljs-params">service</span>) </span>{
  <span class="hljs-keyword">return</span> useRequestImplement(service);
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useRequest;
</code></pre>
<h3 id="t122.6 useRequestImplement.js">2.6 useRequestImplement.js <a href="#t122.6 useRequestImplement.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequestImplement.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> useLatest <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;../../useLatest&apos;</span>;
<span class="hljs-keyword">import</span> useUpdate <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;../../useUpdate&apos;</span>;
<span class="hljs-keyword">import</span> useCreation <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;../../useCreation&apos;</span>;
<span class="hljs-keyword">import</span> useMount <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;../../useMount&apos;</span>;
<span class="hljs-keyword">import</span> Fetch <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./Fetch&apos;</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useRequestImplement</span>(<span class="hljs-params">service</span>) </span>{
  <span class="hljs-keyword">const</span> serviceRef = useLatest(service);
  <span class="hljs-keyword">const</span> update = useUpdate();
  <span class="hljs-keyword">const</span> fetchInstance = useCreation(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Fetch(serviceRef, update);
  }, []);
  useMount(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    fetchInstance.run();
  });
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">loading</span>: fetchInstance.state.loading,
    <span class="hljs-attr">data</span>: fetchInstance.state.data
  };
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useRequestImplement;
</code></pre>
<h3 id="t132.7 useLatest\index.js">2.7 useLatest\index.js <a href="#t132.7 useLatest\index.js"> # </a></h3>
<ul>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-latest">useLatest</a>&#x8FD4;&#x56DE;&#x5F53;&#x524D;&#x6700;&#x65B0;&#x503C;&#x7684; Hook&#xFF0C;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x95ED;&#x5305;&#x95EE;&#x9898;</li>
</ul>
<p>src\ahooks\useLatest\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useLatest</span>(<span class="hljs-params">value</span>) </span>{
  <span class="hljs-keyword">const</span> ref = useRef(value);
  ref.current = value;
  <span class="hljs-keyword">return</span> ref;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useLatest;
</code></pre>
<h3 id="t142.8 useUpdate\index.js">2.8 useUpdate\index.js <a href="#t142.8 useUpdate\index.js"> # </a></h3>
<ul>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-update">useUpdate</a>&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x8C03;&#x7528;&#x8BE5;&#x51FD;&#x6570;&#x4F1A;&#x5F3A;&#x5236;&#x7EC4;&#x4EF6;&#x91CD;&#x65B0;&#x6E32;&#x67D3;</li>
</ul>
<p>src\ahooks\useUpdate\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useCallback, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">const</span> useUpdate = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> [, setState] = useState({});
  <span class="hljs-keyword">return</span> useCallback(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> setState({}), []);
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useUpdate;
</code></pre>
<h3 id="t152.9 useCreation\index.js">2.9 useCreation\index.js <a href="#t152.9 useCreation\index.js"> # </a></h3>
<ul>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-creation">useCreation</a> &#x662F; <code>useMemo</code> &#x6216; <code>useRef</code> &#x7684;&#x66FF;&#x4EE3;&#x54C1;</li>
<li>&#x56E0;&#x4E3A; useMemo &#x4E0D;&#x80FD;&#x4FDD;&#x8BC1;&#x88AB; memo &#x7684;&#x503C;&#x4E00;&#x5B9A;&#x4E0D;&#x4F1A;&#x88AB;&#x91CD;&#x8BA1;&#x7B97;&#xFF0C;&#x800C; useCreation &#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x8FD9;&#x4E00;&#x70B9;</li>
</ul>
<p>src\ahooks\useCreation\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> depsAreSame <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;../utils/depsAreSame&apos;</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useCreation</span>(<span class="hljs-params">factory, deps</span>) </span>{
  <span class="hljs-keyword">const</span> { current } = useRef({
    deps,
    <span class="hljs-attr">obj</span>: <span class="hljs-literal">undefined</span>,
    <span class="hljs-attr">initialized</span>: <span class="hljs-literal">false</span>
  });
  <span class="hljs-keyword">if</span> (current.initialized === <span class="hljs-literal">false</span> || !depsAreSame(current.deps, deps)) {
    current.deps = deps;
    current.obj = factory();
    current.initialized = <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">return</span> current.obj;
}
</code></pre>
<h3 id="t162.10 depsAreSame.js">2.10 depsAreSame.js <a href="#t162.10 depsAreSame.js"> # </a></h3>
<p>src\ahooks\utils\depsAreSame.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">depsAreSame</span>(<span class="hljs-params">oldDeps, deps</span>) </span>{
  <span class="hljs-keyword">if</span> (oldDeps === deps) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; oldDeps.length; i++) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Object</span>.is(oldDeps[i], deps[i])) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h3 id="t172.11 useMount\index.js">2.11 useMount\index.js <a href="#t172.11 useMount\index.js"> # </a></h3>
<ul>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-mount">useMount</a>&#x662F;&#x53EA;&#x5728;&#x7EC4;&#x4EF6;&#x521D;&#x59CB;&#x5316;&#x65F6;&#x6267;&#x884C;&#x7684; Hook
src\ahooks\useMount\index.js<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">const</span> useMount = <span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> {
useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  fn?.();
}, []);
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useMount;
</code></pre>
</li>
</ul>
<h3 id="t182.12 Fetch.js">2.12 Fetch.js <a href="#t182.12 Fetch.js"> # </a></h3>
<p>src\ahooks\useRequest\src\Fetch.js</p>
<pre><code class="lang-js"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Fetch</span> </span>{
  <span class="hljs-keyword">constructor</span>(serviceRef, subscribe) {
    <span class="hljs-keyword">this</span>.serviceRef = serviceRef;
    <span class="hljs-keyword">this</span>.subscribe = subscribe;
    <span class="hljs-keyword">this</span>.state = { <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">undefined</span> };
  }
  setState = <span class="hljs-function">(<span class="hljs-params">s = {}</span>) =&gt;</span> {
    <span class="hljs-keyword">this</span>.state = { ...this.state, ...s };
    <span class="hljs-keyword">this</span>.subscribe();
  }
  runAsync = <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">this</span>.setState({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span> });
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.serviceRef.current();
    <span class="hljs-keyword">this</span>.setState({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">data</span>: res });
  }
  run = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">this</span>.runAsync();
  }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Fetch;
</code></pre>
<h2 id="t193.&#x9519;&#x8BEF;&#x5904;&#x7406;">3.&#x9519;&#x8BEF;&#x5904;&#x7406; <a href="#t193.&#x9519;&#x8BEF;&#x5904;&#x7406;"> # </a></h2>
<h3 id="t203.1 src\App.js">3.1 src\App.js <a href="#t203.1 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import { useRequest } from &apos;./ahooks&apos;;
import React from &apos;react&apos;;

function getName() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
<span class="hljs-deletion">-     resolve(&apos;zhufeng&apos;);</span>
<span class="hljs-addition">+     reject(new Error(&apos;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;&apos;));</span>
    }, 1000);
  });
}

function App() {
<span class="hljs-addition">+ const { data, loading, error } = useRequest(getName);</span>
  if (loading) {
    return &lt;div&gt;&#x52A0;&#x8F7D;&#x4E2D;...&lt;/div&gt;;
  }
<span class="hljs-addition">+ if (error) {</span>
<span class="hljs-addition">+   return &lt;div&gt;&#x52A0;&#x8F7D;&#x5931;&#x8D25;&lt;/div&gt;;</span>
<span class="hljs-addition">+ }</span>
  return &lt;div&gt;&#x7528;&#x6237;&#x540D;: {data}&lt;/div&gt;;
};
export default App;
</code></pre>
<h3 id="t213.2 useRequestImplement.js">3.2 useRequestImplement.js <a href="#t213.2 useRequestImplement.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequestImplement.js</p>
<pre><code class="lang-diff">import useCreation from &apos;../../useCreation&apos;;
import useLatest from &apos;../../useLatest&apos;;
import useMount from &apos;../../useMount&apos;;
import useUpdate from &apos;../../useUpdate&apos;;
import Fetch from &apos;./Fetch&apos;;
function useRequestImplement(service) {
  const serviceRef = useLatest(service);
  const update = useUpdate();
  const fetchInstance = useCreation(() =&gt; {
    return new Fetch(serviceRef, update);
  }, []);
  useMount(() =&gt; {
    fetchInstance.run();
  });
  return {
    loading: fetchInstance.state.loading,
    data: fetchInstance.state.data,
<span class="hljs-addition">+   error: fetchInstance.state.error</span>
  };
}

export default useRequestImplement;
</code></pre>
<h3 id="t223.3 Fetch.js">3.3 Fetch.js <a href="#t223.3 Fetch.js"> # </a></h3>
<p>src\ahooks\useRequest\src\Fetch.js</p>
<pre><code class="lang-diff">class Fetch {
  constructor(serviceRef, subscribe) {
    this.serviceRef = serviceRef;
    this.subscribe = subscribe;
<span class="hljs-addition">+   this.state = { loading: false, data: undefined, error: undefined };</span>
  }
  setState = (s = {}) =&gt; {
    this.state = { ...this.state, ...s };
    this.subscribe();
  }
  runAsync = async () =&gt; {
    this.setState({ loading: true });
<span class="hljs-addition">+   try {</span>
      const res = await this.serviceRef.current();
<span class="hljs-addition">+     this.setState({ loading: false, data: res, error: undefined });</span>
<span class="hljs-addition">+   } catch (error) {</span>
<span class="hljs-addition">+     this.setState({ loading: false, error });</span>
<span class="hljs-addition">+   }</span>
  }
  run = () =&gt; {
    this.runAsync();
  }
}
export default Fetch;
</code></pre>
<h2 id="t234.&#x624B;&#x5DE5;&#x89E6;&#x53D1;">4.&#x624B;&#x5DE5;&#x89E6;&#x53D1; <a href="#t234.&#x624B;&#x5DE5;&#x89E6;&#x53D1;"> # </a></h2>
<ul>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-request/basic#%E6%89%8B%E5%8A%A8%E8%A7%A6%E5%8F%91">&#x624B;&#x5DE5;&#x89E6;&#x53D1;</a></li>
<li>&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86; <code>options.manual = true</code>&#xFF0C;&#x5219; <code>useRequest</code> &#x4E0D;&#x4F1A;&#x9ED8;&#x8BA4;&#x6267;&#x884C;&#xFF0C;&#x9700;&#x8981;&#x901A;&#x8FC7; <code>run</code> &#x6216;&#x8005; <code>runAsync</code> &#x6765;&#x89E6;&#x53D1;&#x6267;&#x884C;</li>
<li><code>run</code> &#x4E0E; <code>runAsync</code> &#x7684;&#x533A;&#x522B;&#x5728;&#x4E8E;&#xFF1A;<ul>
<li>run &#x662F;&#x4E00;&#x4E2A;&#x666E;&#x901A;&#x7684;&#x540C;&#x6B65;&#x51FD;&#x6570;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x81EA;&#x52A8;&#x6355;&#x83B7;&#x5F02;&#x5E38;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>options.onError</code> &#x6765;&#x5904;&#x7406;&#x5F02;&#x5E38;&#x65F6;&#x7684;&#x884C;&#x4E3A;</li>
<li>runAsync &#x662F;&#x4E00;&#x4E2A;&#x8FD4;&#x56DE; Promise &#x7684;&#x5F02;&#x6B65;&#x51FD;&#x6570;&#xFF0C;&#x5982;&#x679C;&#x4F7F;&#x7528; <code>runAsync</code> &#x6765;&#x8C03;&#x7528;&#xFF0C;&#x5219;&#x610F;&#x5473;&#x7740;&#x4F60;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x6355;&#x83B7;&#x5F02;&#x5E38;</li>
</ul>
</li>
</ul>
<h3 id="t244.1 src\App.js">4.1 src\App.js <a href="#t244.1 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import { useRequest } from &apos;./ahooks&apos;;
import React from &apos;react&apos;;

function getName() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      //resolve(&apos;zhufeng&apos;);
      reject(new Error(&apos;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;&apos;));
    }, 1000);
  });
}

function App() {
<span class="hljs-addition">+ const { data, loading, error, run, runAsync } = useRequest(getName, {</span>
<span class="hljs-addition">+   manual: true,</span>
<span class="hljs-addition">+   /* onError(error) {</span>
<span class="hljs-addition">+     console.error(&apos;onError&apos;, error);</span>
<span class="hljs-addition">+   } */</span>
<span class="hljs-addition">+ });</span>
<span class="hljs-addition">+ return (</span>
<span class="hljs-addition">+   &lt;&gt;</span>
<span class="hljs-addition">+     &lt;button disabled={loading} onClick={run}&gt;</span>
<span class="hljs-addition">+       {loading ? &apos;&#x83B7;&#x53D6;&#x4E2D;......&apos; : &apos;run&apos;}</span>
<span class="hljs-addition">+     &lt;/button&gt;</span>
<span class="hljs-addition">+     &lt;button disabled={loading} onClick={runAsync}&gt;</span>
<span class="hljs-addition">+       {loading ? &apos;&#x83B7;&#x53D6;&#x4E2D;......&apos; : &apos;runAsync&apos;}</span>
<span class="hljs-addition">+     &lt;/button&gt;</span>
<span class="hljs-addition">+     {data &amp;&amp; &lt;div&gt;&#x7528;&#x6237;&#x540D;: {data}&lt;/div&gt;}</span>
<span class="hljs-addition">+   &lt;/&gt;</span>
  )
};
export default App;
</code></pre>
<h3 id="t254.2 useRequest.js">4.2 useRequest.js <a href="#t254.2 useRequest.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequest.js</p>
<pre><code class="lang-diff">import useRequestImplement from &apos;./useRequestImplement&apos;;
<span class="hljs-addition">+function useRequest(service, options = {}) {</span>
<span class="hljs-addition">+ return useRequestImplement(service, options);</span>
}
export default useRequest;
</code></pre>
<h3 id="t264.3 useRequestImplement.js">4.3 useRequestImplement.js <a href="#t264.3 useRequestImplement.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequestImplement.js</p>
<pre><code class="lang-diff">import useCreation from &apos;../../useCreation&apos;;
import useLatest from &apos;../../useLatest&apos;;
import useMount from &apos;../../useMount&apos;;
import useUpdate from &apos;../../useUpdate&apos;;
import Fetch from &apos;./Fetch&apos;;
<span class="hljs-addition">+import useMemoizedFn from &apos;../../useMemoizedFn&apos;;</span>
function useRequestImplement(service, options = {}) {
<span class="hljs-addition">+ const { manual = false, ...rest } = options;</span>
<span class="hljs-addition">+ const fetchOptions = { manual, ...rest };</span>
  const serviceRef = useLatest(service);
  const update = useUpdate();
  const fetchInstance = useCreation(() =&gt; {
<span class="hljs-addition">+    return new Fetch(serviceRef, fetchOptions, update);</span>
  }, []);
  useMount(() =&gt; {
<span class="hljs-addition">+   if (!manual) {</span>
      fetchInstance.run();
<span class="hljs-addition">+   }</span>
  });
  return {
    loading: fetchInstance.state.loading,
    data: fetchInstance.state.data,
    error: fetchInstance.state.error,
<span class="hljs-addition">+   run: useMemoizedFn(fetchInstance.run.bind(fetchInstance)),</span>
<span class="hljs-addition">+   runAsync: useMemoizedFn(fetchInstance.runAsync.bind(fetchInstance))</span>
  };
}
export default useRequestImplement;
</code></pre>
<h3 id="t274.4 useMemoizedFn\index.js">4.4 useMemoizedFn\index.js <a href="#t274.4 useMemoizedFn\index.js"> # </a></h3>
<ul>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-memoized-fn">useMemoizedFn</a>&#x662F;&#x6301;&#x4E45;&#x5316; function &#x7684; Hook&#xFF0C;&#x7406;&#x8BBA;&#x4E0A;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; useMemoizedFn &#x5B8C;&#x5168;&#x4EE3;&#x66FF; useCallback</li>
</ul>
<p>src\ahooks\useMemoizedFn\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useMemo, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useMemoizedFn</span>(<span class="hljs-params">fn</span>) </span>{
  <span class="hljs-keyword">const</span> fnRef = useRef(fn);
  fnRef.current = useMemo(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> fn, [fn]);
  <span class="hljs-keyword">const</span> memoizedFn = useRef();
  <span class="hljs-keyword">if</span> (!memoizedFn.current) {
    memoizedFn.current = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) </span>{
      <span class="hljs-keyword">return</span> fnRef.current.apply(<span class="hljs-keyword">this</span>, args);
    };
  }
  <span class="hljs-keyword">return</span> memoizedFn.current;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useMemoizedFn;
</code></pre>
<h3 id="t284.5 Fetch.js">4.5 Fetch.js <a href="#t284.5 Fetch.js"> # </a></h3>
<p>src\ahooks\useRequest\src\Fetch.js</p>
<pre><code class="lang-diff">class Fetch {
<span class="hljs-addition">+ constructor(serviceRef, options, subscribe) {</span>
    this.serviceRef = serviceRef;
<span class="hljs-addition">+   this.options = options;</span>
    this.subscribe = subscribe;
    this.state = { loading: false, data: undefined, error: undefined };
  }
  setState = (s = {}) =&gt; {
    this.state = { ...this.state, ...s };
    this.subscribe();
  }
  runAsync = async () =&gt; {
    this.setState({ loading: true });
    try {
      const res = await this.serviceRef.current();
      this.setState({ loading: false, data: res, error: undefined });
    } catch (error) {
      this.setState({ loading: false, error });
<span class="hljs-addition">+     this.options.onError?.(error);</span>
<span class="hljs-addition">+     throw error;</span>
    }
  }
  run = () =&gt; {
<span class="hljs-addition">+   this.runAsync().catch(error =&gt; {</span>
<span class="hljs-addition">+     if (!this.options.onError) {</span>
<span class="hljs-addition">+       console.error(error);</span>
<span class="hljs-addition">+     }</span>
<span class="hljs-addition">+   });</span>
  }
}
export default Fetch;
</code></pre>
<h2 id="t295.&#x4F20;&#x9012;&#x53C2;&#x6570;">5.&#x4F20;&#x9012;&#x53C2;&#x6570; <a href="#t295.&#x4F20;&#x9012;&#x53C2;&#x6570;"> # </a></h2>
<h3 id="t305.1 src\App.js">5.1 src\App.js <a href="#t305.1 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import { useRequest } from &apos;./ahooks&apos;;
import React from &apos;react&apos;;

<span class="hljs-addition">+function getName(xing) {</span>
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
<span class="hljs-addition">+     resolve(xing + &apos;&#x4E09;&apos;);</span>
      //reject(new Error(&apos;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;&apos;));
    }, 1000);
  });
}

function App() {
  const { data, loading, error, run, runAsync } = useRequest(getName, {
    manual: false,
    defaultParams: [&apos;&#x5F20;&apos;]
    /* onError(error) {
      console.error(&apos;onError&apos;, error);
    } */
  });
  return (
    &lt;&gt;
<span class="hljs-addition">+     &lt;button disabled={loading} onClick={() =&gt; run(&apos;&#x8D75;&apos;)}&gt;</span>
        {loading ? &apos;&#x83B7;&#x53D6;&#x4E2D;......&apos; : &apos;run&apos;}
      &lt;/button&gt;
<span class="hljs-addition">+     &lt;button disabled={loading} onClick={() =&gt; runAsync(&apos;&#x94B1;&apos;)}&gt;</span>
        {loading ? &apos;&#x83B7;&#x53D6;&#x4E2D;......&apos; : &apos;runAsync&apos;}
      &lt;/button&gt;
      {data &amp;&amp; &lt;div&gt;&#x7528;&#x6237;&#x540D;: {data}&lt;/div&gt;}
    &lt;/&gt;
  )
};
export default App;
</code></pre>
<h3 id="t315.2 useRequestImplement.js">5.2 useRequestImplement.js <a href="#t315.2 useRequestImplement.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequestImplement.js</p>
<pre><code class="lang-diff">import useCreation from &apos;../../useCreation&apos;;
import useLatest from &apos;../../useLatest&apos;;
import useMount from &apos;../../useMount&apos;;
import useUpdate from &apos;../../useUpdate&apos;;
import Fetch from &apos;./Fetch&apos;;
import useMemoizedFn from &apos;../../useMemoizedFn&apos;;
function useRequestImplement(service, options = {}) {
  const { manual = false, ...rest } = options;
  const fetchOptions = { manual, ...rest };
  const serviceRef = useLatest(service);
  const update = useUpdate();
  const fetchInstance = useCreation(() =&gt; {
    return new Fetch(serviceRef, fetchOptions, update);
  }, []);
  useMount(() =&gt; {
    if (!manual) {
<span class="hljs-addition">+     const params = fetchInstance.state.params || options.defaultParams || [];</span>
<span class="hljs-addition">+     fetchInstance.run(...params);</span>
    }
  });
  return {
    loading: fetchInstance.state.loading,
    data: fetchInstance.state.data,
    error: fetchInstance.state.error,
    run: useMemoizedFn(fetchInstance.run.bind(fetchInstance)),
    runAsync: useMemoizedFn(fetchInstance.runAsync.bind(fetchInstance))
  };
}

export default useRequestImplement;
</code></pre>
<h3 id="t325.3 Fetch.js">5.3 Fetch.js <a href="#t325.3 Fetch.js"> # </a></h3>
<p>src\ahooks\useRequest\src\Fetch.js</p>
<pre><code class="lang-diff">class Fetch {
  constructor(serviceRef, options, subscribe) {
    this.serviceRef = serviceRef;
    this.options = options;
    this.subscribe = subscribe;
<span class="hljs-addition">+   this.state = { loading: false, data: undefined, error: undefined, params: undefined };</span>
  }
  setState = (s = {}) =&gt; {
    this.state = { ...this.state, ...s };
    this.subscribe();
  }
<span class="hljs-addition">+ runAsync = async (...params) =&gt; {</span>
<span class="hljs-addition">+   this.setState({ loading: true, params });</span>
    try {
<span class="hljs-addition">+     const res = await this.serviceRef.current(...params);</span>
<span class="hljs-addition">+     this.setState({ loading: false, data: res, error: undefined, params });</span>
    } catch (error) {
<span class="hljs-addition">+     this.setState({ loading: false, error, params });</span>
<span class="hljs-addition">+     this.options.onError?.(error, params);</span>
      throw error;
    }
  }
<span class="hljs-addition">+ run = (...params) =&gt; {</span>
<span class="hljs-addition">+   this.runAsync(...params).catch(error =&gt; {</span>
      if (!this.options.onError) {
        console.error(error);
      }
    });
  }
}
export default Fetch;
</code></pre>
<h2 id="t336.&#x751F;&#x547D;&#x5468;&#x671F;">6.&#x751F;&#x547D;&#x5468;&#x671F; <a href="#t336.&#x751F;&#x547D;&#x5468;&#x671F;"> # </a></h2>
<ul>
<li>useRequest &#x63D0;&#x4F9B;&#x4E86;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x751F;&#x547D;&#x5468;&#x671F;&#x914D;&#x7F6E;&#x9879;&#xFF0C;&#x4F9B;&#x4F60;&#x5728;&#x5F02;&#x6B65;&#x51FD;&#x6570;&#x7684;&#x4E0D;&#x540C;&#x9636;&#x6BB5;&#x505A;&#x4E00;&#x4E9B;&#x5904;&#x7406;<ul>
<li><code>onBefore</code>&#xFF1A;&#x8BF7;&#x6C42;&#x4E4B;&#x524D;&#x89E6;&#x53D1;</li>
<li><code>onSuccess</code>&#xFF1A;&#x8BF7;&#x6C42;&#x6210;&#x529F;&#x89E6;&#x53D1;</li>
<li><code>onError</code>&#xFF1A;&#x8BF7;&#x6C42;&#x5931;&#x8D25;&#x89E6;&#x53D1;</li>
<li><code>onFinally</code>&#xFF1A;&#x8BF7;&#x6C42;&#x5B8C;&#x6210;&#x89E6;&#x53D1;</li>
</ul>
</li>
</ul>
<h3 id="t346.1 src\App.js">6.1 src\App.js <a href="#t346.1 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState } from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
<span class="hljs-addition">+let success = true;</span>
function getName(userId) {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
<span class="hljs-addition">+     if (success) {</span>
<span class="hljs-addition">+       resolve(`name${userId}`);</span>
<span class="hljs-addition">+     } else {</span>
<span class="hljs-addition">+       reject(new Error(&apos;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;&apos;));</span>
<span class="hljs-addition">+     }</span>
      success = !success;
    }, 1000);
  });
}
<span class="hljs-addition">+const initialUserId = &apos;1&apos;;</span>
function App() {
<span class="hljs-addition">+ const [userId, setUserId] = useState(initialUserId);</span>
  const { data, loading, error, run, runAsync } = useRequest(getName, {
    manual: false,
<span class="hljs-addition">+   defaultParams: [initialUserId],</span>
<span class="hljs-addition">+   onBefore: (params) =&gt; {</span>
<span class="hljs-addition">+     console.info(`&#x5F00;&#x59CB;&#x8BF7;&#x6C42;: ${params[0]}`);</span>
<span class="hljs-addition">+   },</span>
<span class="hljs-addition">+   onSuccess: (result, params) =&gt; {</span>
<span class="hljs-addition">+     console.info(`&#x8BF7;&#x6C42;&#x6210;&#x529F;:&#x83B7;&#x53D6;${params[0]}&#x5BF9;&#x5E94;&#x7684;&#x7528;&#x6237;&#x540D;&#x6210;&#x529F;:${result}&quot;!`);</span>
<span class="hljs-addition">+   },</span>
<span class="hljs-addition">+   onError: (error) =&gt; {</span>
<span class="hljs-addition">+     console.error(`&#x8BF7;&#x6C42;&#x5931;&#x8D25;:${error.message}&quot;!`);</span>
<span class="hljs-addition">+   },</span>
<span class="hljs-addition">+   onFinally: (params, result, error) =&gt; {</span>
<span class="hljs-addition">+     console.info(`&#x8BF7;&#x6C42;&#x5B8C;&#x6210;`);</span>
<span class="hljs-addition">+   },</span>
  });
  return (
    &lt;&gt;
<span class="hljs-addition">+     &lt;input</span>
<span class="hljs-addition">+       onChange={(event) =&gt; setUserId(event.target.value)}</span>
<span class="hljs-addition">+       value={userId}</span>
<span class="hljs-addition">+       placeholder=&quot;&#x8BF7;&#x8F93;&#x5165;&#x7528;&#x6237;ID&quot;</span>
<span class="hljs-addition">+     /&gt;</span>
<span class="hljs-addition">+     &lt;button disabled={loading} onClick={() =&gt; run(userId)}&gt;</span>
        {loading ? &apos;&#x83B7;&#x53D6;&#x4E2D;......&apos; : &apos;run&apos;}
      &lt;/button&gt;
      {data &amp;&amp; &lt;div&gt;&#x7528;&#x6237;&#x540D;: {data}&lt;/div&gt;}
    &lt;/&gt;
  )
};
export default App;
</code></pre>
<h3 id="t356.2 Fetch.js">6.2 Fetch.js <a href="#t356.2 Fetch.js"> # </a></h3>
<p>src\ahooks\useRequest\src\Fetch.js</p>
<pre><code class="lang-diff">class Fetch {
  constructor(serviceRef, options, subscribe) {
    this.serviceRef = serviceRef;
    this.options = options;
    this.subscribe = subscribe;
    this.state = { loading: false, data: undefined, error: undefined, params: undefined };
  }
  setState = (s = {}) =&gt; {
    this.state = { ...this.state, ...s };
    this.subscribe();
  }
  runAsync = async (...params) =&gt; {
    this.setState({ loading: true, params });
<span class="hljs-addition">+   this.options.onBefore?.(params);</span>
    try {
      const res = await this.serviceRef.current(...params);
      this.setState({ loading: false, data: res, error: undefined, params });
<span class="hljs-addition">+     this.options.onSuccess?.(res, params);</span>
<span class="hljs-addition">+     this.options.onFinally?.(params, res, undefined);</span>
    } catch (error) {
      this.setState({ loading: false, error, params });
<span class="hljs-addition">+     this.options.onError?.(error, params);</span>
<span class="hljs-addition">+     this.options.onFinally?.(params, undefined, error);</span>
      throw error;
    }
  }
  run = (...params) =&gt; {
    this.runAsync(...params).catch(error =&gt; {
      if (!this.options.onError) {
        console.error(error);
      }
    });
  }
}
export default Fetch;
</code></pre>
<h2 id="t367.&#x5237;&#x65B0;(&#x91CD;&#x590D;&#x4E0A;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;)">7.&#x5237;&#x65B0;(&#x91CD;&#x590D;&#x4E0A;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;) <a href="#t367.&#x5237;&#x65B0;(&#x91CD;&#x590D;&#x4E0A;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;)"> # </a></h2>
<ul>
<li><code>useRequest</code> &#x63D0;&#x4F9B;&#x4E86; <code>refresh</code> &#x548C; <code>refreshAsync</code> &#x65B9;&#x6CD5;&#xFF0C;&#x4F7F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4E0A;&#x4E00;&#x6B21;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x91CD;&#x65B0;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;</li>
</ul>
<h3 id="t377.1 src\App.js">7.1 src\App.js <a href="#t377.1 src\App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState } from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
let success = true;
function getName(userId) {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      if (success) {
        resolve(`name${userId}`);
      } else {
        reject(new Error(&apos;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;&apos;));
      }
      success = !success;
    }, 1000);
  });
}
const initialUserId = &apos;1&apos;;
function App() {
  const [userId, setUserId] = useState(initialUserId);
<span class="hljs-addition">+ const { data, loading, error, run, runAsync, refresh, refreshAsync } = useRequest(getName, {</span>
    manual: false,
    defaultParams: [initialUserId],
    onBefore: (params) =&gt; {
      console.info(`&#x5F00;&#x59CB;&#x8BF7;&#x6C42;: ${params[0]}`);
    },
    onSuccess: (result, params) =&gt; {
      console.info(`&#x8BF7;&#x6C42;&#x6210;&#x529F;:&#x83B7;&#x53D6;${params[0]}&#x5BF9;&#x5E94;&#x7684;&#x7528;&#x6237;&#x540D;&#x6210;&#x529F;:${result}&quot;!`);
    },
    onError: (error) =&gt; {
      console.error(`&#x8BF7;&#x6C42;&#x5931;&#x8D25;:${error.message}&quot;!`);
    },
    onFinally: (params, result, error) =&gt; {
      console.info(`&#x8BF7;&#x6C42;&#x5B8C;&#x6210;`);
    },
  });
  return (
    &lt;&gt;
      &lt;input
        onChange={(event) =&gt; setUserId(event.target.value)}
        value={userId}
        placeholder=&quot;&#x8BF7;&#x8F93;&#x5165;&#x7528;&#x6237;ID&quot;
      /&gt;
      &lt;button disabled={loading} onClick={() =&gt; run(userId)}&gt;
        {loading ? &apos;&#x83B7;&#x53D6;&#x4E2D;......&apos; : &apos;run&apos;}
      &lt;/button&gt;
<span class="hljs-addition">+     &lt;button onClick={refresh} &gt;</span>
<span class="hljs-addition">+       refresh</span>
<span class="hljs-addition">+     &lt;/button&gt;</span>
<span class="hljs-addition">+     &lt;button onClick={refreshAsync} &gt;</span>
<span class="hljs-addition">+       refreshAsync</span>
<span class="hljs-addition">+     &lt;/button&gt;</span>
      {data &amp;&amp; &lt;div&gt;&#x7528;&#x6237;&#x540D;: {data}&lt;/div&gt;}
    &lt;/&gt;
  )
};
export default App;
</code></pre>
<h3 id="t387.2 useRequestImplement.js">7.2 useRequestImplement.js <a href="#t387.2 useRequestImplement.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequestImplement.js</p>
<pre><code class="lang-diff">import useCreation from &apos;../../useCreation&apos;;
import useLatest from &apos;../../useLatest&apos;;
import useMount from &apos;../../useMount&apos;;
import useUpdate from &apos;../../useUpdate&apos;;
import Fetch from &apos;./Fetch&apos;;
import useMemoizedFn from &apos;../../useMemoizedFn&apos;;
function useRequestImplement(service, options = {}) {
  const { manual = false, ...rest } = options;
  const fetchOptions = { manual, ...rest };
  const serviceRef = useLatest(service);
  const update = useUpdate();
  const fetchInstance = useCreation(() =&gt; {
    return new Fetch(serviceRef, fetchOptions, update);
  }, []);
  useMount(() =&gt; {
    if (!manual) {
      const params = fetchInstance.state.params || options.defaultParams || [];
      fetchInstance.run(...params);
    }
  });
  return {
    loading: fetchInstance.state.loading,
    data: fetchInstance.state.data,
    error: fetchInstance.state.error,
    run: useMemoizedFn(fetchInstance.run.bind(fetchInstance)),
    runAsync: useMemoizedFn(fetchInstance.runAsync.bind(fetchInstance)),
<span class="hljs-addition">+   refresh: useMemoizedFn(fetchInstance.refresh.bind(fetchInstance)),</span>
<span class="hljs-addition">+   refreshAsync: useMemoizedFn(fetchInstance.refreshAsync.bind(fetchInstance))</span>
  };
}
export default useRequestImplement;
</code></pre>
<h3 id="t397.3 Fetch.js">7.3 Fetch.js <a href="#t397.3 Fetch.js"> # </a></h3>
<p>src\ahooks\useRequest\src\Fetch.js</p>
<pre><code class="lang-diff">class Fetch {
  constructor(serviceRef, options, subscribe) {
    this.serviceRef = serviceRef;
    this.options = options;
    this.subscribe = subscribe;
    this.state = { loading: false, data: undefined, error: undefined, params: undefined };
  }
  setState = (s = {}) =&gt; {
    this.state = { ...this.state, ...s };
    this.subscribe();
  }
  runAsync = async (...params) =&gt; {
    this.setState({ loading: true, params });
    this.options.onBefore?.(params);
    try {
      const res = await this.serviceRef.current(...params);
      this.setState({ loading: false, data: res, error: undefined, params });
      this.options.onSuccess?.(res, params);
      this.options.onFinally?.(params, res, undefined);
    } catch (error) {
      this.setState({ loading: false, error, params });
      this.options.onError?.(error, params);
      this.options.onFinally?.(params, undefined, error);
      throw error;
    }
  }
  run = (...params) =&gt; {
    this.runAsync(...params).catch(error =&gt; {
      if (!this.options.onError) {
        console.error(error);
      }
    });
  }
<span class="hljs-addition">+ refresh() {</span>
<span class="hljs-addition">+   this.run(...(this.state.params || []));</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ refreshAsync() {</span>
<span class="hljs-addition">+   return this.runAsync(...(this.state.params || []));</span>
<span class="hljs-addition">+ }</span>
}
export default Fetch;
</code></pre>
<h2 id="t408.&#x7ACB;&#x5373;&#x53D8;&#x66F4;&#x6570;&#x636E;">8.&#x7ACB;&#x5373;&#x53D8;&#x66F4;&#x6570;&#x636E; <a href="#t408.&#x7ACB;&#x5373;&#x53D8;&#x66F4;&#x6570;&#x636E;"> # </a></h2>
<ul>
<li><code>useRequest</code> &#x63D0;&#x4F9B;&#x4E86;<code>mutate</code>, &#x652F;&#x6301;&#x7ACB;&#x5373;&#x4FEE;&#x6539;<code>useRequest</code>&#x8FD4;&#x56DE;&#x7684;<code>data</code>&#x53C2;&#x6570;</li>
<li><code>mutate</code>&#x7684;&#x7528;&#x6CD5;&#x4E0E;<code>React.setState</code>&#x4E00;&#x81F4;&#xFF0C;&#x652F;&#x6301;<code>mutate(newData)</code>&#x548C;<code>mutate((oldData) =&gt; newData)</code>&#x4E24;&#x79CD;&#x5199;&#x6CD5;</li>
</ul>
<h3 id="t418.1 App.js">8.1 App.js <a href="#t418.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState, useRef } from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
<span class="hljs-addition">+let success = true;</span>
<span class="hljs-addition">+function getName() {</span>
<span class="hljs-addition">+  return new Promise((resolve, reject) =&gt; {</span>
<span class="hljs-addition">+    setTimeout(() =&gt; {</span>
<span class="hljs-addition">+      if (success) {</span>
<span class="hljs-addition">+        resolve(`zhufeng`);</span>
<span class="hljs-addition">+      } else {</span>
<span class="hljs-addition">+        reject(new Error(&apos;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;&apos;));</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+      success = !success;</span>
<span class="hljs-addition">+    }, 1000);</span>
<span class="hljs-addition">+  });</span>
<span class="hljs-addition">+}</span>
<span class="hljs-addition">+let updateSuccess = true;</span>
<span class="hljs-addition">+function updateName(username) {</span>
<span class="hljs-addition">+  return new Promise((resolve, reject) =&gt; {</span>
<span class="hljs-addition">+    setTimeout(() =&gt; {</span>
<span class="hljs-addition">+      if (updateSuccess) {</span>
<span class="hljs-addition">+        resolve(username);</span>
<span class="hljs-addition">+      } else {</span>
<span class="hljs-addition">+        reject(new Error(`&#x4FEE;&#x6539;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;`));</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+      updateSuccess = !updateSuccess;</span>
<span class="hljs-addition">+    }, 1000);</span>
<span class="hljs-addition">+  });</span>
<span class="hljs-addition">+}</span>
function App() {
<span class="hljs-addition">+ const lastRef = useRef();</span>
<span class="hljs-addition">+ const [value, setValue] = useState(&quot;&quot;);</span>
<span class="hljs-addition">+ const { data: name, mutate } = useRequest(getName);</span>
<span class="hljs-addition">+ const { run, loading } = useRequest(updateName, {</span>
<span class="hljs-addition">+   manual: true,</span>
<span class="hljs-addition">+   onSuccess: (result, params) =&gt; {</span>
<span class="hljs-addition">+     setValue(&quot;&quot;);</span>
<span class="hljs-addition">+     console.log(`&#x7528;&#x6237;&#x540D;&#x6210;&#x529F;&#x53D8;&#x66F4;&#x4E3A; &quot;${params[0]}&quot; !`);</span>
<span class="hljs-addition">+   },</span>
<span class="hljs-addition">+   onError: (error, params) =&gt; {</span>
<span class="hljs-addition">+     console.error(error.message);</span>
<span class="hljs-addition">+     mutate(lastRef.current);</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+ });</span>
  return (
    &lt;&gt;
<span class="hljs-addition">+     {name &amp;&amp; &lt;div&gt;&#x7528;&#x6237;&#x540D;: {name}&lt;/div&gt;}</span>
<span class="hljs-addition">+     &lt;input</span>
<span class="hljs-addition">+       onChange={(event) =&gt; setValue(event.target.value)}</span>
<span class="hljs-addition">+       value={value}</span>
<span class="hljs-addition">+       placeholder=&quot;&#x8BF7;&#x8F93;&#x5165;&#x7528;&#x6237;&#x540D;&quot;</span>
<span class="hljs-addition">+     /&gt;</span>
<span class="hljs-addition">+     &lt;button onClick={() =&gt; {</span>
<span class="hljs-addition">+       lastRef.current = name;</span>
<span class="hljs-addition">+       mutate(value);</span>
<span class="hljs-addition">+       run(value);</span>
<span class="hljs-addition">+     }} type=&quot;button&quot;&gt;</span>
<span class="hljs-addition">+       {loading ? &quot;&#x66F4;&#x65B0;&#x4E2D;.......&quot; : &apos;&#x66F4;&#x65B0;&apos;}</span>
<span class="hljs-addition">+     &lt;/button&gt;</span>
    &lt;/&gt;
  )
};
export default App;
</code></pre>
<h3 id="t428.2 useRequestImplement.js">8.2 useRequestImplement.js <a href="#t428.2 useRequestImplement.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequestImplement.js</p>
<pre><code class="lang-diff">import useCreation from &apos;../../useCreation&apos;;
import useLatest from &apos;../../useLatest&apos;;
import useMount from &apos;../../useMount&apos;;
import useUpdate from &apos;../../useUpdate&apos;;
import Fetch from &apos;./Fetch&apos;;
import useMemoizedFn from &apos;../../useMemoizedFn&apos;;
function useRequestImplement(service, options = {}) {
  const { manual = false, ...rest } = options;
  const fetchOptions = { manual, ...rest };
  const serviceRef = useLatest(service);
  const update = useUpdate();
  const fetchInstance = useCreation(() =&gt; {
    return new Fetch(serviceRef, fetchOptions, update);
  }, []);
  useMount(() =&gt; {
    if (!manual) {
      const params = fetchInstance.state.params || options.defaultParams || [];
      fetchInstance.run(...params);
    }
  });
  return {
    loading: fetchInstance.state.loading,
    data: fetchInstance.state.data,
    error: fetchInstance.state.error,
    run: useMemoizedFn(fetchInstance.run.bind(fetchInstance)),
    runAsync: useMemoizedFn(fetchInstance.runAsync.bind(fetchInstance)),
    refresh: useMemoizedFn(fetchInstance.refresh.bind(fetchInstance)),
    refreshAsync: useMemoizedFn(fetchInstance.refreshAsync.bind(fetchInstance)),
<span class="hljs-addition">+   mutate: useMemoizedFn(fetchInstance.mutate.bind(fetchInstance))</span>
  };
}
export default useRequestImplement;
</code></pre>
<h3 id="t438.3 Fetch.js">8.3 Fetch.js <a href="#t438.3 Fetch.js"> # </a></h3>
<p>src\ahooks\useRequest\src\Fetch.js</p>
<pre><code class="lang-diff">import { isFunction } from &apos;../../utils&apos;;
class Fetch {
  constructor(serviceRef, options, subscribe) {
    this.serviceRef = serviceRef;
    this.options = options;
    this.subscribe = subscribe;
    this.state = { loading: false, data: undefined, error: undefined, params: undefined };
  }
  setState = (s = {}) =&gt; {
    this.state = { ...this.state, ...s };
    this.subscribe();
  }
  runAsync = async (...params) =&gt; {
    this.setState({ loading: true, params });
    this.options.onBefore?.(params);
    try {
      const res = await this.serviceRef.current(...params);
      this.setState({ loading: false, data: res, error: undefined, params });
      this.options.onSuccess?.(res, params);
      this.options.onFinally?.(params, res, undefined);
    } catch (error) {
      this.setState({ loading: false, error, params });
      this.options.onError?.(error, params);
      this.options.onFinally?.(params, undefined, error);
      throw error;
    }
  }
  run = (...params) =&gt; {
    this.runAsync(...params).catch(error =&gt; {
      if (!this.options.onError) {
        console.error(error);
      }
    });
  }
  refresh() {
    this.run(...(this.state.params || []));
  }

  refreshAsync() {
    return this.runAsync(...(this.state.params || []));
  }
<span class="hljs-addition">+  mutate(data) {</span>
<span class="hljs-addition">+    let targetData;</span>
<span class="hljs-addition">+    if (isFunction(data)) {</span>
<span class="hljs-addition">+      targetData = data(this.state.data);</span>
<span class="hljs-addition">+    } else {</span>
<span class="hljs-addition">+      targetData = data;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    this.setState({</span>
<span class="hljs-addition">+      data: targetData</span>
<span class="hljs-addition">+    });</span>
<span class="hljs-addition">+  }</span>
}
export default Fetch;
</code></pre>
<h3 id="t448.4 utils\index.js">8.4 utils\index.js <a href="#t448.4 utils\index.js"> # </a></h3>
<p>src\ahooks\utils\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> isFunction = <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">&apos;function&apos;</span>;
</code></pre>
<h2 id="t459.&#x53D6;&#x6D88;&#x8BF7;&#x6C42;">9.&#x53D6;&#x6D88;&#x8BF7;&#x6C42; <a href="#t459.&#x53D6;&#x6D88;&#x8BF7;&#x6C42;"> # </a></h2>
<ul>
<li>useRequest &#x63D0;&#x4F9B;&#x4E86; <code>cancel</code> &#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x53D6;&#x6D88;&#x5F53;&#x524D;&#x6B63;&#x5728;&#x8FDB;&#x884C;&#x7684;&#x8BF7;&#x6C42;&#x3002;&#x540C;&#x65F6; <code>useRequest</code> &#x4F1A;&#x5728;&#x4EE5;&#x4E0B;&#x65F6;&#x673A;&#x81EA;&#x52A8;&#x53D6;&#x6D88;&#x5F53;&#x524D;&#x8BF7;&#x6C42;&#xFF1A;<ul>
<li>&#x7EC4;&#x4EF6;&#x5378;&#x8F7D;&#x65F6;&#xFF0C;&#x53D6;&#x6D88;&#x6B63;&#x5728;&#x8FDB;&#x884C;&#x7684;&#x8BF7;&#x6C42;</li>
<li>&#x7ADE;&#x6001;&#x53D6;&#x6D88;&#xFF0C;&#x5F53;&#x4E0A;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;&#x8FD8;&#x6CA1;&#x8FD4;&#x56DE;&#x65F6;&#xFF0C;&#x53C8;&#x53D1;&#x8D77;&#x4E86;&#x4E0B;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;&#xFF0C;&#x5219;&#x4F1A;&#x53D6;&#x6D88;&#x4E0A;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;</li>
</ul>
</li>
</ul>
<h3 id="t469.1 App.js">9.1 App.js <a href="#t469.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState, useRef } from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
let success = true;
function getName() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      if (success) {
        resolve(`zhufeng`);
      } else {
        reject(new Error(&apos;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;&apos;));
      }
      success = !success;
    }, 1000);
  });
}
let updateSuccess = true;
function updateName(username) {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      if (updateSuccess) {
        resolve(username);
      } else {
        reject(new Error(`&#x4FEE;&#x6539;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;`));
      }
      updateSuccess = !updateSuccess;
<span class="hljs-addition">+   }, 3000);</span>
  });
}
function App() {
  const lastRef = useRef();
  const [value, setValue] = useState(&quot;&quot;);
  const { data: name, mutate } = useRequest(getName);
<span class="hljs-addition">+ const { run, loading, cancel } = useRequest(updateName, {</span>
    manual: true,
    onSuccess: (result, params) =&gt; {
      setValue(&quot;&quot;);
      console.log(`&#x7528;&#x6237;&#x540D;&#x6210;&#x529F;&#x53D8;&#x66F4;&#x4E3A; &quot;${params[0]}&quot; !`);
    },
    onError: (error, params) =&gt; {
      console.error(error.message);
      mutate(lastRef.current);
    },
<span class="hljs-addition">+   onCancel: () =&gt; {</span>
<span class="hljs-addition">+     mutate(lastRef.current);</span>
<span class="hljs-addition">+   }</span>
  });
  return (
    &lt;&gt;
      {name &amp;&amp; &lt;div&gt;&#x7528;&#x6237;&#x540D;: {name}&lt;/div&gt;}
      &lt;input
        onChange={(event) =&gt; setValue(event.target.value)}
        value={value}
        placeholder=&quot;&#x8BF7;&#x8F93;&#x5165;&#x7528;&#x6237;&#x540D;&quot;
      /&gt;
      &lt;button onClick={() =&gt; {
        lastRef.current = name;
        mutate(value);
        run(value);
      }} type=&quot;button&quot;&gt;
        {loading ? &quot;&#x66F4;&#x65B0;&#x4E2D;.......&quot; : &apos;&#x66F4;&#x65B0;&apos;}
      &lt;/button&gt;
<span class="hljs-addition">+     &lt;button type=&quot;button&quot; onClick={cancel}&gt;</span>
<span class="hljs-addition">+       &#x53D6;&#x6D88;</span>
<span class="hljs-addition">+     &lt;/button&gt;</span>
    &lt;/&gt;
  )
};
export default App;
</code></pre>
<h3 id="t479.2 useRequestImplement.js">9.2 useRequestImplement.js <a href="#t479.2 useRequestImplement.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequestImplement.js</p>
<pre><code class="lang-diff">import useCreation from &apos;../../useCreation&apos;;
import useLatest from &apos;../../useLatest&apos;;
import useMount from &apos;../../useMount&apos;;
import useUpdate from &apos;../../useUpdate&apos;;
import Fetch from &apos;./Fetch&apos;;
import useMemoizedFn from &apos;../../useMemoizedFn&apos;;
<span class="hljs-addition">+import useUnmount from &apos;../../useUnmount&apos;;</span>
function useRequestImplement(service, options = {}) {
  const { manual = false, ...rest } = options;
  const fetchOptions = { manual, ...rest };
  const serviceRef = useLatest(service);
  const update = useUpdate();
  const fetchInstance = useCreation(() =&gt; {
    return new Fetch(serviceRef, fetchOptions, update);
  }, []);
  useMount(() =&gt; {
    if (!manual) {
      const params = fetchInstance.state.params || options.defaultParams || [];
      fetchInstance.run(...params);
    }
  });
<span class="hljs-addition">+ useUnmount(() =&gt; {</span>
<span class="hljs-addition">+   fetchInstance.cancel();</span>
<span class="hljs-addition">+ });</span>
  return {
    loading: fetchInstance.state.loading,
    data: fetchInstance.state.data,
    error: fetchInstance.state.error,
    run: useMemoizedFn(fetchInstance.run.bind(fetchInstance)),
    runAsync: useMemoizedFn(fetchInstance.runAsync.bind(fetchInstance)),
    refresh: useMemoizedFn(fetchInstance.refresh.bind(fetchInstance)),
    refreshAsync: useMemoizedFn(fetchInstance.refreshAsync.bind(fetchInstance)),
    mutate: useMemoizedFn(fetchInstance.mutate.bind(fetchInstance)),
<span class="hljs-addition">+   cancel: useMemoizedFn(fetchInstance.cancel.bind(fetchInstance))</span>
  };
}
export default useRequestImplement;
</code></pre>
<h3 id="t489.3 Fetch.js">9.3 Fetch.js <a href="#t489.3 Fetch.js"> # </a></h3>
<p>src\ahooks\useRequest\src\Fetch.js</p>
<pre><code class="lang-diff">import { isFunction } from &apos;../../utils&apos;;
class Fetch {
<span class="hljs-addition">+ count = 0;</span>
  constructor(serviceRef, options, subscribe) {
    this.serviceRef = serviceRef;
    this.options = options;
    this.subscribe = subscribe;
    this.state = { loading: false, data: undefined, error: undefined, params: undefined };
  }
  setState = (s = {}) =&gt; {
    this.state = { ...this.state, ...s };
    this.subscribe();
  }
  runAsync = async (...params) =&gt; {
<span class="hljs-addition">+   this.count += 1;</span>
<span class="hljs-addition">+   const currentCount = this.count;</span>
    this.setState({ loading: true, params });
    this.options.onBefore?.(params);
    try {
      const res = await this.serviceRef.current(...params);
<span class="hljs-addition">+     if (currentCount !== this.count) {</span>
<span class="hljs-addition">+       return new Promise(() =&gt; { });</span>
<span class="hljs-addition">+     }</span>
      this.setState({ loading: false, data: res, error: undefined, params });
      this.options.onSuccess?.(res, params);
      this.options.onFinally?.(params, res, undefined);
    } catch (error) {
<span class="hljs-addition">+     if (currentCount !== this.count) {</span>
<span class="hljs-addition">+       return new Promise(() =&gt; { });</span>
<span class="hljs-addition">+     }</span>
      this.setState({ loading: false, error, params });
      this.options.onError?.(error, params);
      this.options.onFinally?.(params, undefined, error);
      throw error;
    }
  }
  run = (...params) =&gt; {
    this.runAsync(...params).catch(error =&gt; {
      if (!this.options.onError) {
        console.error(error);
      }
    });
  }
  refresh() {
    this.run(...(this.state.params || []));
  }

  refreshAsync() {
    return this.runAsync(...(this.state.params || []));
  }
  mutate(data) {
    let targetData;

    if (isFunction(data)) {
      targetData = data(this.state.data);
    } else {
      targetData = data;
    }

    this.setState({
      data: targetData
    });
  }
<span class="hljs-addition">+ cancel() {</span>
<span class="hljs-addition">+   this.count += 1;</span>
<span class="hljs-addition">+   this.setState({</span>
<span class="hljs-addition">+     loading: false</span>
<span class="hljs-addition">+   });</span>
<span class="hljs-addition">+   this.options.onCancel?.();</span>
<span class="hljs-addition">+ }</span>
}
export default Fetch;
</code></pre>
<h3 id="t499.4 useUnmount\index.js">9.4 useUnmount\index.js <a href="#t499.4 useUnmount\index.js"> # </a></h3>
<p>src\ahooks\useUnmount\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> useLatest <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;../useLatest&apos;</span>;
<span class="hljs-keyword">const</span> useUnmount = <span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> fnRef = useLatest(fn);
  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> fnRef.current(), []);
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useUnmount;
</code></pre>
<h2 id="t5010.&#x63D2;&#x4EF6;&#x7CFB;&#x7EDF;">10.&#x63D2;&#x4EF6;&#x7CFB;&#x7EDF; <a href="#t5010.&#x63D2;&#x4EF6;&#x7CFB;&#x7EDF;"> # </a></h2>
<ul>
<li>useRequest&#x901A;&#x8FC7;&#x63D2;&#x4EF6;&#x5F0F;&#x7EC4;&#x7EC7;&#x4EE3;&#x7801;&#xFF0C;&#x6838;&#x5FC3;&#x4EE3;&#x7801;&#x6781;&#x5176;&#x7B80;&#x5355;&#xFF0C;&#x6240;&#x6709;&#x9AD8;&#x7EA7;&#x529F;&#x80FD;&#x5747;&#x662F;&#x901A;&#x8FC7;&#x63D2;&#x4EF6;&#x5B9E;&#x73B0;</li>
<li>&#x5728;&#x8BF7;&#x6C42;&#x8FC7;&#x7A0B;&#x4E2D;&#x4F1A;&#x89E6;&#x53D1;&#x5404;&#x79CD;&#x5404;&#x6837;&#x7684;&#x4E8B;&#x4EF6;&#xFF0C;&#x53EF;&#x4EE5;&#x4E3A;&#x8FD9;&#x4E9B;&#x4E8B;&#x4EF6;&#x7F16;&#x5199;&#x94A9;&#x5B50;&#x51FD;&#x6570;&#xFF0C;&#x800C;&#x63D2;&#x4EF6;&#x5C31;&#x662F;&#x94A9;&#x5B50;&#x51FD;&#x6570;&#x7684;&#x96C6;&#x5408;</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">&#x94A9;&#x5B50;</th>
<th style="text-align:left">&#x8BF4;&#x660E;</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">onBefore</td>
<td style="text-align:left">&#x8BF7;&#x6C42;&#x524D;</td>
</tr>
<tr>
<td style="text-align:left">onRequest</td>
<td style="text-align:left">&#x8BF7;&#x6C42;&#x4E2D;</td>
</tr>
<tr>
<td style="text-align:left">onSuccess</td>
<td style="text-align:left">&#x8BF7;&#x6C42;&#x6210;&#x529F;</td>
</tr>
<tr>
<td style="text-align:left">onError</td>
<td style="text-align:left">&#x8BF7;&#x6C42;&#x5931;&#x8D25;</td>
</tr>
<tr>
<td style="text-align:left">onFinally</td>
<td style="text-align:left">&#x8BF7;&#x6C42;&#x7ED3;&#x675F;</td>
</tr>
<tr>
<td style="text-align:left">onCancel</td>
<td style="text-align:left">&#x8BF7;&#x6C42;&#x53D6;&#x6D88;</td>
</tr>
<tr>
<td style="text-align:left">onMutate</td>
<td style="text-align:left">&#x4FEE;&#x6539;&#x7ED3;&#x679C;&#x6570;&#x636E;</td>
</tr>
<tr>
<td style="text-align:left">onInit</td>
<td style="text-align:left">&#x521D;&#x59CB;&#x5316;&#x72B6;&#x6001;</td>
</tr>
</tbody>
</table>
<h3 id="t5110.1 App.js">10.1 App.js <a href="#t5110.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState, useRef } from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
let success = true;
function getName() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      if (success) {
        resolve(`zhufeng`);
      } else {
        reject(new Error(&apos;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;&apos;));
      }
      success = !success;
    }, 1000);
  });
}
let updateSuccess = true;
function updateName(username) {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      if (updateSuccess) {
        resolve(username);
      } else {
        reject(new Error(`&#x4FEE;&#x6539;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;`));
      }
      updateSuccess = !updateSuccess;
    }, 300);
  });
}
function App() {
  const lastRef = useRef();
  const [value, setValue] = useState(&quot;&quot;);
<span class="hljs-addition">+ const { data: name, mutate } = useRequest(getName, { name: &apos;getName&apos; });</span>
  const { run, loading, cancel } = useRequest(updateName, {
    manual: true,
<span class="hljs-addition">+   name: &apos;updateName&apos;,</span>
    onSuccess: (result, params) =&gt; {
      setValue(&quot;&quot;);
      console.log(`&#x7528;&#x6237;&#x540D;&#x6210;&#x529F;&#x53D8;&#x66F4;&#x4E3A; &quot;${params[0]}&quot; !`);
    },
    onError: (error, params) =&gt; {
      console.error(error.message);
      mutate(lastRef.current);
    },
    onCancel: () =&gt; {
      mutate(lastRef.current);
    }
  });
  return (
    &lt;&gt;
      {name &amp;&amp; &lt;div&gt;&#x7528;&#x6237;&#x540D;: {name}&lt;/div&gt;}
      &lt;input
        onChange={(event) =&gt; setValue(event.target.value)}
        value={value}
        placeholder=&quot;&#x8BF7;&#x8F93;&#x5165;&#x7528;&#x6237;&#x540D;&quot;
      /&gt;
      &lt;button onClick={() =&gt; {
        lastRef.current = name;
        mutate(value);
        run(value);
      }} type=&quot;button&quot;&gt;
        {loading ? &quot;&#x66F4;&#x65B0;&#x4E2D;.......&quot; : &apos;&#x66F4;&#x65B0;&apos;}
      &lt;/button&gt;
      &lt;button type=&quot;button&quot; onClick={cancel}&gt;
        &#x53D6;&#x6D88;
      &lt;/button&gt;
    &lt;/&gt;
  )
};
export default App;
</code></pre>
<h3 id="t5210.2 useRequest.js">10.2 useRequest.js <a href="#t5210.2 useRequest.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequest.js</p>
<pre><code class="lang-diff">import useRequestImplement from &apos;./useRequestImplement&apos;;
<span class="hljs-addition">+import useLoggerPlugin from &apos;./plugins/useLoggerPlugin&apos;;</span>
<span class="hljs-addition">+function useRequest(service, options = {}, plugins) {</span>
<span class="hljs-addition">+ return useRequestImplement(service, options, [...(plugins || []), useLoggerPlugin]);</span>
}
export default useRequest;
</code></pre>
<h3 id="t5310.3 useRequestImplement.js">10.3 useRequestImplement.js <a href="#t5310.3 useRequestImplement.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequestImplement.js</p>
<pre><code class="lang-diff">import useCreation from &apos;../../useCreation&apos;;
import useLatest from &apos;../../useLatest&apos;;
import useMount from &apos;../../useMount&apos;;
import useUpdate from &apos;../../useUpdate&apos;;
import Fetch from &apos;./Fetch&apos;;
import useMemoizedFn from &apos;../../useMemoizedFn&apos;;
import useUnmount from &apos;../../useUnmount&apos;;
<span class="hljs-addition">+function useRequestImplement(service, options = {}, plugins = []) {</span>
  const { manual = false, ...rest } = options;
  const fetchOptions = { manual, ...rest };
  const serviceRef = useLatest(service);
  const update = useUpdate();
  const fetchInstance = useCreation(() =&gt; {
<span class="hljs-addition">+   const initState = plugins.map(p =&gt; p?.onInit?.(fetchOptions)).filter(Boolean);</span>
<span class="hljs-addition">+   return new Fetch(serviceRef, fetchOptions, update, Object.assign({}, ...initState));</span>
  }, []);
<span class="hljs-addition">+ //fetchInstance.options = fetchOptions;</span>
<span class="hljs-addition">+ fetchInstance.pluginImpls = plugins.map(p =&gt; p(fetchInstance, fetchOptions));</span>
  useMount(() =&gt; {
    if (!manual) {
      const params = fetchInstance.state.params || options.defaultParams || [];
      fetchInstance.run(...params);
    }
  });
  useUnmount(() =&gt; {
    fetchInstance.cancel();
  });
  return {
    loading: fetchInstance.state.loading,
    data: fetchInstance.state.data,
    error: fetchInstance.state.error,
    run: useMemoizedFn(fetchInstance.run.bind(fetchInstance)),
    runAsync: useMemoizedFn(fetchInstance.runAsync.bind(fetchInstance)),
    refresh: useMemoizedFn(fetchInstance.refresh.bind(fetchInstance)),
    refreshAsync: useMemoizedFn(fetchInstance.refreshAsync.bind(fetchInstance)),
    mutate: useMemoizedFn(fetchInstance.mutate.bind(fetchInstance)),
    cancel: useMemoizedFn(fetchInstance.cancel.bind(fetchInstance))
  };
}
export default useRequestImplement;
</code></pre>
<h3 id="t5410.4 useLoggerPlugin.js">10.4 useLoggerPlugin.js <a href="#t5410.4 useLoggerPlugin.js"> # </a></h3>
<p>src\ahooks\useRequest\src\plugins\useLoggerPlugin.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> useLoggerPlugin = <span class="hljs-function">(<span class="hljs-params">fetchInstance, { name }</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">onBefore</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(name, <span class="hljs-string">&apos;onBefore&apos;</span>);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: name };
    },
    <span class="hljs-attr">onRequest</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(name, <span class="hljs-string">&apos;onRequest&apos;</span>);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">servicePromise</span>: <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-string">&apos;onRequest&#x8FD4;&#x56DE;&#x503C;&apos;</span>) };
    },
    <span class="hljs-attr">onSuccess</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(name, <span class="hljs-string">&apos;onSuccess&apos;</span>, fetchInstance.state.name, fetchInstance.state.id);
    },
    <span class="hljs-attr">onError</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(name, <span class="hljs-string">&apos;onError&apos;</span>);
    },
    <span class="hljs-attr">onFinally</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(name, <span class="hljs-string">&apos;onFinally&apos;</span>);
    },
    <span class="hljs-attr">onCancel</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(name, <span class="hljs-string">&apos;onCancel&apos;</span>);
    },
    <span class="hljs-attr">onMutate</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(name, <span class="hljs-string">&apos;onMutate&apos;</span>);
    },
  };
};
useLoggerPlugin.onInit = <span class="hljs-function">(<span class="hljs-params">{ name }</span>) =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(name, <span class="hljs-string">&apos;onInit&apos;</span>)
  <span class="hljs-keyword">return</span> { name };
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useLoggerPlugin;
</code></pre>
<h3 id="t5510.5 Fetch.js">10.5 Fetch.js <a href="#t5510.5 Fetch.js"> # </a></h3>
<p>src\ahooks\useRequest\src\Fetch.js</p>
<pre><code class="lang-diff">import { isFunction } from &apos;../../utils&apos;;
class Fetch {
  count = 0;
<span class="hljs-addition">+ constructor(serviceRef, options, subscribe, initState = {}) {</span>
    this.serviceRef = serviceRef;
    this.options = options;
    this.subscribe = subscribe;
<span class="hljs-addition">+   this.state = { loading: !options.manual, data: undefined, error: undefined, params: undefined, ...initState };</span>
  }
  setState = (s = {}) =&gt; {
    this.state = { ...this.state, ...s };
    this.subscribe();
  }
  runAsync = async (...params) =&gt; {
    this.count += 1;
    const currentCount = this.count;
<span class="hljs-addition">+   const { ...state } = this.runPluginHandler(&apos;onBefore&apos;, params);</span>
<span class="hljs-addition">+   this.setState({ loading: true, params, ...state });</span>
    this.options.onBefore?.(params);
    try {
<span class="hljs-addition">+     let { servicePromise } = this.runPluginHandler(&apos;onRequest&apos;, this.serviceRef.current, params);</span>
<span class="hljs-addition">+     if (!servicePromise) {</span>
<span class="hljs-addition">+       servicePromise = this.serviceRef.current(...params);</span>
<span class="hljs-addition">+     }</span>
<span class="hljs-addition">+     const res = await servicePromise;</span>
      if (currentCount !== this.count) {
        return new Promise(() =&gt; { });
      }
      this.setState({ loading: false, data: res, error: undefined, params });
      this.options.onSuccess?.(res, params);
<span class="hljs-addition">+     this.runPluginHandler(&apos;onSuccess&apos;, res, params);</span>
      this.options.onFinally?.(params, res, undefined);
<span class="hljs-addition">+     if (currentCount === this.count) {</span>
<span class="hljs-addition">+       this.runPluginHandler(&apos;onFinally&apos;, params, res, undefined);</span>
<span class="hljs-addition">+     }</span>
    } catch (error) {
      if (currentCount !== this.count) {
        return new Promise(() =&gt; { });
      }
      this.setState({ loading: false, error, params });
      this.options.onError?.(error, params);
<span class="hljs-addition">+     this.runPluginHandler(&apos;onError&apos;, error, params);</span>
      this.options.onFinally?.(params, undefined, error);
<span class="hljs-addition">+     if (currentCount === this.count) {</span>
<span class="hljs-addition">+       this.runPluginHandler(&apos;onFinally&apos;, params, undefined, error);</span>
<span class="hljs-addition">+     }</span>
      throw error;
    }
  }
  run = (...params) =&gt; {
    this.runAsync(...params).catch(error =&gt; {
      if (!this.options.onError) {
        console.error(error);
      }
    });
  }
  refresh() {
    this.run(...(this.state.params || []));
  }

  refreshAsync() {
    return this.runAsync(...(this.state.params || []));
  }
  mutate(data) {
    let targetData;
    if (isFunction(data)) {
      targetData = data(this.state.data);
    } else {
      targetData = data;
    }
<span class="hljs-addition">+   this.runPluginHandler(&apos;onMutate&apos;, targetData);</span>
    this.setState({
      data: targetData
    });
  }
  cancel() {
    this.count += 1;
    this.setState({
      loading: false
    });
    this.options.onCancel?.();
<span class="hljs-addition">+   this.runPluginHandler(&apos;onCancel&apos;);</span>
  }
<span class="hljs-addition">+ runPluginHandler(event, ...rest) {</span>
<span class="hljs-addition">+   const r = this.pluginImpls.map(i =&gt; i[event]?.(...rest)).filter(Boolean);</span>
<span class="hljs-addition">+   return Object.assign({}, ...r);</span>
<span class="hljs-addition">+ }</span>
}
export default Fetch;
</code></pre>
<h2 id="t5611.Loading Delay">11.Loading Delay <a href="#t5611.Loading Delay"> # </a></h2>
<ul>
<li>&#x901A;&#x8FC7;&#x8BBE;&#x7F6E; <code>options.loadingDelay</code>&#xFF0C;&#x53EF;&#x4EE5;&#x5EF6;&#x8FDF; <code>loading</code> &#x53D8;&#x6210; <code>true</code> &#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x6709;&#x6548;&#x9632;&#x6B62;&#x95EA;&#x70C1;</li>
</ul>
<h3 id="t5711.1 App.js">11.1 App.js <a href="#t5711.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState, useRef } from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
let success = true;
function getName() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      if (success) {
        resolve(`zhufeng`);
      } else {
        reject(new Error(&apos;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;&apos;));
      }
      success = !success;
    }, 0);
  });
}
let updateSuccess = true;
function updateName(username) {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      if (updateSuccess) {
        resolve(username);
      } else {
        reject(new Error(`&#x4FEE;&#x6539;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;`));
      }
      updateSuccess = !updateSuccess;
    }, 3000);
  });
}
function App() {
  const lastRef = useRef();
  const [value, setValue] = useState(&quot;&quot;);
  const { data: name, mutate } = useRequest(getName, { name: &apos;getName&apos; });
  const { run, loading, cancel } = useRequest(updateName, {
    manual: true,
    name: &apos;updateName&apos;,
<span class="hljs-addition">+   loadingDelay: 1000,</span>
    onSuccess: (result, params) =&gt; {
      setValue(&quot;&quot;);
      console.log(`&#x7528;&#x6237;&#x540D;&#x6210;&#x529F;&#x53D8;&#x66F4;&#x4E3A; &quot;${params[0]}&quot; !`);
    },
    onError: (error, params) =&gt; {
      console.error(error.message);
      mutate(lastRef.current);
    },
    onCancel: () =&gt; {
      mutate(lastRef.current);
    }
  });
  return (
    &lt;&gt;
      {name &amp;&amp; &lt;div&gt;&#x7528;&#x6237;&#x540D;: {name}&lt;/div&gt;}
      &lt;input
        onChange={(event) =&gt; setValue(event.target.value)}
        value={value}
        placeholder=&quot;&#x8BF7;&#x8F93;&#x5165;&#x7528;&#x6237;&#x540D;&quot;
      /&gt;
      &lt;button onClick={() =&gt; {
        lastRef.current = name;
        mutate(value);
        run(value);
      }} type=&quot;button&quot;&gt;
        {loading ? &quot;&#x66F4;&#x65B0;&#x4E2D;.......&quot; : &apos;&#x66F4;&#x65B0;&apos;}
      &lt;/button&gt;
      &lt;button type=&quot;button&quot; onClick={cancel}&gt;
        &#x53D6;&#x6D88;
      &lt;/button&gt;
    &lt;/&gt;
  )
};
export default App;
</code></pre>
<h3 id="t5811.2 useRequest.js">11.2 useRequest.js <a href="#t5811.2 useRequest.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequest.js</p>
<pre><code class="lang-diff">import useRequestImplement from &apos;./useRequestImplement&apos;;
<span class="hljs-addition">+import useLoadingDelayPlugin from &apos;./plugins/useLoadingDelayPlugin&apos;;</span>
function useRequest(service, options = {}, plugins) {
  return useRequestImplement(service, options, [...(plugins || []),
<span class="hljs-addition">+   useLoadingDelayPlugin</span>
  ]);
}
export default useRequest;
</code></pre>
<h3 id="t5911.3 useLoadingDelayPlugin.js">11.3 useLoadingDelayPlugin.js <a href="#t5911.3 useLoadingDelayPlugin.js"> # </a></h3>
<p>src\ahooks\useRequest\src\plugins\useLoadingDelayPlugin.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">const</span> useLoadingDelayPlugin = <span class="hljs-function">(<span class="hljs-params">fetchInstance, { loadingDelay }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> timerRef = useRef();
  <span class="hljs-keyword">if</span> (!loadingDelay) {
    <span class="hljs-keyword">return</span> {};
  }
  <span class="hljs-keyword">const</span> cancelTimeout = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (timerRef.current) {
      clearTimeout(timerRef.current);
    }
  };
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">onBefore</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      cancelTimeout();
      timerRef.current = setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        fetchInstance.setState({
          <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span>
        });
      }, loadingDelay);
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>
      };
    },
    <span class="hljs-attr">onFinally</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      cancelTimeout();
    },
    <span class="hljs-attr">onCancel</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      cancelTimeout();
    }
  };
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useLoadingDelayPlugin;
</code></pre>
<h2 id="t6012.&#x8F6E;&#x8BE2;">12.&#x8F6E;&#x8BE2; <a href="#t6012.&#x8F6E;&#x8BE2;"> # </a></h2>
<ul>
<li>&#x901A;&#x8FC7;&#x8BBE;&#x7F6E; <code>options.pollingInterval</code>&#xFF0C;&#x8FDB;&#x5165;&#x8F6E;&#x8BE2;&#x6A21;&#x5F0F;&#xFF0C;<code>useRequest</code> &#x4F1A;&#x5B9A;&#x65F6;&#x89E6;&#x53D1;<code>service</code> &#x6267;&#x884C;<h3 id="t6112.1 &#x8F6E;&#x8BE2;">12.1 &#x8F6E;&#x8BE2; <a href="#t6112.1 &#x8F6E;&#x8BE2;"> # </a></h3>
<h4 id="t6212.1.1 App.js">12.1.1 App.js <a href="#t6212.1.1 App.js"> # </a></h4>
src\App.js</li>
</ul>
<pre><code class="lang-diff">import React, { useState, useRef } from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
<span class="hljs-addition">+let counter = 0;</span>
function getName() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
<span class="hljs-addition">+     resolve(`zhufeng` + (++counter));</span>
    }, 0);
  });
}
let updateSuccess = true;
function updateName(username) {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      if (updateSuccess) {
        resolve(username);
      } else {
        reject(new Error(`&#x4FEE;&#x6539;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;`));
      }
      updateSuccess = !updateSuccess;
    }, 3000);
  });
}
function App() {
  const lastRef = useRef();
  const [value, setValue] = useState(&quot;&quot;);
  const { data: name, mutate } = useRequest(getName, {
    name: &apos;getName&apos;,
<span class="hljs-addition">+   pollingInterval: 1000</span>
  });
  const { run, loading, cancel } = useRequest(updateName, {
    manual: true,
    name: &apos;updateName&apos;,
    loadingDelay: 1000,
    onSuccess: (result, params) =&gt; {
      setValue(&quot;&quot;);
      console.log(`&#x7528;&#x6237;&#x540D;&#x6210;&#x529F;&#x53D8;&#x66F4;&#x4E3A; &quot;${params[0]}&quot; !`);
    },
    onError: (error, params) =&gt; {
      console.error(error.message);
      mutate(lastRef.current);
    },
    onCancel: () =&gt; {
      mutate(lastRef.current);
    }
  });
  console.log(loading);
  return (
    &lt;&gt;
      {name &amp;&amp; &lt;div&gt;&#x7528;&#x6237;&#x540D;: {name}&lt;/div&gt;}
      &lt;input
        onChange={(event) =&gt; setValue(event.target.value)}
        value={value}
        placeholder=&quot;&#x8BF7;&#x8F93;&#x5165;&#x7528;&#x6237;&#x540D;&quot;
      /&gt;
      &lt;button onClick={() =&gt; {
        lastRef.current = name;
        mutate(value);
        run(value);
      }} type=&quot;button&quot;&gt;
        {loading ? &quot;&#x66F4;&#x65B0;&#x4E2D;.......&quot; : &apos;&#x66F4;&#x65B0;&apos;}
      &lt;/button&gt;
      &lt;button type=&quot;button&quot; onClick={cancel}&gt;
        &#x53D6;&#x6D88;
      &lt;/button&gt;
    &lt;/&gt;
  )
};
export default App;
</code></pre>
<h4 id="t6312.1.2 useRequest.js">12.1.2 useRequest.js <a href="#t6312.1.2 useRequest.js"> # </a></h4>
<p>src\ahooks\useRequest\src\useRequest.js</p>
<pre><code class="lang-diff">import useRequestImplement from &apos;./useRequestImplement&apos;;
import useLoadingDelayPlugin from &apos;./plugins/useLoadingDelayPlugin&apos;;
<span class="hljs-addition">+import usePollingPlugin from &apos;./plugins/usePollingPlugin&apos;;</span>
function useRequest(service, options = {}, plugins) {
  return useRequestImplement(service, options, [...(plugins || []),
    useLoadingDelayPlugin,
<span class="hljs-addition">+   usePollingPlugin</span>
  ]);
}
export default useRequest;
</code></pre>
<h4 id="t6412.1.3 usePollingPlugin.js">12.1.3 usePollingPlugin.js <a href="#t6412.1.3 usePollingPlugin.js"> # </a></h4>
<p>src\ahooks\useRequest\src\plugins\usePollingPlugin.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> useUpdateEffect <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;../../../useUpdateEffect&apos;</span>;
<span class="hljs-keyword">const</span> usePollingPlugin = <span class="hljs-function">(<span class="hljs-params">fetchInstance, { pollingInterval }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> timerRef = useRef();
  <span class="hljs-keyword">const</span> stopPolling = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (timerRef.current) {
      clearTimeout(timerRef.current);
    }
  };

  useUpdateEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (!pollingInterval) {
      stopPolling();
    }
  }, [pollingInterval]);

  <span class="hljs-keyword">if</span> (!pollingInterval) {
    <span class="hljs-keyword">return</span> {};
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">onBefore</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      stopPolling();
    },
    <span class="hljs-attr">onFinally</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      timerRef.current = setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        fetchInstance.refresh();
      }, pollingInterval);
    },
    <span class="hljs-attr">onCancel</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      stopPolling();
    }
  };
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> usePollingPlugin;
</code></pre>
<h4 id="t6512.1.4 useUpdateEffect\index.js">12.1.4 useUpdateEffect\index.js <a href="#t6512.1.4 useUpdateEffect\index.js"> # </a></h4>
<p>src\ahooks\useUpdateEffect\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> { createUpdateEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;../createUpdateEffect&apos;</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> createUpdateEffect(useEffect);
</code></pre>
<h4 id="t6612.1.5 createUpdateEffect\index.js">12.1.5 createUpdateEffect\index.js <a href="#t6612.1.5 createUpdateEffect\index.js"> # </a></h4>
<p>src\ahooks\createUpdateEffect\index.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> createUpdateEffect = <span class="hljs-function"><span class="hljs-params">hook</span> =&gt;</span> <span class="hljs-function">(<span class="hljs-params">effect, deps</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> isMounted = useRef(<span class="hljs-literal">false</span>);
  hook(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      isMounted.current = <span class="hljs-literal">false</span>;
    };
  }, []);
  hook(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (!isMounted.current) {
      isMounted.current = <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> effect();
    }
  }, deps);
};
</code></pre>
<h3 id="t6712.2 &#x540E;&#x53F0;&#x8F6E;&#x8BE2;">12.2 &#x540E;&#x53F0;&#x8F6E;&#x8BE2; <a href="#t6712.2 &#x540E;&#x53F0;&#x8F6E;&#x8BE2;"> # </a></h3>
<h4 id="t6812.2.1 src\App.js">12.2.1 src\App.js <a href="#t6812.2.1 src\App.js"> # </a></h4>
<p>src\App.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> React, { useState, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> { useRequest } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./ahooks&apos;</span>;
<span class="hljs-keyword">let</span> counter = <span class="hljs-number">0</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getName</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      resolve(<span class="hljs-string">`zhufeng`</span> + (++counter));
    }, <span class="hljs-number">0</span>);
  });
}
<span class="hljs-keyword">let</span> updateSuccess = <span class="hljs-literal">true</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateName</span>(<span class="hljs-params">username</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (updateSuccess) {
        resolve(username);
      } <span class="hljs-keyword">else</span> {
        reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`&#x4FEE;&#x6539;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;`</span>));
      }
      updateSuccess = !updateSuccess;
    }, <span class="hljs-number">3000</span>);
  });
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">App</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> lastRef = useRef();
  <span class="hljs-keyword">const</span> [value, setValue] = useState(<span class="hljs-string">&quot;&quot;</span>);
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: name, mutate } = useRequest(getName, {
    <span class="hljs-attr">name</span>: <span class="hljs-string">&apos;getName&apos;</span>,
    <span class="hljs-attr">pollingInterval</span>: <span class="hljs-number">1000</span>,
+   pollingWhenHidden: <span class="hljs-literal">false</span>
  });
  <span class="hljs-keyword">const</span> { run, loading, cancel } = useRequest(updateName, {
    <span class="hljs-attr">manual</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">&apos;updateName&apos;</span>,
    <span class="hljs-attr">loadingDelay</span>: <span class="hljs-number">1000</span>,
    <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">result, params</span>) =&gt;</span> {
      setValue(<span class="hljs-string">&quot;&quot;</span>);
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`&#x7528;&#x6237;&#x540D;&#x6210;&#x529F;&#x53D8;&#x66F4;&#x4E3A; &quot;<span class="hljs-subst">${params[<span class="hljs-number">0</span>]}</span>&quot; !`</span>);
    },
    <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error, params</span>) =&gt;</span> {
      <span class="hljs-built_in">console</span>.error(error.message);
      mutate(lastRef.current);
    },
    <span class="hljs-attr">onCancel</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      mutate(lastRef.current);
    }
  });
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {name &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#x7528;&#x6237;&#x540D;: {name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(event)</span> =&gt;</span> setValue(event.target.value)}
        value={value}
        placeholder=&quot;&#x8BF7;&#x8F93;&#x5165;&#x7528;&#x6237;&#x540D;&quot;
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
        lastRef.current = name;
        mutate(value);
        run(value);
      }} type=&quot;button&quot;&gt;
        {loading ? &quot;&#x66F4;&#x65B0;&#x4E2D;.......&quot; : &apos;&#x66F4;&#x65B0;&apos;}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{cancel}</span>&gt;</span>
        &#x53D6;&#x6D88;
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
};
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> App;
</code></pre>
<h4 id="t6912.2.2 usePollingPlugin.js">12.2.2 usePollingPlugin.js <a href="#t6912.2.2 usePollingPlugin.js"> # </a></h4>
<p>src\ahooks\useRequest\src\plugins\usePollingPlugin.js</p>
<pre><code class="lang-diff">import { useRef } from &apos;react&apos;;
import useUpdateEffect from &apos;../../../useUpdateEffect&apos;;
<span class="hljs-addition">+import isDocumentVisible from &apos;../utils/isDocumentVisible&apos;;</span>
<span class="hljs-addition">+import subscribeReVisible from &apos;../utils/subscribeReVisible&apos;;</span>
<span class="hljs-addition">+const usePollingPlugin = (fetchInstance, { pollingInterval, pollingWhenHidden = true }) =&gt; {</span>
  const timerRef = useRef();
<span class="hljs-addition">+ const unsubscribeRef = useRef();</span>
  const stopPolling = () =&gt; {
    if (timerRef.current) {
      clearTimeout(timerRef.current);
    }
<span class="hljs-addition">+   unsubscribeRef.current?.();</span>
  };

  useUpdateEffect(() =&gt; {
    if (!pollingInterval) {
      stopPolling();
    }
  }, [pollingInterval]);

  if (!pollingInterval) {
    return {};
  }

  return {
    onBefore: () =&gt; {
      stopPolling();
    },
    onFinally: () =&gt; {
<span class="hljs-addition">+     if (!pollingWhenHidden &amp;&amp; !isDocumentVisible()) {</span>
<span class="hljs-addition">+       unsubscribeRef.current = subscribeReVisible(() =&gt; {</span>
<span class="hljs-addition">+         fetchInstance.refresh();</span>
<span class="hljs-addition">+       });</span>
<span class="hljs-addition">+       return;</span>
<span class="hljs-addition">+     }</span>
      timerRef.current = setTimeout(() =&gt; {
        fetchInstance.refresh();
      }, pollingInterval);
    },
    onCancel: () =&gt; {
      stopPolling();
    }
  };
};

export default usePollingPlugin;
</code></pre>
<h4 id="t7012.2.3 isDocumentVisible.js">12.2.3 isDocumentVisible.js <a href="#t7012.2.3 isDocumentVisible.js"> # </a></h4>
<p>src\ahooks\useRequest\src\utils\isDocumentVisible.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isDocumentVisible</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.visibilityState !== <span class="hljs-string">&apos;hidden&apos;</span>;
}
</code></pre>
<h4 id="t7112.2.4 subscribeReVisible.js">12.2.4 subscribeReVisible.js <a href="#t7112.2.4 subscribeReVisible.js"> # </a></h4>
<p>src\ahooks\useRequest\src\utils\subscribeReVisible.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> isDocumentVisible <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./isDocumentVisible&apos;</span>;
<span class="hljs-keyword">const</span> listeners = [];

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">subscribe</span>(<span class="hljs-params">listener</span>) </span>{
  listeners.push(listener);
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unsubscribe</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> index = listeners.indexOf(listener);
    listeners.splice(index, <span class="hljs-number">1</span>);
  };
}

<span class="hljs-keyword">const</span> revalidate = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (!isDocumentVisible()) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i++) {
    <span class="hljs-keyword">const</span> listener = listeners[i];
    listener();
  }
};

<span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">&apos;visibilitychange&apos;</span>, revalidate, <span class="hljs-literal">false</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> subscribe;
</code></pre>
<h2 id="t7213.Ready&#x548C;&#x548C;&#x4F9D;&#x8D56;&#x66F4;&#x65B0;">13.Ready&#x548C;&#x548C;&#x4F9D;&#x8D56;&#x66F4;&#x65B0; <a href="#t7213.Ready&#x548C;&#x548C;&#x4F9D;&#x8D56;&#x66F4;&#x65B0;"> # </a></h2>
<h3 id="t7313.1 &#x81EA;&#x52A8;&#x6A21;&#x5F0F;">13.1 &#x81EA;&#x52A8;&#x6A21;&#x5F0F; <a href="#t7313.1 &#x81EA;&#x52A8;&#x6A21;&#x5F0F;"> # </a></h3>
<h4 id="t7413.1.1 App.js">13.1.1 App.js <a href="#t7413.1.1 App.js"> # </a></h4>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState } from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
function getName() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
<span class="hljs-addition">+     resolve(`zhufeng`);</span>
    }, 1000);
  });
}
function App() {
<span class="hljs-addition">+ const [ready, setReady] = useState(false);</span>
<span class="hljs-addition">+ const { data: name, loading } = useRequest(getName, {</span>
<span class="hljs-addition">+   ready</span>
<span class="hljs-addition">+ });</span>
<span class="hljs-addition">+ return (</span>
<span class="hljs-addition">+   &lt;&gt;</span>
<span class="hljs-addition">+     &lt;p&gt;</span>
<span class="hljs-addition">+       Ready: {JSON.stringify(ready)}</span>
<span class="hljs-addition">+       &lt;button onClick={() =&gt; setReady(!ready)}&gt;</span>
<span class="hljs-addition">+         &#x5207;&#x6362;Ready</span>
<span class="hljs-addition">+       &lt;/button&gt;</span>
<span class="hljs-addition">+     &lt;/p&gt;</span>
<span class="hljs-addition">+     {loading ? &apos;&#x52A0;&#x8F7D;&#x4E2D;&apos; : name ? &lt;div&gt;&#x7528;&#x6237;&#x540D;: {name}&lt;/div&gt; : null}</span>
<span class="hljs-addition">+   &lt;/&gt;</span>
<span class="hljs-addition">+ );</span>
};
export default App;
</code></pre>
<h4 id="t7513.1.2 useRequest.js">13.1.2 useRequest.js <a href="#t7513.1.2 useRequest.js"> # </a></h4>
<p>src\ahooks\useRequest\src\useRequest.js</p>
<pre><code class="lang-diff">import useRequestImplement from &apos;./useRequestImplement&apos;;
import useLoadingDelayPlugin from &apos;./plugins/useLoadingDelayPlugin&apos;;
import usePollingPlugin from &apos;./plugins/usePollingPlugin&apos;;
<span class="hljs-addition">+import useAutoRunPlugin from &apos;./plugins/useAutoRunPlugin&apos;;</span>
function useRequest(service, options = {}, plugins) {
  return useRequestImplement(service, options, [...(plugins || []),
    useLoadingDelayPlugin,
    usePollingPlugin,
<span class="hljs-addition">+   useAutoRunPlugin</span>
  ]);
}
export default useRequest;
</code></pre>
<h4 id="t7613.1.3 useAutoRunPlugin.js">13.1.3 useAutoRunPlugin.js <a href="#t7613.1.3 useAutoRunPlugin.js"> # </a></h4>
<p>src\ahooks\useRequest\src\plugins\useAutoRunPlugin.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> useUpdateEffect <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;../../../useUpdateEffect&apos;</span>;
<span class="hljs-keyword">const</span> useAutoRunPlugin = <span class="hljs-function">(<span class="hljs-params">fetchInstance, { manual, ready = <span class="hljs-literal">true</span>, defaultParams = [] }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> hasAutoRun = useRef(<span class="hljs-literal">false</span>);
  hasAutoRun.current = <span class="hljs-literal">false</span>;
  useUpdateEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (!manual &amp;&amp; ready) {
      hasAutoRun.current = <span class="hljs-literal">true</span>;
      fetchInstance.run(...defaultParams);
    }
  }, [ready]);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">onBefore</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (!ready) {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">stopNow</span>: <span class="hljs-literal">true</span>
        };
      }
    }
  };
};

useAutoRunPlugin.onInit = ({
  ready = <span class="hljs-literal">true</span>,
  manual
}) =&gt; {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">loading</span>: !manual &amp;&amp; ready
  };
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useAutoRunPlugin;
</code></pre>
<h4 id="t7713.1.4 Fetch.js">13.1.4 Fetch.js <a href="#t7713.1.4 Fetch.js"> # </a></h4>
<p>src\ahooks\useRequest\src\Fetch.js</p>
<pre><code class="lang-diff">import { isFunction } from &apos;../../utils&apos;;
class Fetch {
  count = 0;
  constructor(serviceRef, options, subscribe, initState = {}) {
    this.serviceRef = serviceRef;
    this.options = options;
    this.subscribe = subscribe;
    this.state = { loading: !options.manual, data: undefined, error: undefined, params: undefined, ...initState };
  }
  setState = (s = {}) =&gt; {
    this.state = { ...this.state, ...s };
    this.subscribe();
  }
  runAsync = async (...params) =&gt; {
    this.count += 1;
    const currentCount = this.count;
<span class="hljs-addition">+   const { stopNow = false, ...state } = this.runPluginHandler(&apos;onBefore&apos;, params);</span>
<span class="hljs-addition">+   if (stopNow) {</span>
<span class="hljs-addition">+     return new Promise(() =&gt; { });</span>
<span class="hljs-addition">+   }</span>
    this.setState({ loading: true, params, ...state });
    this.options.onBefore?.(params);
    try {
      let { servicePromise } = this.runPluginHandler(&apos;onRequest&apos;, this.serviceRef.current, params);
      if (!servicePromise) {
        servicePromise = this.serviceRef.current(...params);
      }
      const res = await servicePromise;
      if (currentCount !== this.count) {
        return new Promise(() =&gt; { });
      }
      this.setState({ loading: false, data: res, error: undefined, params });
      this.options.onSuccess?.(res, params);
      this.runPluginHandler(&apos;onSuccess&apos;, res, params);
      this.options.onFinally?.(params, res, undefined);
      if (currentCount <span class="hljs-comment">=== this.count) {</span>
        this.runPluginHandler(&apos;onFinally&apos;, params, res, undefined);
      }
    } catch (error) {
      if (currentCount !== this.count) {
        return new Promise(() =&gt; { });
      }
      this.setState({ loading: false, error, params });
      this.options.onError?.(error, params);
      this.runPluginHandler(&apos;onError&apos;, error, params);
      this.options.onFinally?.(params, undefined, error);
      if (currentCount <span class="hljs-comment">=== this.count) {</span>
        this.runPluginHandler(&apos;onFinally&apos;, params, undefined, error);
      }
      throw error;
    }
  }
  run = (...params) =&gt; {
    this.runAsync(...params).catch(error =&gt; {
      if (!this.options.onError) {
        console.error(error);
      }
    });
  }
  refresh() {
    this.run(...(this.state.params || []));
  }

  refreshAsync() {
    return this.runAsync(...(this.state.params || []));
  }
  mutate(data) {
    let targetData;

    if (isFunction(data)) {
      targetData = data(this.state.data);
    } else {
      targetData = data;
    }
    this.runPluginHandler(&apos;onMutate&apos;, targetData);
    this.setState({
      data: targetData
    });
  }
  cancel() {
    this.count += 1;
    this.setState({
      loading: false
    });
    this.options.onCancel?.();
    this.runPluginHandler(&apos;onCancel&apos;);
  }
  runPluginHandler(event, ...rest) {
    const r = this.pluginImpls.map(i =&gt; i[event]?.(...rest)).filter(Boolean);
    return Object.assign({}, ...r);
  }
}
export default Fetch;
</code></pre>
<h3 id="t7813.2 &#x624B;&#x52A8;&#x6A21;&#x5F0F;">13.2 &#x624B;&#x52A8;&#x6A21;&#x5F0F; <a href="#t7813.2 &#x624B;&#x52A8;&#x6A21;&#x5F0F;"> # </a></h3>
<h4 id="t7913.2.1 App.js">13.2.1 App.js <a href="#t7913.2.1 App.js"> # </a></h4>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState } from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;

function getName() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      resolve(`zhufeng`);
    }, 1000);
  });
}
function App() {
  const [ready, setReady] = useState(false);
  const { data: name, loading, run } = useRequest(getName, {
<span class="hljs-addition">+   manual: true,</span>
    ready
  });
  return (
    &lt;&gt;
      &lt;p&gt;
        Ready: {JSON.stringify(ready)}
        &lt;button onClick={() =&gt; setReady(!ready)}&gt;
          &#x5207;&#x6362;Ready
        &lt;/button&gt;
      &lt;/p&gt;
<span class="hljs-addition">+     &lt;button type=&quot;button&quot; onClick={run}&gt;</span>
<span class="hljs-addition">+       run</span>
<span class="hljs-addition">+     &lt;/button&gt;</span>
      {loading ? &apos;&#x52A0;&#x8F7D;&#x4E2D;&apos; : name ? &lt;div&gt;&#x7528;&#x6237;&#x540D;: {name}&lt;/div&gt; : null}
    &lt;/&gt;
  );
};
export default App;
</code></pre>
<h3 id="t8013.3 &#x4F9D;&#x8D56;&#x66F4;&#x65B0;">13.3 &#x4F9D;&#x8D56;&#x66F4;&#x65B0; <a href="#t8013.3 &#x4F9D;&#x8D56;&#x66F4;&#x65B0;"> # </a></h3>
<ul>
<li>useRequest &#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A; <code>options.refreshDeps</code> &#x53C2;&#x6570;&#xFF0C;&#x5F53;&#x5B83;&#x7684;&#x503C;&#x53D8;&#x5316;&#x540E;&#xFF0C;&#x4F1A;&#x91CD;&#x65B0;&#x89E6;&#x53D1;&#x8BF7;&#x6C42;</li>
</ul>
<h4 id="t8113.3.1 App.js">13.3.1 App.js <a href="#t8113.3.1 App.js"> # </a></h4>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState } from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
<span class="hljs-addition">+let counter = 0;</span>
function getName() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
<span class="hljs-addition">+     resolve(`zhufeng` + (++counter));</span>
    }, 1000);
  });
}
function App() {
<span class="hljs-addition">+ const [userId, setUserId] = useState(&apos;1&apos;);</span>
<span class="hljs-addition">+ const { data: name, loading } = useRequest(getName, {</span>
<span class="hljs-addition">+   refreshDeps: [userId],</span>
<span class="hljs-addition">+   refreshDepsAction() {</span>
<span class="hljs-addition">+     console.log(&apos;refreshDepsAction&apos;);</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+ });</span>
  return (
    &lt;&gt;
<span class="hljs-addition">+     &lt;input value={userId} onChange={(event) =&gt; setUserId(event.target.value)} /&gt;</span>
      {loading ? &apos;&#x52A0;&#x8F7D;&#x4E2D;&apos; : name ? &lt;div&gt;&#x7528;&#x6237;&#x540D;: {name}&lt;/div&gt; : null}
    &lt;/&gt;
  );
};
export default App;
</code></pre>
<h4 id="t8213.3.2 useAutoRunPlugin.js">13.3.2 useAutoRunPlugin.js <a href="#t8213.3.2 useAutoRunPlugin.js"> # </a></h4>
<p>src\ahooks\useRequest\src\plugins\useAutoRunPlugin.js</p>
<pre><code class="lang-diff">import { useRef } from &apos;react&apos;;
import useUpdateEffect from &apos;../../../useUpdateEffect&apos;;
const useAutoRunPlugin = (fetchInstance, { manual, ready = true, defaultParams = [],
<span class="hljs-addition">+ refreshDeps = [],</span>
<span class="hljs-addition">+ refreshDepsAction</span>
}) =&gt; {
  const hasAutoRun = useRef(false);
  hasAutoRun.current = false;
  useUpdateEffect(() =&gt; {
    if (!manual &amp;&amp; ready) {
      hasAutoRun.current = true;
      fetchInstance.run(...defaultParams);
    }
  }, [ready]);
<span class="hljs-addition">+  useUpdateEffect(() =&gt; {</span>
<span class="hljs-addition">+    if (hasAutoRun.current) {</span>
<span class="hljs-addition">+      return;</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    if (!manual) {</span>
<span class="hljs-addition">+      hasAutoRun.current = true;</span>
<span class="hljs-addition">+      if (refreshDepsAction) {</span>
<span class="hljs-addition">+        refreshDepsAction();</span>
<span class="hljs-addition">+      } else {</span>
<span class="hljs-addition">+        fetchInstance.refresh();</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+  }, [...refreshDeps]);</span>
  return {
    onBefore: () =&gt; {
      if (!ready) {
        return {
          stopNow: true
        };
      }
    }
  };
};

useAutoRunPlugin.onInit = ({
  ready = true,
  manual
}) =&gt; {
  return {
    loading: !manual &amp;&amp; ready
  };
};

export default useAutoRunPlugin;
</code></pre>
<h2 id="t8314.&#x5C4F;&#x5E55;&#x805A;&#x7126;&#x91CD;&#x65B0;&#x8BF7;&#x6C42;">14.&#x5C4F;&#x5E55;&#x805A;&#x7126;&#x91CD;&#x65B0;&#x8BF7;&#x6C42; <a href="#t8314.&#x5C4F;&#x5E55;&#x805A;&#x7126;&#x91CD;&#x65B0;&#x8BF7;&#x6C42;"> # </a></h2>
<ul>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-request/refresh-on-window-focus/">refresh-on-window-focus</a></li>
<li>&#x901A;&#x8FC7;&#x8BBE;&#x7F6E; <code>options.refreshOnWindowFocus</code>&#xFF0C;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x7A97;&#x53E3; <code>refocus</code> &#x548C; <code>revisible</code> &#x65F6;&#xFF0C;&#x4F1A;&#x91CD;&#x65B0;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;</li>
</ul>
<h3 id="t8414.1 App.js">14.1 App.js <a href="#t8414.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
let counter = 0;
function getName() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      resolve(`zhufeng` + (++counter));
    }, 1000);
  });
}
function App() {
  const { data: name, loading } = useRequest(getName, {
<span class="hljs-addition">+   refreshOnWindowFocus: true,</span>
<span class="hljs-addition">+   focusTimespan: 5000</span>
  });
  return (
    &lt;&gt;
      {loading ? &apos;&#x52A0;&#x8F7D;&#x4E2D;&apos; : name ? &lt;div&gt;&#x7528;&#x6237;&#x540D;: {name}&lt;/div&gt; : null}
    &lt;/&gt;
  );
};
export default App;
</code></pre>
<h3 id="t8514.2 useRequest.js">14.2 useRequest.js <a href="#t8514.2 useRequest.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequest.js</p>
<pre><code class="lang-diff">import useRequestImplement from &apos;./useRequestImplement&apos;;
import useLoadingDelayPlugin from &apos;./plugins/useLoadingDelayPlugin&apos;;
import usePollingPlugin from &apos;./plugins/usePollingPlugin&apos;;
import useAutoRunPlugin from &apos;./plugins/useAutoRunPlugin&apos;;
<span class="hljs-addition">+import useRefreshOnWindowFocusPlugin from &apos;./plugins/useRefreshOnWindowFocusPlugin&apos;;</span>
function useRequest(service, options = {}, plugins) {
  return useRequestImplement(service, options, [...(plugins || []),
    useLoadingDelayPlugin,
    usePollingPlugin,
    useAutoRunPlugin,
<span class="hljs-addition">+   useRefreshOnWindowFocusPlugin</span>
  ]);
}
export default useRequest;
</code></pre>
<h3 id="t8614.3 useRefreshOnWindowFocusPlugin.js">14.3 useRefreshOnWindowFocusPlugin.js <a href="#t8614.3 useRefreshOnWindowFocusPlugin.js"> # </a></h3>
<p>src\ahooks\useRequest\src\plugins\useRefreshOnWindowFocusPlugin.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">import</span> useUnmount <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;../../../useUnmount&apos;</span>;
<span class="hljs-keyword">import</span> limit <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;../utils/limit&apos;</span>;
<span class="hljs-keyword">import</span> subscribeFocus <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;../utils/subscribeFocus&apos;</span>;

<span class="hljs-keyword">const</span> useRefreshOnWindowFocusPlugin = (fetchInstance, {
  refreshOnWindowFocus,
  focusTimespan = <span class="hljs-number">5000</span>
}) =&gt; {
  <span class="hljs-keyword">const</span> unsubscribeRef = useRef();

  <span class="hljs-keyword">const</span> stopSubscribe = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    unsubscribeRef.current?.();
  };

  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (refreshOnWindowFocus) {
      <span class="hljs-keyword">const</span> limitRefresh = limit(fetchInstance.refresh.bind(fetchInstance), focusTimespan);
      unsubscribeRef.current = subscribeFocus(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> limitRefresh());
    }
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      stopSubscribe();
    };
  }, [refreshOnWindowFocus, focusTimespan]);
  useUnmount(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    stopSubscribe();
  });
  <span class="hljs-keyword">return</span> {};
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useRefreshOnWindowFocusPlugin;
</code></pre>
<h3 id="t8714.4 limit.js">14.4 limit.js <a href="#t8714.4 limit.js"> # </a></h3>
<p>src\ahooks\useRequest\src\utils\limit.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">limit</span>(<span class="hljs-params">fn, timespan</span>) </span>{
  <span class="hljs-keyword">let</span> pending = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (pending) <span class="hljs-keyword">return</span>;
    pending = <span class="hljs-literal">true</span>;
    fn(...args);
    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      pending = <span class="hljs-literal">false</span>;
    }, timespan);
  };
}
</code></pre>
<h3 id="t8814.5 subscribeFocus.js">14.5 subscribeFocus.js <a href="#t8814.5 subscribeFocus.js"> # </a></h3>
<p>src\ahooks\useRequest\src\utils\subscribeFocus.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> isDocumentVisible <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;./isDocumentVisible&apos;</span>;
<span class="hljs-keyword">const</span> listeners = [];

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">subscribe</span>(<span class="hljs-params">listener</span>) </span>{
  listeners.push(listener);
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unsubscribe</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> index = listeners.indexOf(listener);
    listeners.splice(index, <span class="hljs-number">1</span>);
  };
}

<span class="hljs-keyword">const</span> revalidate = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (!isDocumentVisible()) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i++) {
    <span class="hljs-keyword">const</span> listener = listeners[i];
    listener();
  }
};

<span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">&apos;visibilitychange&apos;</span>, revalidate, <span class="hljs-literal">false</span>);
<span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">&apos;focus&apos;</span>, revalidate, <span class="hljs-literal">false</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> subscribe;
</code></pre>
<h2 id="t8915.&#x9632;&#x6296;">15.&#x9632;&#x6296; <a href="#t8915.&#x9632;&#x6296;"> # </a></h2>
<ul>
<li><a href="https://ahooks.js.org/zh-CN/hooks/use-request/debounce">debounce</a></li>
<li><a href="https://www.lodashjs.com/docs/lodash.debounce/">lodash.debounce</a></li>
<li>&#x901A;&#x8FC7;&#x8BBE;&#x7F6E; <code>options.debounceWait</code>&#xFF0C;&#x8FDB;&#x5165;&#x9632;&#x6296;&#x6A21;&#x5F0F;&#xFF0C;&#x6B64;&#x65F6;&#x5982;&#x679C;&#x9891;&#x7E41;&#x89E6;&#x53D1; run &#x6216;&#x8005; runAsync&#xFF0C;&#x5219;&#x4F1A;&#x4EE5;&#x9632;&#x6296;&#x7B56;&#x7565;&#x8FDB;&#x884C;&#x8BF7;&#x6C42;&#x3002;</li>
</ul>
<h3 id="t9015.1 App.js">15.1 App.js <a href="#t9015.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
let counter = 0;
<span class="hljs-addition">+function getName(suffix) {</span>
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
<span class="hljs-addition">+     resolve(`zhufeng` + suffix);</span>
    }, 300);
  });
}
function App() {
  const { data: name, loading, run } = useRequest(getName, {
<span class="hljs-addition">+   manual: true,</span>
<span class="hljs-addition">+   debounceWait: 1000</span>
  });
  return (
    &lt;&gt;
      &lt;input onChange={(e) =&gt; run(e.target.value)} /&gt;
      {loading ? &apos;&#x52A0;&#x8F7D;&#x4E2D;&apos; : name ? &lt;div&gt;&#x7528;&#x6237;&#x540D;: {name}&lt;/div&gt; : null}
    &lt;/&gt;
  );
};
export default App;
</code></pre>
<h3 id="t9115.2 useRequest.js">15.2 useRequest.js <a href="#t9115.2 useRequest.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequest.js</p>
<pre><code class="lang-diff">import useRequestImplement from &apos;./useRequestImplement&apos;;
import useLoadingDelayPlugin from &apos;./plugins/useLoadingDelayPlugin&apos;;
import usePollingPlugin from &apos;./plugins/usePollingPlugin&apos;;
import useAutoRunPlugin from &apos;./plugins/useAutoRunPlugin&apos;;
import useRefreshOnWindowFocusPlugin from &apos;./plugins/useRefreshOnWindowFocusPlugin&apos;;
<span class="hljs-addition">+import useDebouncePlugin from &apos;./plugins/useDebouncePlugin&apos;;</span>
function useRequest(service, options = {}, plugins) {
  return useRequestImplement(service, options, [...(plugins || []),
    useLoadingDelayPlugin,
    usePollingPlugin,
    useAutoRunPlugin,
    useRefreshOnWindowFocusPlugin,
<span class="hljs-addition">+   useDebouncePlugin</span>
  ]);
}
export default useRequest;
</code></pre>
<h3 id="t9215.3 useDebouncePlugin.js">15.3 useDebouncePlugin.js <a href="#t9215.3 useDebouncePlugin.js"> # </a></h3>
<p>src\ahooks\useRequest\src\plugins\useDebouncePlugin.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;

<span class="hljs-keyword">const</span> useDebouncePlugin = <span class="hljs-function">(<span class="hljs-params">fetchInstance, { debounceWait }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> debouncedRef = useRef();
  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (debounceWait) {
      <span class="hljs-keyword">const</span> originRunAsync = fetchInstance.runAsync.bind(fetchInstance);
      debouncedRef.current = debounce(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> callback(), debounceWait);
      fetchInstance.runAsync = <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
          debouncedRef.current?.(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> originRunAsync(...args).then(resolve).catch(reject));
        });
      };
    }
  }, [debounceWait]);
  <span class="hljs-keyword">return</span> {};
};
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">debounce</span>(<span class="hljs-params">fn, wait</span>) </span>{
  <span class="hljs-keyword">let</span> timer;
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (timer) {
      clearTimeout(timer);
      timer = <span class="hljs-literal">null</span>;
    }
    timer = setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> fn(...args), wait);
  }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useDebouncePlugin;
</code></pre>
<h2 id="t9316.&#x8282;&#x6D41;">16.&#x8282;&#x6D41; <a href="#t9316.&#x8282;&#x6D41;"> # </a></h2>
<ul>
<li>&#x901A;&#x8FC7;&#x8BBE;&#x7F6E; <code>options.throttleWait</code>&#xFF0C;&#x8FDB;&#x5165;&#x8282;&#x6D41;&#x6A21;&#x5F0F;&#xFF0C;&#x6B64;&#x65F6;&#x5982;&#x679C;&#x9891;&#x7E41;&#x89E6;&#x53D1; run &#x6216;&#x8005; runAsync&#xFF0C;&#x5219;&#x4F1A;&#x4EE5;&#x8282;&#x6D41;&#x7B56;&#x7565;&#x8FDB;&#x884C;&#x8BF7;&#x6C42;</li>
</ul>
<h3 id="t9416.1 App.js">16.1 App.js <a href="#t9416.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
function getName(suffix = &apos;&apos;) {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      resolve(`zhufeng` + suffix);
    }, 300);
  });
}
function App() {
  const { data: name, loading, run } = useRequest(getName, {
<span class="hljs-addition">+   throttleWait: 1000</span>
  });
  return (
    &lt;&gt;
      &lt;input onChange={(e) =&gt; run(e.target.value)} /&gt;
      {loading ? &apos;&#x52A0;&#x8F7D;&#x4E2D;&apos; : name ? &lt;div&gt;&#x7528;&#x6237;&#x540D;: {name}&lt;/div&gt; : null}
    &lt;/&gt;
  );
};
export default App;
</code></pre>
<h3 id="t9516.2 useRequest.js">16.2 useRequest.js <a href="#t9516.2 useRequest.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequest.js</p>
<pre><code class="lang-diff">import useRequestImplement from &apos;./useRequestImplement&apos;;
import useLoadingDelayPlugin from &apos;./plugins/useLoadingDelayPlugin&apos;;
import usePollingPlugin from &apos;./plugins/usePollingPlugin&apos;;
import useAutoRunPlugin from &apos;./plugins/useAutoRunPlugin&apos;;
import useRefreshOnWindowFocusPlugin from &apos;./plugins/useRefreshOnWindowFocusPlugin&apos;;
import useDebouncePlugin from &apos;./plugins/useDebouncePlugin&apos;;
<span class="hljs-addition">+import useThrottlePlugin from &apos;./plugins/useThrottlePlugin&apos;;</span>
function useRequest(service, options = {}, plugins) {
  return useRequestImplement(service, options, [...(plugins || []),
    useLoadingDelayPlugin,
    usePollingPlugin,
    useAutoRunPlugin,
    useRefreshOnWindowFocusPlugin,
    useDebouncePlugin,
<span class="hljs-addition">+   useThrottlePlugin</span>
  ]);
}
export default useRequest;
</code></pre>
<h3 id="t9616.3 useThrottlePlugin.js">16.3 useThrottlePlugin.js <a href="#t9616.3 useThrottlePlugin.js"> # </a></h3>
<p>src\ahooks\useRequest\src\plugins\useThrottlePlugin.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">const</span> useThrottlePlugin = <span class="hljs-function">(<span class="hljs-params">fetchInstance, { throttleWait }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> throttledRef = useRef();
  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (throttleWait) {
      <span class="hljs-keyword">const</span> originRunAsync = fetchInstance.runAsync.bind(fetchInstance);
      throttledRef.current = throttle(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> callback(), throttleWait);
      fetchInstance.runAsync = <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
          throttledRef.current?.(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> originRunAsync(...args).then(resolve).catch(reject));
        });
      };
    }
  }, [throttleWait]);
  <span class="hljs-keyword">return</span> {};
};
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">throttle</span>(<span class="hljs-params">fn, wait</span>) </span>{
  <span class="hljs-keyword">let</span> lastExecTime = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> throttledFn = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) </span>{
    <span class="hljs-keyword">const</span> currentTime = <span class="hljs-built_in">Date</span>.now();
    <span class="hljs-keyword">const</span> nextExecTime = lastExecTime + wait;
    <span class="hljs-keyword">if</span> (currentTime &gt;= nextExecTime) {
      fn.apply(<span class="hljs-keyword">this</span>, args);
      lastExecTime = currentTime;
    }
  }
  <span class="hljs-keyword">return</span> throttledFn;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useThrottlePlugin;
</code></pre>
<h2 id="t9717.&#x9519;&#x8BEF;&#x91CD;&#x8BD5;">17.&#x9519;&#x8BEF;&#x91CD;&#x8BD5; <a href="#t9717.&#x9519;&#x8BEF;&#x91CD;&#x8BD5;"> # </a></h2>
<ul>
<li>&#x901A;&#x8FC7;&#x8BBE;&#x7F6E; <code>options.retryCount</code>&#xFF0C;&#x6307;&#x5B9A;&#x9519;&#x8BEF;&#x91CD;&#x8BD5;&#x6B21;&#x6570;&#xFF0C;&#x5219; useRequest &#x5728;&#x5931;&#x8D25;&#x540E;&#x4F1A;&#x8FDB;&#x884C;&#x91CD;&#x8BD5;&#x3002;</li>
</ul>
<h3 id="t9817.1 App.js">17.1 App.js <a href="#t9817.1 App.js"> # </a></h3>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
function getName(suffix = &apos;&apos;) {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      //resolve(`zhufeng` + suffix);
      reject(new Error(&apos;&#x83B7;&#x53D6;&#x7528;&#x6237;&#x540D;&#x5931;&#x8D25;&apos;));
    }, 2000);
  });
}
function App() {
  const { data: name, loading, run } = useRequest(getName, {
<span class="hljs-addition">+   retryCount: 3</span>
<span class="hljs-addition">+   retryInterval:1000_</span>
  });
  return (
    &lt;&gt;
      &lt;input onChange={(e) =&gt; run(e.target.value)} /&gt;
      {loading ? &apos;&#x52A0;&#x8F7D;&#x4E2D;&apos; : name ? &lt;div&gt;&#x7528;&#x6237;&#x540D;: {name}&lt;/div&gt; : null}
    &lt;/&gt;
  );
};
export default App;
</code></pre>
<h3 id="t9917.2 useRequest.js">17.2 useRequest.js <a href="#t9917.2 useRequest.js"> # </a></h3>
<p>src\ahooks\useRequest\src\useRequest.js</p>
<pre><code class="lang-diff">import useRequestImplement from &apos;./useRequestImplement&apos;;
import useLoadingDelayPlugin from &apos;./plugins/useLoadingDelayPlugin&apos;;
import usePollingPlugin from &apos;./plugins/usePollingPlugin&apos;;
import useAutoRunPlugin from &apos;./plugins/useAutoRunPlugin&apos;;
import useRefreshOnWindowFocusPlugin from &apos;./plugins/useRefreshOnWindowFocusPlugin&apos;;
import useDebouncePlugin from &apos;./plugins/useDebouncePlugin&apos;;
import useThrottlePlugin from &apos;./plugins/useThrottlePlugin&apos;;
<span class="hljs-addition">+import useRetryPlugin from &apos;./plugins/useRetryPlugin&apos;;</span>
function useRequest(service, options = {}, plugins) {
  return useRequestImplement(service, options, [...(plugins || []),
    useLoadingDelayPlugin,
    usePollingPlugin,
    useAutoRunPlugin,
    useRefreshOnWindowFocusPlugin,
    useDebouncePlugin,
    useThrottlePlugin,
<span class="hljs-addition">+   useRetryPlugin</span>
  ]);
}
export default useRequest;
</code></pre>
<h3 id="t10017.3 useRetryPlugin.js">17.3 useRetryPlugin.js <a href="#t10017.3 useRetryPlugin.js"> # </a></h3>
<p>src\ahooks\useRequest\src\plugins\useRetryPlugin.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> { useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;react&apos;</span>;
<span class="hljs-keyword">const</span> useRetryPlugin = (fetchInstance, {
  retryInterval,
  retryCount
}) =&gt; {
  <span class="hljs-keyword">const</span> timerRef = useRef();
  <span class="hljs-keyword">const</span> countRef = useRef(<span class="hljs-number">0</span>);<span class="hljs-comment">//&#x91CD;&#x8BD5;&#x7684;&#x6B21;&#x6570;</span>
  <span class="hljs-keyword">const</span> triggerByRetry = useRef(<span class="hljs-literal">false</span>);<span class="hljs-comment">//&#x662F;&#x5426;&#x7531;&#x91CD;&#x8BD5;&#x89E6;&#x53D1;</span>

  <span class="hljs-keyword">if</span> (!retryCount) {
    <span class="hljs-keyword">return</span> {};
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">onBefore</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (!triggerByRetry.current) {
        countRef.current = <span class="hljs-number">0</span>;
      }

      triggerByRetry.current = <span class="hljs-literal">false</span>;

      <span class="hljs-keyword">if</span> (timerRef.current) {
        clearTimeout(timerRef.current);
      }
    },
    <span class="hljs-attr">onSuccess</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      countRef.current = <span class="hljs-number">0</span>;
    },
    <span class="hljs-attr">onError</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      countRef.current += <span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span> (retryCount === <span class="hljs-number">-1</span> || countRef.current &lt;= retryCount) {
        <span class="hljs-keyword">const</span> timeout = retryInterval ?? <span class="hljs-built_in">Math</span>.min(<span class="hljs-number">1000</span> * <span class="hljs-number">2</span> ** countRef.current, <span class="hljs-number">30000</span>);
        timerRef.current = setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          triggerByRetry.current = <span class="hljs-literal">true</span>;
          fetchInstance.refresh();
        }, timeout);
      } <span class="hljs-keyword">else</span> {
        countRef.current = <span class="hljs-number">0</span>;
      }
    },
    <span class="hljs-attr">onCancel</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      countRef.current = <span class="hljs-number">0</span>;

      <span class="hljs-keyword">if</span> (timerRef.current) {
        clearTimeout(timerRef.current);
      }
    }
  };
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useRetryPlugin;
</code></pre>
<h2 id="t10118.&#x7F13;&#x5B58;">18.&#x7F13;&#x5B58; <a href="#t10118.&#x7F13;&#x5B58;"> # </a></h2>
<ul>
<li>&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86; <code>options.cacheKey</code>&#xFF0C;<code>useRequest</code> &#x4F1A;&#x5C06;&#x5F53;&#x524D;&#x8BF7;&#x6C42;&#x6210;&#x529F;&#x7684;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x8D77;&#x6765;&#x3002;&#x4E0B;&#x6B21;&#x7EC4;&#x4EF6;&#x521D;&#x59CB;&#x5316;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x7F13;&#x5B58;&#x6570;&#x636E;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x4F18;&#x5148;&#x8FD4;&#x56DE;&#x7F13;&#x5B58;&#x6570;&#x636E;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x80CC;&#x540E;&#x53D1;&#x9001;&#x65B0;&#x8BF7;&#x6C42;&#xFF0C;&#x4E5F;&#x5C31;&#x662F; SWR &#x7684;&#x80FD;&#x529B;&#x3002;</li>
<li>&#x4F60;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>options.staleTime</code>&#x8BBE;&#x7F6E;&#x6570;&#x636E;&#x4FDD;&#x6301;&#x65B0;&#x9C9C;&#x65F6;&#x95F4;&#xFF0C;&#x5728;&#x8BE5;&#x65F6;&#x95F4;&#x5185;&#xFF0C;&#x6211;&#x4EEC;&#x8BA4;&#x4E3A;&#x6570;&#x636E;&#x662F;&#x65B0;&#x9C9C;&#x7684;&#xFF0C;&#x4E0D;&#x4F1A;&#x91CD;&#x65B0;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;&#x3002;</li>
<li>&#x4F60;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>options.cacheTime</code> &#x8BBE;&#x7F6E;&#x6570;&#x636E;&#x7F13;&#x5B58;&#x65F6;&#x95F4;&#xFF0C;&#x8D85;&#x8FC7;&#x8BE5;&#x65F6;&#x95F4;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x6E05;&#x7A7A;&#x8BE5;&#x6761;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x3002;</li>
</ul>
<h3 id="t10218.1 SWR">18.1 SWR <a href="#t10218.1 SWR"> # </a></h3>
<ul>
<li><p>swr &#x5B9E;&#x9645;&#x4E0A;&#x662F; Cache Control &#x4E2D;&#x65B0;&#x589E;&#x7684;&#x4E00;&#x4E2A;&#x8BD5;&#x9A8C;&#x6027;&#x6307;&#x4EE4;</p>
<pre><code class="lang-js">Cache-Control: max-age=<span class="hljs-number">86400</span>, stale-<span class="hljs-keyword">while</span>-revalidate=<span class="hljs-number">172800</span>
</code></pre>
<p><img src="./assets/img/9120802d4e5b27a36e5b7faef7ab5ad0.jpg" alt="swr"></p>
</li>
<li><p>&#x8BBE;&#x7F6E;&#x4E86; <code>cacheKey</code>&#xFF0C;&#x5728;&#x7EC4;&#x4EF6;&#x7B2C;&#x4E8C;&#x6B21;&#x52A0;&#x8F7D;&#x65F6;&#xFF0C;&#x4F1A;&#x4F18;&#x5148;&#x8FD4;&#x56DE;&#x7F13;&#x5B58;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x80CC;&#x540E;&#x91CD;&#x65B0;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;&#x3002;&#x4F60;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x70B9;&#x51FB;&#x6309;&#x94AE;&#x6765;&#x4F53;&#x9A8C;&#x6548;&#x679C;</p>
</li>
</ul>
<h4 id="t10318.1.1 App.js">18.1.1 App.js <a href="#t10318.1.1 App.js"> # </a></h4>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState } from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
let counter = 0;
function getName() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
<span class="hljs-addition">+     resolve({</span>
<span class="hljs-addition">+       time: new Date().toLocaleTimeString(), data: `zhufeng` + (++counter)</span>
<span class="hljs-addition">+     });</span>
    }, 2000);
  });
}
<span class="hljs-addition">+function User() {</span>
<span class="hljs-addition">+  const { data, loading } = useRequest(getName, {</span>
<span class="hljs-addition">+    cacheKey: &apos;cacheKey&apos;,</span>
<span class="hljs-addition">+  });</span>
<span class="hljs-addition">+  if (!data &amp;&amp; loading) {</span>
<span class="hljs-addition">+    return &lt;p&gt;&#x52A0;&#x8F7D;&#x4E2D;...&lt;/p&gt;;</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+  return (</span>
<span class="hljs-addition">+    &lt;&gt;</span>
<span class="hljs-addition">+      &lt;p&gt;&#x540E;&#x53F0;&#x52A0;&#x8F7D;&#x4E2D;: {loading ? &apos;true&apos; : &apos;false&apos;}&lt;/p&gt;</span>
<span class="hljs-addition">+      &lt;p&gt;&#x6700;&#x8FD1;&#x7684;&#x8BF7;&#x6C42;&#x65F6;&#x95F4;: {data?.time}&lt;/p&gt;</span>
<span class="hljs-addition">+      &lt;p&gt;{data?.data}&lt;/p&gt;</span>
<span class="hljs-addition">+    &lt;/&gt;</span>
<span class="hljs-addition">+  );</span>
<span class="hljs-addition">+}</span>
function App() {
<span class="hljs-addition">+ const [visible, setVisible] = useState(true);</span>
<span class="hljs-addition">+ return (</span>
<span class="hljs-addition">+   &lt;div&gt;</span>
<span class="hljs-addition">+     &lt;button type=&quot;button&quot; onClick={() =&gt; setVisible(!visible)}&gt;</span>
<span class="hljs-addition">+       {visible ? &apos;&#x9690;&#x85CF;&apos; : &apos;&#x663E;&#x793A;&apos;}</span>
<span class="hljs-addition">+     &lt;/button&gt;</span>
<span class="hljs-addition">+     {visible &amp;&amp; &lt;User /&gt;}</span>
<span class="hljs-addition">+   &lt;/div&gt;</span>
<span class="hljs-addition">+ );</span>
};
export default App;
</code></pre>
<h4 id="t10418.1.2 useRequest.js">18.1.2 useRequest.js <a href="#t10418.1.2 useRequest.js"> # </a></h4>
<p>src\ahooks\useRequest\src\useRequest.js</p>
<pre><code class="lang-diff">import useRequestImplement from &apos;./useRequestImplement&apos;;
import useLoadingDelayPlugin from &apos;./plugins/useLoadingDelayPlugin&apos;;
import usePollingPlugin from &apos;./plugins/usePollingPlugin&apos;;
import useAutoRunPlugin from &apos;./plugins/useAutoRunPlugin&apos;;
import useRefreshOnWindowFocusPlugin from &apos;./plugins/useRefreshOnWindowFocusPlugin&apos;;
import useDebouncePlugin from &apos;./plugins/useDebouncePlugin&apos;;
import useThrottlePlugin from &apos;./plugins/useThrottlePlugin&apos;;
import useRetryPlugin from &apos;./plugins/useRetryPlugin&apos;;
<span class="hljs-addition">+import useCachePlugin from &apos;./plugins/useCachePlugin&apos;;</span>
function useRequest(service, options = {}, plugins) {
  return useRequestImplement(service, options, [...(plugins || []),
    useLoadingDelayPlugin,
    usePollingPlugin,
    useAutoRunPlugin,
    useRefreshOnWindowFocusPlugin,
    useDebouncePlugin,
    useThrottlePlugin,
    useRetryPlugin,
<span class="hljs-addition">+   useCachePlugin</span>
  ]);
}
export default useRequest;
</code></pre>
<h4 id="t10518.1.3 useCachePlugin.js">18.1.3 useCachePlugin.js <a href="#t10518.1.3 useCachePlugin.js"> # </a></h4>
<p>src\ahooks\useRequest\src\plugins\useCachePlugin.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> cache <span class="hljs-keyword">from</span> <span class="hljs-string">&apos;../utils/cache&apos;</span>;
<span class="hljs-keyword">const</span> useCachePlugin = (fetchInstance, {
  cacheKey
}) =&gt; {
  <span class="hljs-keyword">const</span> _setCache = <span class="hljs-function">(<span class="hljs-params">key, cachedData</span>) =&gt;</span> {
    cache.setCache(key, cachedData);
  };

  <span class="hljs-keyword">const</span> _getCache = <span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> cache.getCache(key);
  };

  <span class="hljs-keyword">if</span> (!cacheKey) {
    <span class="hljs-keyword">return</span> {};
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">onBefore</span>: <span class="hljs-function"><span class="hljs-params">params</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> cacheData = _getCache(cacheKey, params);
      <span class="hljs-keyword">if</span> (!cacheData || !<span class="hljs-built_in">Object</span>.hasOwnProperty.call(cacheData, <span class="hljs-string">&apos;data&apos;</span>)) {
        <span class="hljs-keyword">return</span> {};
      }
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">data</span>: cacheData?.data
      };
    },
    <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">data, params</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (cacheKey) {
        _setCache(cacheKey, {
          data,
          params,
          <span class="hljs-attr">time</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()
        });
      }
    }
  };
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useCachePlugin;
</code></pre>
<h4 id="t10618.1.4 cache.js">18.1.4 cache.js <a href="#t10618.1.4 cache.js"> # </a></h4>
<p>src\ahooks\useRequest\src\utils\cache.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> cache = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();

<span class="hljs-keyword">const</span> setCache = <span class="hljs-function">(<span class="hljs-params">key, cachedData</span>) =&gt;</span> {
  cache.set(key, {
    ...cachedData
  });
};

<span class="hljs-keyword">const</span> getCache = <span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> cache.get(key);
};

<span class="hljs-keyword">export</span> { getCache, setCache };
</code></pre>
<h3 id="t10718.2 &#x6570;&#x636E;&#x4FDD;&#x6301;&#x65B0;&#x9C9C;">18.2 &#x6570;&#x636E;&#x4FDD;&#x6301;&#x65B0;&#x9C9C; <a href="#t10718.2 &#x6570;&#x636E;&#x4FDD;&#x6301;&#x65B0;&#x9C9C;"> # </a></h3>
<ul>
<li>&#x901A;&#x8FC7;&#x8BBE;&#x7F6E; staleTime&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x6570;&#x636E;&#x65B0;&#x9C9C;&#x65F6;&#x95F4;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x65F6;&#x95F4;&#x5185;&#xFF0C;&#x4E0D;&#x4F1A;&#x91CD;&#x65B0;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;&#x3002;&#x4E0B;&#x9762;&#x7684;&#x793A;&#x4F8B;&#x8BBE;&#x7F6E;&#x4E86; <code>5s</code> &#x7684;&#x65B0;&#x9C9C;&#x65F6;&#x95F4;</li>
</ul>
<h4 id="t10818.2.1 App.js">18.2.1 App.js <a href="#t10818.2.1 App.js"> # </a></h4>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState } from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
let counter = 0;
function getName() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      resolve({
        time: new Date().toLocaleTimeString(), data: `zhufeng` + (++counter)
      });
    }, 2000);
  });
}
function User() {
  const { data, loading } = useRequest(getName, {
    cacheKey: &apos;cacheKey&apos;,
<span class="hljs-addition">+   staleTime: 5000</span>
  });
  if (!data &amp;&amp; loading) {
    return &lt;p&gt;&#x52A0;&#x8F7D;&#x4E2D;...&lt;/p&gt;;
  }
  return (
    &lt;&gt;
      &lt;p&gt;&#x540E;&#x53F0;&#x52A0;&#x8F7D;&#x4E2D;: {loading ? &apos;true&apos; : &apos;false&apos;}&lt;/p&gt;
      &lt;p&gt;&#x6700;&#x8FD1;&#x7684;&#x8BF7;&#x6C42;&#x65F6;&#x95F4;: {data?.time}&lt;/p&gt;
      &lt;p&gt;{data?.data}&lt;/p&gt;
    &lt;/&gt;
  );
}
function App() {
  const [visible, setVisible] = useState(true);
  return (
    &lt;div&gt;
      &lt;button type=&quot;button&quot; onClick={() =&gt; setVisible(!visible)}&gt;
        {visible ? &apos;&#x9690;&#x85CF;&apos; : &apos;&#x663E;&#x793A;&apos;}
      &lt;/button&gt;
      {visible &amp;&amp; &lt;User /&gt;}
    &lt;/div&gt;
  );
};
export default App;
</code></pre>
<h4 id="t10918.2.2 useCachePlugin.js">18.2.2 useCachePlugin.js <a href="#t10918.2.2 useCachePlugin.js"> # </a></h4>
<p>src\ahooks\useRequest\src\plugins\useCachePlugin.js</p>
<pre><code class="lang-diff">import * as cache from &apos;../utils/cache&apos;;
const useCachePlugin = (fetchInstance, {
  cacheKey,
<span class="hljs-addition">+ staleTime = 0,</span>
}) =&gt; {
  const _setCache = (key, cachedData) =&gt; {
    cache.setCache(key, cachedData);
  };

  const _getCache = (key) =&gt; {
    return cache.getCache(key);
  };

  if (!cacheKey) {
    return {};
  }

  return {
    onBefore: params =&gt; {
      const cacheData = _getCache(cacheKey, params);
      if (!cacheData || !Object.hasOwnProperty.call(cacheData, &apos;data&apos;)) {
        return {};
      }
<span class="hljs-addition">+     if (staleTime === -1 || new Date().getTime() - cacheData.time &lt;= staleTime) {</span>
<span class="hljs-addition">+       return {</span>
<span class="hljs-addition">+         loading: false,</span>
<span class="hljs-addition">+         data: cacheData?.data,</span>
<span class="hljs-addition">+         returnNow: true</span>
<span class="hljs-addition">+       };</span>
<span class="hljs-addition">+     } else {</span>
        return {
          data: cacheData?.data
        };
<span class="hljs-addition">+     }</span>
    },
    onSuccess: (data) =&gt; {
      if (cacheKey) {
        _setCache(cacheKey, {
          data,
          time: new Date().getTime()
        });
      }
    }
  };
};

export default useCachePlugin;
</code></pre>
<h4 id="t11018.2.3 Fetch.js">18.2.3 Fetch.js <a href="#t11018.2.3 Fetch.js"> # </a></h4>
<p>src\ahooks\useRequest\src\Fetch.js</p>
<pre><code class="lang-diff">import { isFunction } from &apos;../../utils&apos;;
class Fetch {
  count = 0;
  constructor(serviceRef, options, subscribe, initState = {}) {
    this.serviceRef = serviceRef;
    this.options = options;
    this.subscribe = subscribe;
    this.state = { loading: !options.manual, data: undefined, error: undefined, params: undefined, ...initState };
  }
  setState = (s = {}) =&gt; {
    this.state = { ...this.state, ...s };
    this.subscribe();
  }
  runAsync = async (...params) =&gt; {
    this.count += 1;
    const currentCount = this.count;
<span class="hljs-addition">+   const { stopNow = false, returnNow = false, ...state } = this.runPluginHandler(&apos;onBefore&apos;, params);</span>
    if (stopNow) {
      return new Promise(() =&gt; { });
    }
    this.setState({ loading: true, params, ...state });
<span class="hljs-addition">+   if (returnNow) {</span>
<span class="hljs-addition">+     return Promise.resolve(state.data);</span>
<span class="hljs-addition">+   }</span>
    this.options.onBefore?.(params);
    try {
      let { servicePromise } = this.runPluginHandler(&apos;onRequest&apos;, this.serviceRef.current, params);
      if (!servicePromise) {
        servicePromise = this.serviceRef.current(...params);
      }
      const res = await servicePromise;
      if (currentCount !== this.count) {
        return new Promise(() =&gt; { });
      }
      this.setState({ loading: false, data: res, error: undefined, params });
      this.options.onSuccess?.(res, params);
      this.runPluginHandler(&apos;onSuccess&apos;, res, params);
      this.options.onFinally?.(params, res, undefined);
      if (currentCount <span class="hljs-comment">=== this.count) {</span>
        this.runPluginHandler(&apos;onFinally&apos;, params, res, undefined);
      }
    } catch (error) {
      if (currentCount !== this.count) {
        return new Promise(() =&gt; { });
      }
      this.setState({ loading: false, error, params });
      this.options.onError?.(error, params);
      this.runPluginHandler(&apos;onError&apos;, error, params);
      this.options.onFinally?.(params, undefined, error);
      if (currentCount <span class="hljs-comment">=== this.count) {</span>
        this.runPluginHandler(&apos;onFinally&apos;, params, undefined, error);
      }
      throw error;
    }
  }
  run = (...params) =&gt; {
    this.runAsync(...params).catch(error =&gt; {
      if (!this.options.onError) {
        console.error(error);
      }
    });
  }
  refresh() {
    this.run(...(this.state.params || []));
  }

  refreshAsync() {
    return this.runAsync(...(this.state.params || []));
  }
  mutate(data) {
    let targetData;

    if (isFunction(data)) {
      targetData = data(this.state.data);
    } else {
      targetData = data;
    }
    this.runPluginHandler(&apos;onMutate&apos;, targetData);
    this.setState({
      data: targetData
    });
  }
  cancel() {
    this.count += 1;
    this.setState({
      loading: false
    });
    this.options.onCancel?.();
    this.runPluginHandler(&apos;onCancel&apos;);
  }
  runPluginHandler(event, ...rest) {
    const r = this.pluginImpls.map(i =&gt; i[event]?.(...rest)).filter(Boolean);
    return Object.assign({}, ...r);
  }
}
export default Fetch;
</code></pre>
<h3 id="t11118.3 &#x53C2;&#x6570;&#x7F13;&#x5B58;">18.3 &#x53C2;&#x6570;&#x7F13;&#x5B58; <a href="#t11118.3 &#x53C2;&#x6570;&#x7F13;&#x5B58;"> # </a></h3>
<ul>
<li>&#x7F13;&#x5B58;&#x7684;&#x6570;&#x636E;&#x5305;&#x62EC; data &#x548C; params&#xFF0C;&#x901A;&#x8FC7; params &#x7F13;&#x5B58;&#x673A;&#x5236;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8BB0;&#x5FC6;&#x4E0A;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;&#x7684;&#x6761;&#x4EF6;&#xFF0C;&#x5E76;&#x5728;&#x4E0B;&#x6B21;&#x521D;&#x59CB;&#x5316;&#x3002;</li>
</ul>
<h4 id="t11218.3.1 App.js">18.3.1 App.js <a href="#t11218.3.1 App.js"> # </a></h4>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState } from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
let counter = 0;
<span class="hljs-addition">+function getName(keyword = &apos;&apos;) {</span>
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      resolve({
<span class="hljs-addition">+       time: new Date().toLocaleTimeString(), data: keyword + (++counter)</span>
      });
    }, 2000);
  });
}
function User() {
<span class="hljs-addition">+ const { data, loading, params, run } = useRequest(getName, {</span>
<span class="hljs-deletion">-   manual: true,</span>
    cacheKey: &apos;cacheKey&apos;,
<span class="hljs-addition">+   staleTime: 0</span>
  });
<span class="hljs-addition">+ const [keyword, setKeyword] = useState(params[0] || &quot;&quot;);</span>
  if (!data &amp;&amp; loading) {
    return &lt;p&gt;&#x52A0;&#x8F7D;&#x4E2D;...&lt;/p&gt;;
  }
  return (
    &lt;&gt;
<span class="hljs-addition">+     &lt;div&gt;</span>
<span class="hljs-addition">+       &lt;input</span>
<span class="hljs-addition">+         value={keyword}</span>
<span class="hljs-addition">+         onChange={(e) =&gt; setKeyword(e.target.value)}</span>
<span class="hljs-addition">+       /&gt;</span>
<span class="hljs-addition">+       &lt;button</span>
<span class="hljs-addition">+         onClick={() =&gt; {</span>
<span class="hljs-addition">+           run(keyword);</span>
<span class="hljs-addition">+         }}</span>
<span class="hljs-addition">+       &gt;</span>
<span class="hljs-addition">+         &#x83B7;&#x53D6;&#x7528;&#x6237;&#x540D;</span>
<span class="hljs-addition">+       &lt;/button&gt;</span>
<span class="hljs-addition">+     &lt;/div&gt;</span>
      &lt;p&gt;&#x540E;&#x53F0;&#x52A0;&#x8F7D;&#x4E2D;: {loading ? &apos;true&apos; : &apos;false&apos;}&lt;/p&gt;
      &lt;p&gt;&#x6700;&#x8FD1;&#x7684;&#x8BF7;&#x6C42;&#x65F6;&#x95F4;: {data?.time}&lt;/p&gt;
      &lt;p&gt;Keyword: {keyword}&lt;/p&gt;
      &lt;p&gt;{data?.data}&lt;/p&gt;
    &lt;/&gt;
  );
}
function App() {
  const [visible, setVisible] = useState(true);
  return (
    &lt;div&gt;
      &lt;button type=&quot;button&quot; onClick={() =&gt; setVisible(!visible)}&gt;
        {visible ? &apos;&#x9690;&#x85CF;&apos; : &apos;&#x663E;&#x793A;&apos;}
      &lt;/button&gt;
      {visible &amp;&amp; &lt;User /&gt;}
    &lt;/div&gt;
  );
};
export default App;
</code></pre>
<h4 id="t11318.3.2 useRequestImplement.js">18.3.2 useRequestImplement.js <a href="#t11318.3.2 useRequestImplement.js"> # </a></h4>
<p>src\ahooks\useRequest\src\useRequestImplement.js</p>
<pre><code class="lang-diff">import useCreation from &apos;../../useCreation&apos;;
import useLatest from &apos;../../useLatest&apos;;
import useMount from &apos;../../useMount&apos;;
import useUpdate from &apos;../../useUpdate&apos;;
import Fetch from &apos;./Fetch&apos;;
import useMemoizedFn from &apos;../../useMemoizedFn&apos;;
import useUnmount from &apos;../../useUnmount&apos;;
function useRequestImplement(service, options = {}, plugins = []) {
  const { manual = false, ...rest } = options;
  const fetchOptions = { manual, ...rest };
  const serviceRef = useLatest(service);
  const update = useUpdate();
  const fetchInstance = useCreation(() =&gt; {
    const initState = plugins.map(p =&gt; p?.onInit?.(fetchOptions)).filter(Boolean);
    return new Fetch(serviceRef, fetchOptions, update, Object.assign({}, ...initState));
  }, []);
  //fetchInstance.options = fetchOptions;
  fetchInstance.pluginImpls = plugins.map(p =&gt; p(fetchInstance, fetchOptions));
  useMount(() =&gt; {
    if (!manual) {
      const params = fetchInstance.state.params || options.defaultParams || [];
      fetchInstance.run(...params);
    }
  });
  useUnmount(() =&gt; {
    fetchInstance.cancel();
  });
  return {
    loading: fetchInstance.state.loading,
    data: fetchInstance.state.data,
    error: fetchInstance.state.error,
<span class="hljs-addition">+   params: fetchInstance.state.params || [],</span>
    run: useMemoizedFn(fetchInstance.run.bind(fetchInstance)),
    runAsync: useMemoizedFn(fetchInstance.runAsync.bind(fetchInstance)),
    refresh: useMemoizedFn(fetchInstance.refresh.bind(fetchInstance)),
    refreshAsync: useMemoizedFn(fetchInstance.refreshAsync.bind(fetchInstance)),
    mutate: useMemoizedFn(fetchInstance.mutate.bind(fetchInstance)),
    cancel: useMemoizedFn(fetchInstance.cancel.bind(fetchInstance))
  };
}

export default useRequestImplement;
</code></pre>
<h4 id="t11418.3.3 useCachePlugin.js">18.3.3 useCachePlugin.js <a href="#t11418.3.3 useCachePlugin.js"> # </a></h4>
<p>src\ahooks\useRequest\src\plugins\useCachePlugin.js</p>
<pre><code class="lang-diff">import * as cache from &apos;../utils/cache&apos;;
<span class="hljs-addition">+import useCreation from &apos;../../../useCreation&apos;;</span>
const useCachePlugin = (fetchInstance, {
  cacheKey,
  staleTime = 0,
}) =&gt; {
  const _setCache = (key, cachedData) =&gt; {
    cache.setCache(key, cachedData);
  };

  const _getCache = (key) =&gt; {
    return cache.getCache(key);
  };
<span class="hljs-addition">+ useCreation(() =&gt; {</span>
<span class="hljs-addition">+   if (!cacheKey) {</span>
<span class="hljs-addition">+     return;</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   const cacheData = _getCache(cacheKey);</span>
<span class="hljs-addition">+   if (cacheData &amp;&amp; Object.hasOwnProperty.call(cacheData, &apos;data&apos;)) {</span>
<span class="hljs-addition">+     fetchInstance.state.data = cacheData.data;</span>
<span class="hljs-addition">+     fetchInstance.state.params = cacheData.params;</span>
<span class="hljs-addition">+     if (staleTime === -1 || new Date().getTime() - cacheData.time &lt;= staleTime) {</span>
<span class="hljs-addition">+       fetchInstance.state.loading = false;</span>
<span class="hljs-addition">+     }</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+ })</span>
  if (!cacheKey) {
    return {};
  }

  return {
    onBefore: params =&gt; {
      const cacheData = _getCache(cacheKey, params);
      if (!cacheData || !Object.hasOwnProperty.call(cacheData, &apos;data&apos;)) {
        return {};
      }
      if (staleTime <span class="hljs-comment">=== -1 || new Date().getTime() - cacheData.time &lt;= staleTime) {</span>
        return {
          loading: false,
          data: cacheData?.data,
          returnNow: true
        };
      } else {
        return {
          data: cacheData?.data
        };
      }
    },
    onSuccess: (data, params) =&gt; {
      if (cacheKey) {
        _setCache(cacheKey, {
          data,
          params,
          time: new Date().getTime()
        });
      }
    }
  };
};

export default useCachePlugin;
</code></pre>
<h3 id="t11518.4 &#x5220;&#x9664;&#x7F13;&#x5B58;">18.4 &#x5220;&#x9664;&#x7F13;&#x5B58; <a href="#t11518.4 &#x5220;&#x9664;&#x7F13;&#x5B58;"> # </a></h3>
<ul>
<li>ahooks &#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A; <code>clearCache</code> &#x65B9;&#x6CD5;&#xFF0C;&#x53EF;&#x4EE5;&#x6E05;&#x9664;&#x6307;&#x5B9A; <code>cacheKey</code> &#x7684;&#x7F13;&#x5B58;&#x6570;&#x636E;&#x3002;</li>
</ul>
<h4 id="t11618.4.1 App.js">18.4.1 App.js <a href="#t11618.4.1 App.js"> # </a></h4>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState } from &apos;react&apos;;
<span class="hljs-addition">+import { useRequest, clearCache } from &apos;./ahooks&apos;;</span>
let counter = 0;
function getName(keyword = &apos;&apos;) {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      resolve({
        time: new Date().toLocaleTimeString(), data: keyword + (++counter)
      });
    }, 2000);
  });
}
function User() {
  const { data, loading, params, run } = useRequest(getName, {
    cacheKey: &apos;cacheKey&apos;,
<span class="hljs-addition">+   staleTime: 5000</span>
  });
  const [keyword, setKeyword] = useState(params[0] || &quot;&quot;);
  if (!data &amp;&amp; loading) {
    return &lt;p&gt;&#x52A0;&#x8F7D;&#x4E2D;...&lt;/p&gt;;
  }
  return (
    &lt;&gt;
      &lt;div&gt;
        &lt;input
          value={keyword}
          onChange={(e) =&gt; setKeyword(e.target.value)}
        /&gt;
        &lt;button
          onClick={() =&gt; {
            run(keyword);
          }}
        &gt;
          &#x83B7;&#x53D6;&#x7528;&#x6237;&#x540D;
        &lt;/button&gt;
      &lt;/div&gt;
<span class="hljs-addition">+     &lt;button onClick={() =&gt; clearCache(&apos;cacheKey&apos;)}&gt;</span>
<span class="hljs-addition">+       &#x6E05;&#x9664;&#x7F13;&#x5B58;</span>
<span class="hljs-addition">+     &lt;/button&gt;</span>
      &lt;p&gt;&#x540E;&#x53F0;&#x52A0;&#x8F7D;&#x4E2D;: {loading ? &apos;true&apos; : &apos;false&apos;}&lt;/p&gt;
      &lt;p&gt;&#x6700;&#x8FD1;&#x7684;&#x8BF7;&#x6C42;&#x65F6;&#x95F4;: {data?.time}&lt;/p&gt;
      &lt;p&gt;Keyword: {keyword}&lt;/p&gt;
      &lt;p&gt;{data?.data}&lt;/p&gt;
    &lt;/&gt;
  );
}
function App() {
  const [visible, setVisible] = useState(true);
  return (
    &lt;div&gt;
      &lt;button type=&quot;button&quot; onClick={() =&gt; setVisible(!visible)}&gt;
        {visible ? &apos;&#x9690;&#x85CF;&apos; : &apos;&#x663E;&#x793A;&apos;}
      &lt;/button&gt;
      {visible &amp;&amp; &lt;User /&gt;}
    &lt;/div&gt;
  );
};
export default App;
</code></pre>
<h4 id="t11718.4.2 ahooks\index.js">18.4.2 ahooks\index.js <a href="#t11718.4.2 ahooks\index.js"> # </a></h4>
<p>src\ahooks\index.js</p>
<pre><code class="lang-diff"><span class="hljs-addition">+import useRequest, { clearCache } from &apos;./useRequest&apos;;</span>
export {
<span class="hljs-addition">+  useRequest, clearCache</span>
}
</code></pre>
<h4 id="t11818.4.3 useRequest\index.js">18.4.3 useRequest\index.js <a href="#t11818.4.3 useRequest\index.js"> # </a></h4>
<p>src\ahooks\useRequest\index.js</p>
<pre><code class="lang-diff">import useRequest from &apos;./src/useRequest&apos;;
<span class="hljs-addition">+import { clearCache } from &apos;./src/utils/cache&apos;;</span>
<span class="hljs-addition">+export default useRequest;</span>
<span class="hljs-addition">+export { clearCache };</span>
</code></pre>
<h4 id="t11918.4.4 cache.js">18.4.4 cache.js <a href="#t11918.4.4 cache.js"> # </a></h4>
<p>src\ahooks\useRequest\src\utils\cache.js</p>
<pre><code class="lang-diff">const cache = new Map();

const setCache = (key, cachedData) =&gt; {
  cache.set(key, {
    ...cachedData
  });
};

const getCache = key =&gt; {
  return cache.get(key);
};

<span class="hljs-addition">+const clearCache = key =&gt; {</span>
<span class="hljs-addition">+  if (key) {</span>
<span class="hljs-addition">+    const cacheKeys = Array.isArray(key) ? key : [key];</span>
<span class="hljs-addition">+    cacheKeys.forEach(cacheKey =&gt; cache.delete(cacheKey));</span>
<span class="hljs-addition">+  } else {</span>
<span class="hljs-addition">+    cache.clear();</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+};</span>
export { getCache, setCache, clearCache };
</code></pre>
<h3 id="t12018.5 &#x81EA;&#x5B9A;&#x4E49;&#x7F13;&#x5B58;">18.5 &#x81EA;&#x5B9A;&#x4E49;&#x7F13;&#x5B58; <a href="#t12018.5 &#x81EA;&#x5B9A;&#x4E49;&#x7F13;&#x5B58;"> # </a></h3>
<ul>
<li>&#x901A;&#x8FC7;&#x914D;&#x7F6E; setCache &#x548C; getCache&#xFF0C;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x6570;&#x636E;&#x7F13;&#x5B58;&#xFF0C;&#x6BD4;&#x5982;&#x53EF;&#x4EE5;&#x5C06;&#x6570;&#x636E;&#x5B58;&#x50A8;&#x5230; localStorage&#x3001;IndexDB &#x7B49;</li>
</ul>
<h4 id="t12118.5.1 App.js">18.5.1 App.js <a href="#t12118.5.1 App.js"> # </a></h4>
<p>src\App.js</p>
<pre><code class="lang-diff">import React, { useState } from &apos;react&apos;;
import { useRequest, clearCache } from &apos;./ahooks&apos;;
let counter = 0;
function getName(keyword = &apos;&apos;) {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      resolve({
        time: new Date().toLocaleTimeString(), data: keyword + (++counter)
      });
    }, 2000);
  });
}
function User() {
  const { data, loading, params, run } = useRequest(getName, {
    cacheKey: &apos;cacheKey&apos;,
    staleTime: 5000,
<span class="hljs-addition">+   setCache: (data) =&gt; localStorage.setItem(&apos;cacheKey&apos;, JSON.stringify(data)),</span>
<span class="hljs-addition">+   getCache: () =&gt; JSON.parse(localStorage.getItem(&apos;cacheKey&apos;) || &apos;{}&apos;),</span>
  });
  const [keyword, setKeyword] = useState(params[0] || &quot;&quot;);
  if (!data &amp;&amp; loading) {
    return &lt;p&gt;&#x52A0;&#x8F7D;&#x4E2D;...&lt;/p&gt;;
  }
  return (
    &lt;&gt;
      &lt;div&gt;
        &lt;input
          value={keyword}
          onChange={(e) =&gt; setKeyword(e.target.value)}
        /&gt;
        &lt;button
          onClick={() =&gt; {
            run(keyword);
          }}
        &gt;
          &#x83B7;&#x53D6;&#x7528;&#x6237;&#x540D;
        &lt;/button&gt;
      &lt;/div&gt;
      &lt;button onClick={() =&gt; clearCache(&apos;cacheKey&apos;)}&gt;
        &#x6E05;&#x9664;&#x7F13;&#x5B58;
      &lt;/button&gt;
      &lt;p&gt;&#x540E;&#x53F0;&#x52A0;&#x8F7D;&#x4E2D;: {loading ? &apos;true&apos; : &apos;false&apos;}&lt;/p&gt;
      &lt;p&gt;&#x6700;&#x8FD1;&#x7684;&#x8BF7;&#x6C42;&#x65F6;&#x95F4;: {data?.time}&lt;/p&gt;
      &lt;p&gt;Keyword: {keyword}&lt;/p&gt;
      &lt;p&gt;{data?.data}&lt;/p&gt;
    &lt;/&gt;
  );
}
function App() {
  const [visible, setVisible] = useState(true);
  return (
    &lt;div&gt;
      &lt;button type=&quot;button&quot; onClick={() =&gt; setVisible(!visible)}&gt;
        {visible ? &apos;&#x9690;&#x85CF;&apos; : &apos;&#x663E;&#x793A;&apos;}
      &lt;/button&gt;
      {visible &amp;&amp; &lt;User /&gt;}
    &lt;/div&gt;
  );
};
export default App;
</code></pre>
<h4 id="t12218.5.2 useCachePlugin.js">18.5.2 useCachePlugin.js <a href="#t12218.5.2 useCachePlugin.js"> # </a></h4>
<p>src\ahooks\useRequest\src\plugins\useCachePlugin.js</p>
<pre><code class="lang-diff">import * as cache from &apos;../utils/cache&apos;;
import useCreation from &apos;../../../useCreation&apos;;
const useCachePlugin = (fetchInstance, {
  cacheKey,
  staleTime = 0,
<span class="hljs-addition">+ cacheTime = 5 * 60 * 1000,</span>
<span class="hljs-addition">+ setCache: customSetCache,</span>
<span class="hljs-addition">+ getCache: customGetCache</span>
}) =&gt; {
  const _setCache = (key, cachedData) =&gt; {
<span class="hljs-addition">+    if (customSetCache) {</span>
<span class="hljs-addition">+      customSetCache(cachedData);</span>
<span class="hljs-addition">+    } else {</span>
       cache.setCache(key, cacheTime, cachedData);
<span class="hljs-addition">+    }</span>
  };

  const _getCache = (key, params) =&gt; {
<span class="hljs-addition">+   if (customGetCache) {</span>
<span class="hljs-addition">+     return customGetCache(params);</span>
<span class="hljs-addition">+   }</span>
    return cache.getCache(key);
  };
  useCreation(() =&gt; {
    if (!cacheKey) {
      return;
    }
    const cacheData = _getCache(cacheKey);
    if (cacheData &amp;&amp; Object.hasOwnProperty.call(cacheData, &apos;data&apos;)) {
      fetchInstance.state.data = cacheData.data;
      fetchInstance.state.params = cacheData.params;
      if (staleTime <span class="hljs-comment">=== -1 || new Date().getTime() - cacheData.time &lt;= staleTime) {</span>
        fetchInstance.state.loading = false;
      }
    }
  })
  if (!cacheKey) {
    return {};
  }

  return {
    onBefore: params =&gt; {
      const cacheData = _getCache(cacheKey, params);
      if (!cacheData || !Object.hasOwnProperty.call(cacheData, &apos;data&apos;)) {
        return {};
      }
      if (staleTime <span class="hljs-comment">=== -1 || new Date().getTime() - cacheData.time &lt;= staleTime) {</span>
        return {
          loading: false,
          data: cacheData?.data,
          returnNow: true
        };
      } else {
        return {
          data: cacheData?.data
        };
      }
    },
    onSuccess: (data, params) =&gt; {
      if (cacheKey) {
        _setCache(cacheKey, {
          data,
          params,
          time: new Date().getTime()
        });
      }
    }
  };
};
export default useCachePlugin;
</code></pre>
<h3 id="t12318.6 &#x6570;&#x636E;&#x5171;&#x4EAB;">18.6 &#x6570;&#x636E;&#x5171;&#x4EAB; <a href="#t12318.6 &#x6570;&#x636E;&#x5171;&#x4EAB;"> # </a></h3>
<ul>
<li>&#x540C;&#x4E00;&#x4E2A; <code>cacheKey</code> &#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x5728;&#x5168;&#x5C40;&#x662F;&#x5171;&#x4EAB;&#x7684;&#xFF0C;&#x8FD9;&#x4F1A;&#x5E26;&#x6765;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x7279;&#x6027;<ul>
<li>&#x8BF7;&#x6C42; <code>Promise</code> &#x5171;&#x4EAB;&#xFF0C;&#x76F8;&#x540C;&#x7684; <code>cacheKey</code> &#x540C;&#x65F6;&#x53EA;&#x4F1A;&#x6709;&#x4E00;&#x4E2A;&#x5728;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;&#xFF0C;&#x540E;&#x53D1;&#x8D77;&#x7684;&#x4F1A;&#x5171;&#x7528;&#x540C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42; Promise</li>
<li>&#x6570;&#x636E;&#x540C;&#x6B65;&#xFF0C;&#x4EFB;&#x4F55;&#x65F6;&#x5019;&#xFF0C;&#x5F53;&#x6211;&#x4EEC;&#x6539;&#x53D8;&#x5176;&#x4E2D;&#x67D0;&#x4E2A; <code>cacheKey</code> &#x7684;&#x5185;&#x5BB9;&#x65F6;&#xFF0C;&#x5176;&#x5B83;&#x76F8;&#x540C; <code>cacheKey</code> &#x7684;&#x5185;&#x5BB9;&#x5747;&#x4F1A;&#x540C;&#x6B65;</li>
</ul>
</li>
</ul>
<h4 id="t12418.6.1 App.js">18.6.1 App.js <a href="#t12418.6.1 App.js"> # </a></h4>
<p>src\App.js</p>
<pre><code class="lang-diff">import React from &apos;react&apos;;
import { useRequest } from &apos;./ahooks&apos;;
let counter = 0;
function getName() {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      resolve({
<span class="hljs-addition">+       time: new Date().toLocaleTimeString(), data: &apos;zhufeng&apos; + (++counter)</span>
      });
    }, 2000);
  });
}
function User() {
<span class="hljs-addition">+ const { data, loading, refresh } = useRequest(getName, {</span>
<span class="hljs-addition">+   cacheKey: &apos;cacheKey&apos;,</span>
<span class="hljs-addition">+ });</span>
<span class="hljs-addition">+ return (</span>
<span class="hljs-addition">+   &lt;&gt;</span>
<span class="hljs-addition">+     &lt;p&gt;&#x540E;&#x53F0;&#x52A0;&#x8F7D;&#x4E2D;: {loading ? &apos;true&apos; : &apos;false&apos;}&lt;/p&gt;</span>
<span class="hljs-addition">+     &lt;button onClick={refresh} type=&quot;button&quot;&gt;</span>
<span class="hljs-addition">+       &#x66F4;&#x65B0;</span>
<span class="hljs-addition">+     &lt;/button&gt;</span>
<span class="hljs-addition">+     &lt;p&gt;&#x6700;&#x8FD1;&#x7684;&#x8BF7;&#x6C42;&#x65F6;&#x95F4;: {data?.time}&lt;/p&gt;</span>
<span class="hljs-addition">+     &lt;p&gt;{data?.data}&lt;/p&gt;</span>
<span class="hljs-addition">+   &lt;/&gt;</span>
<span class="hljs-addition">+ );</span>
}
function App() {
  return (
    &lt;div&gt;
<span class="hljs-addition">+     &lt;User /&gt;</span>
<span class="hljs-addition">+     &lt;hr /&gt;</span>
<span class="hljs-addition">+     &lt;User /&gt;</span>
    &lt;/div&gt;
  );
};
export default App;
</code></pre>
<h4 id="t12518.6.2 useCachePlugin.js">18.6.2 useCachePlugin.js <a href="#t12518.6.2 useCachePlugin.js"> # </a></h4>
<p>src\ahooks\useRequest\src\plugins\useCachePlugin.js</p>
<pre><code class="lang-diff">import { useRef } from &apos;react&apos;;
import * as cache from &apos;../utils/cache&apos;;
import useCreation from &apos;../../../useCreation&apos;;
<span class="hljs-addition">+import * as cachePromise from &apos;../utils/cachePromise&apos;;</span>
<span class="hljs-addition">+import * as cacheSubscribe from &apos;../utils/cacheSubscribe&apos;;</span>
const useCachePlugin = (fetchInstance, {
  cacheKey,
  staleTime = 0,
  cacheTime = 5 * 60 * 1000,
  setCache: customSetCache,
  getCache: customGetCache
}) =&gt; {
<span class="hljs-addition">+ const unSubscribeRef = useRef();</span>
<span class="hljs-addition">+ const currentPromiseRef = useRef();</span>
  const _setCache = (key, cachedData) =&gt; {
    if (customSetCache) {
      customSetCache(cachedData);
    } else {
      cache.setCache(key, cacheTime, cachedData);
    }
<span class="hljs-addition">+   cacheSubscribe.trigger(key, cachedData.data);</span>
  };

  const _getCache = (key, params) =&gt; {
    if (customGetCache) {
      return customGetCache(params);
    }
    return cache.getCache(key);
  };
  useCreation(() =&gt; {
    if (!cacheKey) {
      return;
    }
    const cacheData = _getCache(cacheKey);
    if (cacheData &amp;&amp; Object.hasOwnProperty.call(cacheData, &apos;data&apos;)) {
      fetchInstance.state.data = cacheData.data;
      fetchInstance.state.params = cacheData.params;
      if (staleTime <span class="hljs-comment">=== -1 || new Date().getTime() - cacheData.time &lt;= staleTime) {</span>
        fetchInstance.state.loading = false;
      }
    }
  })
  if (!cacheKey) {
    return {};
  }

  return {
    onBefore: params =&gt; {
      const cacheData = _getCache(cacheKey, params);
      if (!cacheData || !Object.hasOwnProperty.call(cacheData, &apos;data&apos;)) {
        return {};
      }
      if (staleTime <span class="hljs-comment">=== -1 || new Date().getTime() - cacheData.time &lt;= staleTime) {</span>
        return {
          loading: false,
          data: cacheData?.data,
          returnNow: true
        };
      } else {
        return {
          data: cacheData?.data
        };
      }
    },
<span class="hljs-addition">+   onRequest: (service, args) =&gt; {</span>
<span class="hljs-addition">+     let servicePromise = cachePromise.getCachePromise(cacheKey);</span>
<span class="hljs-addition">+     if (servicePromise &amp;&amp; servicePromise !== currentPromiseRef.current) {</span>
<span class="hljs-addition">+       return {</span>
<span class="hljs-addition">+         servicePromise</span>
<span class="hljs-addition">+       };</span>
<span class="hljs-addition">+     }</span>
<span class="hljs-addition">+     servicePromise = service(...args);</span>
<span class="hljs-addition">+     currentPromiseRef.current = servicePromise;</span>
<span class="hljs-addition">+     cachePromise.setCachePromise(cacheKey, servicePromise);</span>
<span class="hljs-addition">+     return {</span>
<span class="hljs-addition">+       servicePromise</span>
<span class="hljs-addition">+     };</span>
<span class="hljs-addition">+   },</span>
    onSuccess: (data, params) =&gt; {
      if (cacheKey) {
        _setCache(cacheKey, {
          data,
          params,
          time: new Date().getTime()
        });
<span class="hljs-addition">+       unSubscribeRef.current = cacheSubscribe.subscribe(cacheKey, d =&gt; {</span>
<span class="hljs-addition">+         fetchInstance.setState({</span>
<span class="hljs-addition">+           data: d</span>
<span class="hljs-addition">+         });</span>
<span class="hljs-addition">+       });</span>
<span class="hljs-addition">+     }</span>
    }
  };
};
export default useCachePlugin;
</code></pre>
<h4 id="t12618.6.3 cachePromise.js">18.6.3 cachePromise.js <a href="#t12618.6.3 cachePromise.js"> # </a></h4>
<p>src\ahooks\useRequest\src\utils\cachePromise.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> cachePromise = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();

<span class="hljs-keyword">const</span> getCachePromise = <span class="hljs-function"><span class="hljs-params">cacheKey</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> cachePromise.get(cacheKey);
};

<span class="hljs-keyword">const</span> setCachePromise = <span class="hljs-function">(<span class="hljs-params">cacheKey, promise</span>) =&gt;</span> {
  cachePromise.set(cacheKey, promise);
  promise.then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
    cachePromise.delete(cacheKey);
    <span class="hljs-keyword">return</span> res;
  }).catch(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    cachePromise.delete(cacheKey);
  });
};

<span class="hljs-keyword">export</span> { getCachePromise, setCachePromise };
</code></pre>
<h4 id="t12718.6.4 cacheSubscribe.js">18.6.4 cacheSubscribe.js <a href="#t12718.6.4 cacheSubscribe.js"> # </a></h4>
<p>src\ahooks\useRequest\src\utils\cacheSubscribe.js</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> listeners = {};

<span class="hljs-keyword">const</span> trigger = <span class="hljs-function">(<span class="hljs-params">key, data</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (listeners[key]) {
    listeners[key].forEach(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item(data));
  }
};

<span class="hljs-keyword">const</span> subscribe = <span class="hljs-function">(<span class="hljs-params">key, listener</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!listeners[key]) {
    listeners[key] = [];
  }

  listeners[key].push(listener);
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unsubscribe</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> index = listeners[key].indexOf(listener);
    listeners[key].splice(index, <span class="hljs-number">1</span>);
  };
};
<span class="hljs-keyword">export</span> { trigger, subscribe };
</code></pre>

    </div>
</div>

<script src="./assets/js/jquerymin_1645176580555.js"></script>
<script src="./assets/js/bootstrapmin_1645176554753.js"></script>

<script src="./assets/js/nav.js"></script>
</body>
</html>
